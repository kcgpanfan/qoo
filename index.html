
<html>
<head>
  <meta charset=utf-8>
  <meta name="viewport" content="initial-scale=1.0, width=device-width">
 
  <link rel="Shortcut Icon" type="image/x-icon" href="https://gis.fdkc.gov.tw/static/img/logo/map.ico">
  <link rel="stylesheet" href="https://gis.fdkc.gov.tw/static/css/ol6.5.0.css" type="text/css">
  <link rel="stylesheet" href="https://gis.fdkc.gov.tw/static/css/mgicon/style.css">
  
  <link rel="stylesheet" href="https://gis.fdkc.gov.tw/static/css/ol-ext.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luna-window/luna-window.css">
  <title>GIS119</title>

  <style>
#caseListTable {
    transform: rotate(180deg);
    -ms-transform: rotate(180deg); /* IE 9 */
    -webkit-transform: rotate(180deg); /* Safari and Chrome */
    direction: rtl;
}

#caseListTable td, #caseListTable th {
    transform: rotate(-180deg);
    -ms-transform: rotate(-180deg); /* IE 9 */
    -webkit-transform: rotate(-180deg); /* Safari and Chrome */
    direction: ltr;
}

.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  margin: 10% auto;
  padding: 10px;
  width: 750px;
  height: 800px;
  background-color: #FFFFFF;
  border-radius: 8px;
  box-shadow: 1px 2px 2px #000;
}

.modal {
  background-color: rgba(0, 0, 0, 0.5); /* 模態框背景顏色 */
}

.modal-content {
  background-color: rgba(255, 255, 255, 0.1); /* 模態框內容背景顏色 */
}

.close {
  position: absolute;
  top: 10px;
  right: 20px;
  font-size: 24px;
  font-weight: bold;
  color: #888;
  cursor: pointer;
}

iframe {
  width: 100%;
  height: 100%;
  border: none;
}

  .window {
      position: absolute;
      top: 70px;
      left: 200px;
      width: 500px;
      height: 300px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 3px 3px 0px #545454;
      padding: 10px;
    }

    .window h2 {
      margin: 0;
    }

    .window button {
      margin-top: 10px;
    }

    .i{outline:none;}

    /* 滾動條 */
    ::-webkit-scrollbar {width: 5px;height: 5px;}
    ::-webkit-scrollbar-button {background: transparent;border-radius: 4px;}
    ::-webkit-scrollbar-track-piece {background: transparent;}
    ::-webkit-scrollbar-thumb {border-radius: 4px;background-color: rgba(0, 0, 0, 0.4);border: 1px solid slategrey;}
    ::-webkit-scrollbar-track {box-shadow: transparent;}
    /* sidebar 滾動條 */
    .sidebar *::-webkit-scrollbar {display: none;}
    /* 自訂圖資 */
    .gis-edit-item-list .body::-webkit-scrollbar {display: none;}

    html,body{padding: 0;margin: 0;width: 100vw;height: 100vh;overflow: hidden;position: absolute;top:0px;left:0px;font-family: '微軟正黑體';}
    #map{width: 100%;height: 100%;}
    .sidebar *{position: relative; user-select: none;}
    .sidebar {position: absolute;width: 275px;left: 10px;top: 50px;background-color: #131313ab;box-shadow: 0px 2px 4px #000;transition: .2s;}
    .sidebar input:checked ~ .content {height: 500px;padding-top: 10px;}
    .sidebar input:checked ~ #overlaycontent {height:fit-content;max-height:calc( 99vh - 299px );padding-top: 10px;}
    .sidebar input:checked ~ #weathercontent {height:fit-content;max-height:calc( 99vh - 299px );padding-top: 10px;}
    .sidebar input:checked ~ #emiccontent {height:fit-content;max-height:calc( 99vh - 299px );padding-top: 10px;}
    .sidebar input:checked ~ #floodcontent {height:fit-content;max-height:calc( 99vh - 299px );padding-top: 10px;}
    .sidebar input:checked ~ #toolscontent {height:fit-content;max-height:calc( 99vh - 299px );padding-top: 10px;}
    .sidebar input:checked ~ #mapcontent {height:fit-content;max-height:calc( 99vh - 299px );padding-top: 10px;}
    .sidebar input:checked ~ .fa-chevron-down {transform: rotate(180deg);}
    .sidebar .collapse input {position: absolute;opacity: 0;top: 0;left: 0;}
    .sidebar label{cursor: pointer;display: block;color: white;text-shadow: 0px 2px 3px #000;font-size: 25px;}
    .sidebar .fa-chevron-down {position: absolute;right: 20px;top: 17px;font-size: 16px;transition: .2s linear;}
    .sidebar .content {transition: .2s ease-in;width: 100%;height: 0px;overflow: hidden;padding: 0px 10px;box-sizing: border-box;display: flex;flex-wrap: wrap;align-content: flex-start;}
    .sidebar .collapse {position: relative;width: 100%;border-bottom: 1px solid #222;margin-top:2px;}
    .sidebar .content img{width: 50px;height: 50px;}
    .sidebar .title{ background-color: #222;padding: 5px 10px;font-size: 22px;font-family: '微軟正黑體';font-weight: bold;display: flex; justify-content: space-between;align-items: center;}
    .sidebar .item {border:2px solid rgb(217, 217, 217);border-radius: 5px;/*padding: 3px;*/margin: 3px;transition: .3s;cursor: pointer;}
    .sidebar .content .item:hover{background-color: rgb(226, 226, 226);box-shadow: 0px 2px 3px #000;/*top: -2px;*/color: black;text-shadow: none;font-weight: bold;}
    .sidebar .collapse>label:hover{background-color: #111; color: #ffa600;}
    /*  */
    .iconContent{display: flex;align-items: center;justify-content: space-between;}
    .iconContent .name{display: none;visibility:hidden}

    @media screen and (max-width: 1200px) {
      .sidebar {width: 200px;}
      .sidebar input:checked ~ #mapcontent{overflow-y: scroll;}
    }


    /* switch button */
    .switch {position: relative;display: inline-block;width: 55px;height: 28px;}
    .switch input { opacity: 0;width: 0;height: 0;}
    .slider {position: absolute;cursor: pointer;top: 0;left: 0;right: 0;bottom: 0;background-color: #ccc;-webkit-transition: .4s;transition: .4s;}
    .slider:before {position: absolute;content: "";height: 20px;width: 20px;left: 4px;bottom: 4px;background-color: white;-webkit-transition: .4s;transition: .4s;}
    input:checked + .slider {background-color: #008cff;}
    input:focus + .slider {box-shadow: 0 0 1px #2196F3;}
    input:checked + .slider:before {-webkit-transform: translateX(26px);-ms-transform: translateX(26px);transform: translateX(26px);}
    /* Rounded sliders */
    .slider.round {border-radius: 34px;}
    .slider.round:before {border-radius: 50%;}


    /* tooltips */
    .item .tooltiptext {visibility: hidden;width: 120px;background-color: black;color: #fff;text-align: center;border-radius: 6px;padding: 5px 0;position: absolute;z-index: 1;top: 15px;left: 115%;}
    .item .tooltiptext::after {content: "";position: absolute;top: 50%;right: 100%;margin-top: -5px;border-width: 5px;border-style: solid;border-color: transparent black transparent transparent;}
    /* .item:hover .tooltiptext {visibility: visible;} */
    .item input:checked + .iconContent{transition-delay: 250ms}

    /* title side */
    .collapse>.collapsetooltiptext {visibility: hidden;width: 160px;background-color: black;color: #fff;text-align: center;border-radius: 6px;padding: 5px 0;position: absolute;z-index: 1;top: 0px;left: 102%;font-size: 25px;}
    .collapse>.collapsetooltiptext::after {content: "";position: absolute;top: 50%;right: 100%;margin-top: -5px;border-width: 5px;border-style: solid;border-color: transparent black transparent transparent;}
    /* .collapse:hover>.collapsetooltiptext {visibility: visible;} */
    .collapse:hover>.collapsetooltiptext {visibility:hidden}
    .collapse input:checked + .iconContent{border-radius: 5px;text-shadow: none;background-color:rgba(255,166,0,0.25);}
    .collapse input:checked + .iconContent img {filter: contrast(100);mix-blend-mode: darken;}
    .collapse input:checked + .iconContent .name{text-shadow: none;font-weight: bolder;}
    .collapse i{font-size: 28px;}

    /* 地圖工具 */
    #toolscontent{width: 100%;}
    #toolscontent .toolItem{display: inline-block;}
    #toolscontent input{position: relative;display: none;}
    #toolscontent label{padding: 3px;font-size: 25px;cursor: pointer;margin-right: 5px;font-family: '微軟正黑體';width: 100%;}
    #toolscontent label:hover{background-color: rgb(48, 48, 48); color: white;font-weight:bolder;}
    #toolscontent label {display: flex;align-items: center;justify-content: center;}
    #toolscontent label i{display: none}
    #toolscontent .title{background-color: rgba(0, 0, 0, 0);font-size: 22px;}
    @media screen and (max-width: 1200px)  {
      .sidebar input:checked ~ #overlaycontent {height: 300px;}
      .sidebar input:checked ~ #weathercontent {height: 300px;}
      .sidebar input:checked ~ #emiccontent {height: 300px;}
      .sidebar input:checked ~ #toolscontent {height: 210px;}
      .sidebar input:checked ~ #floodcontent {height: 230px;}
      #toolscontent button{font-size: 20px;}
      #toolscontent label {display: flex;align-items: center;justify-content: flex-start;}
      #toolscontent .toolItem{width: 100%;}
      #toolscontent label i{display: block}
    }

    /* 底圖 */
    #mapcontent .title{justify-content: center;}

    /* quick btn START */

    .quickLayer-grid{width: 40px;height: 40px;background-color: rgb(88 88 88 / 78%);border-radius: 10px;border: 2px solid rgb(219, 219, 219);color: white;font-size: 32px;font-family: sans-serif;display: flex;justify-content: center;align-items: center;cursor: pointer;box-shadow: 0px 2px 2px #000;margin-left: 5px;}
    /* quick btn END */

    #movepopup{position:absolute;/*background-color:white;*/text-align:center;width:90px;left:50%;bottom:150%;margin-bottom:10px;/*padding:3px;*/margin-left:-45px;/*border-radius:4px;border-width:1px;border-style:solid;*/z-index:10;font-size: 20px;font-family: '微軟正黑體';}
    .ol-popup {position: absolute;background-color: white;box-shadow: 0 1px 4px rgba(0,0,0,0.2);padding: 15px;border-radius: 10px;border: 1px solid #cccccc;bottom: 12px;left: -50px;min-width: 200px;}
    .ol-popup:after, .ol-popup:before {top: 100%;border: solid transparent;content: " ";height: 0;width: 0;position: absolute;pointer-events: none;}
    .ol-popup:after {border-top-color: white;border-width: 10px;left: 48px;margin-left: -10px;}
    .ol-popup:before {border-top-color: #cccccc;border-width: 11px;left: 48px;margin-left: -11px;}
    .ol-popup-closer {text-decoration: none;position: absolute;top: 2px;right: 8px;}
    .ol-popup-closer:after {content: "✖";}
    #popup-content{max-height: 300px; max-width: 350px; overflow-y: scroll;text-align: center;-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text;}

    /* 右鍵選單 */
    .context-menu {position: absolute;text-align: center;background: rgb(255, 255, 255);border-radius: 5px;box-shadow: 0px 0px 3px #000;}
    .context-menu ul {padding: 0px;margin: 0px;min-width: 150px;list-style: none;}
    .context-menu ul li {cursor: pointer;text-align: left;padding: 5px;}
    .context-menu ul li a {text-decoration: none;color: black;font-weight: bolder;font-size: 20px;}
    .context-menu ul li:hover {background: rgb(0 149 255);}
    .context-menu ul li:hover > a{color: white;}


    /* 工具列 */
    .toolsBoxMove{position: absolute;left: 50%;bottom: 15px;transform: translate(-50%, 10px);width: 80vw;display: flex;justify-content: center;}
    .toolsBox{display: inline-block;}
    /* .toolsBox .mds-tool{font-size: 40px;background-color: #111;color: white;cursor: pointer;} */
    .mds-icon{font-size: 32px;background-color: #111;color: white;cursor: pointer;padding: 5px;border-radius: 5px;border:1px solid #111;}
    .bottomToolItem .mds-icon{padding: 3px;}
    .mds-icon.active{color: #ffa600;border:1px solid #fff;}
    .mds-icon:hover{background-color: #ffa600;color: #000;font-weight: bold;}
    .mds-trash{background: #ff4040;/*padding: 3px 5px;box-sizing: border-box;*/border-radius: 5px;cursor: pointer;}
    .mds-trash:hover{background-color: #fff;color: #000;font-weight: bold;}
    /* 座標 */
    .coord{border: 1px solid #000;width: 380px;height: 70px;background-color: #131313ab;color: white;font-size: 22px;padding: 5px;box-sizing: border-box;font-family: '微軟正黑體';border-radius: 5px;box-shadow: 0px 1px 1px #000;transition: .3s;position: relative;display: none;}
    .coord .selectRow{width: 100%;display: flex;}
    .coord select{width: 40%;font-size: 20px;margin-right: 2px; margin-left: 2px;}
    .coord button{width: 20%;font-size: 20px;padding: 0;margin: 0;font-weight: bold;background: #eaeaea;color: #0d0d0d;box-shadow: 0px 1px 1px #000;border: none;margin-left: 2px;cursor: pointer;}
    .coord .diffType{width: 35%;}
    .coord .diffCoord{width: 45%;}
    .coord button:hover{background-color: rgb(241, 115, 115);color: white;}
    .coord .cals{font-size: 25px;text-align: center;}
    .coord .ol-mouse-position{position: relative;top: 0; right: 0;}
    /* .coord .closeBtn{display: inline-block;position: absolute;top: -15px;right: -15px;background: red;border-radius: 39px;padding: 2px 5px;} */

    /* 載入中 */
    .loadingBlock{width: 100vw;height: 100vh;position: absolute;top: 0;background: #0000004f;z-index: 1000000;display: none;align-content: center;justify-content: center;align-items: center;font-size: 50px;color: white;font-weight: bold;}

    /* 繪圖工具 */
    .drawBox{border: 1px solid #000000c7;background: #000000de;width: 280px;height: 70px;display: flex;flex-direction: column;align-items: center;/*padding: 5px;*/box-sizing: border-box;box-shadow: 0px 0px 5px #000;border-radius: 5px; transition: .2s; position: relative;color: white;display: none;}
    .drawBox .title{color: white; font-size: 22px;}
    .drawBox .colorRadio{width: 20px; height: 20px; cursor: pointer;appearance: none;-webkit-appearance: none;border-radius: 50%;border: 7px solid rgb(59, 59, 59); transition: .3s;}
    .drawBox input[type=radio]:checked {border: none;}
    /* .drawBox .closeBtn{display: inline-block;position: absolute;top: -15px;right: -15px;background: red;border-radius: 39px;padding: 2px 5px;color: white;font-size: 25px;} */

    /* 測量工具 */
    .measure{border: 1px solid #000000c7;background: #000000de;width: 130px;height: 70px;display: flex;flex-direction: column;align-items: center;/*padding: 5px;*/box-sizing: border-box;box-shadow: 0px 0px 5px #000;border-radius: 5px; transition: .2s; color:white;display: none;}
    .measure .title{font-size: 22px;}
    .measure label{font-size: 22px;}
    .measure input{display: none;}

    /* 截圖工具 */
    .takePicBox{border: 1px solid #000000c7;background: #000000de;width: 330px;height: 70px;display: flex;flex-direction: column;align-items: center;/*padding: 8px;*/box-sizing: border-box;box-shadow: 0px 0px 5px #000;border-radius: 5px; transition: .2s; display: none;}
    .takePicBox .typeBox{display: flex;justify-content: space-evenly;width: 100%;}
    .takePicBox .title{color: white; font-size: 22px;}
    .takePicBox button {font-size: 18px;cursor: pointer;border-radius: 3px;border: none;}
    .takePicBox button:hover{background-color: rgb(152, 152, 152);color: white;}

    /* 底圖切換 */
    .switchMap{border: 1px solid #000000c7;background: #000000de;width: 295px;height: 70px;display: flex;padding: 8px;box-sizing: border-box;box-shadow: 0px 0px 5px #000;border-radius: 5px; transition: .2s; display: none;}
    .switchMap .mapdiv{width: 40px;}
    .switchMap label{margin-left: 5px;}
    .switchMap .imgbox{width: 100%;height:50px}
    .switchMap img{width: 100%;height: 100%;}

    /* 淹水資訊 */
    /* #floodcontent.content{align-content: space-around;} */
    #floodcontent { display: flex;justify-content: center; }
    #floodcontent select,#floodcontent span{font-size: 28px;}
    #floodcontent .selectedBox{display: flex;}
    #floodcontent span{color: white;}

    /* 淹水資訊 input switch style */
    #floodcontent .title {width: 100%;background: none;color: white;padding: 0;}
    #floodcontent.content input[type=checkbox]{height: 0;width: 0;visibility: hidden;}
    #floodcontent.content label {cursor: pointer;width: 70px;height: 35px;background: grey;display: block;border-radius: 100px;position: relative;}
    #floodcontent.content .switch-txt{display: block; width: 100%;height: 100%;}
    #floodcontent.content label:after {content: '';position: absolute;top: 5px;left: 5px;width: 25px;height: 25px;background: #fff;border-radius: 90px;/*transition: 0.3s;*/max-width: 30px;}
    #floodcontent.content .switch-txt::before,.switch-txt::after {display: block;color: #fff;font-weight: bold;box-sizing: border-box;}
    #floodcontent .titleContent{justify-content: space-between}
    /* 切換顏色 */
    #floodcontent.content input:checked + label {background: #1700e5;}
    #floodcontent.content label:active:after {width: 130px;}
    #floodcontent.content input:checked + label:after {left: calc(100% - 5px);transform: translateX(-100%);}
    @media screen and (max-width: 1200px)  {
      #floodcontent{padding: 0 5px;}
      #floodcontent select, #floodcontent span{font-size: 25px;}
      #floodcontent .selectedBox{flex-direction: column;}
      #floodcontent select{width: 65%;}
      #floodcontent.content label{width: 55px;height: 30px;}
      #floodcontent.content label:after{width: 20px;height: 20px;}
    }

    /* 比例尺scale bar */
    .ol-scale-line-inner{font-size:18px;font-family:'微軟正黑體';min-width: 100px;left:80px;}
    .ol-scale-line.ol-unselectable{background-color: rgba(0, 0, 0, 0.63);left:calc( 3em + 28px );}

    /* 放大縮小 */
    .ol-zoom{left: 5px;top:auto;right: auto;bottom:8px;}
    .ol-zoom button{background-color: rgba(0, 0, 0, 0.7);cursor: pointer;transition: 0.2s;display:inline;}
    .ol-zoom button:hover{background-color: rgba(219, 17, 17, 0.7);}
    .ol-zoom button:focus{background-color: rgba(0, 0, 0, 0.7);}

    /* 案件列表 */
    /* .caselist{position: absolute;top: 50px;right: 10px;border: 1px solid black;width: 200px;height: 500px;background-color: rgb(88, 88, 88);} */

    /* cctv box */
    .cctvBox{height: 100vh; width: 350px;position: absolute; left: -400px;top: 0;background-color: #000000f2;transition: .3s;padding: 10px 5px;box-sizing: border-box;font-family: '微軟正黑體';z-index:100;}
    .cctvBox .close{font-size: 30px;color: white;position: absolute;right: -20px;background: #c10202;padding: 5px;border-radius: 100%;width: 30px;height: 30px;top: 10px;display: flex;justify-content: center;align-items: center;cursor: pointer;}
    .cctvBox .close:hover{background-color: #f90f0f;}
    .cctvBox .title{color: white; font-size: 25px; padding: 0px 10px;}
    .cctvBox a {color: rgb(255, 64, 64);}

    /* popupTable */
    .popupTable table{border:1px solid #333;font-size:20px;font-family:'微軟正黑體';user-select:text; border-radius: 5px;background: white;display: inline-block;
    box-shadow: 1px 1px 2px #00000096;display: inline-block;}
    .popupTable td {border:0px solid #333;font-size:18px;font-family:'微軟正黑體';user-select:text;/*vertical-align:middle;text-align: center;*/}
    .popupTable thead{background-color:#2F5597;color:#fff; width: calc(100%-1em);}
    .popupTable tfoot{background-color:#2F5597;color:#fff;}
    .popupTable tr{table-layout: fixed;}

    /* popup可調整 */
    .popupTable .td1{font-weight: bold;}
    .popupTable .td2{background-color: #E7E6E6;}
    .popupTable .td3{height: 80px;overflow-y: scroll;}/* 大框 */
    .popupTable .td4{font-size: 17px;}
    .popupTable .td5{display: block;}
    .popupTable .tw1{width: 100px;}
    .popupTable .tw2{width: 300px;}
    .popupTable .tw3{width: 250px;}
    .popupTable .tw4{width: 500px;}
    .popupTable .tw5{width: 50px;}
    .popupTable .tw6{width:200px;font-size: 15px;}

    /* 暫時 */
    /* .ol-zoom.ol-unselectable.ol-control{display: none;} */
    .ol-print.ol-unselectable.ol-control{display: none;}
    .ol-mouse-position{display: none;}

    /* 案件列表 */
    .mask{width:100vw;height:100vh;position: absolute;top: 0;left: 0;background-color: rgb(0 0 0 / 36%);display: none;cursor: pointer;}
    .caseListBox{position: absolute;right: 50px;top: 50px; transition: .2s;opacity: 0;}
    .caseListBox label input{display: none;}
    .caseListBox button{position: absolute;right: 25px;border: none;background: #ffffff;box-shadow: none;font-size: 1vw;display: flex;align-items: center;cursor: pointer;font-weight: bolder;box-shadow: 2px 2px 2px #cbcbcb;border-radius: 3px;user-select: none;}
    .caseListBox button:hover{background-color: black; color: white;}
    .caseListBox button i {font-size: 16px;transition: .2s;}
    .caseTypeList{position: absolute;display: none;flex-direction: column;background: white;top: 35px;right: 25px;border-radius: 5px;box-shadow: 1px 1px 1px black;border: 2px solid black;color: black;z-index: 10;}
    .caseTypeList .type{border-bottom: 1px solid;font-size: 22px;padding: 0px 5px; user-select: none;display: flex;align-items: center}
    .caseTypeList .type img{height: 25px;}
    .caseTypeList .type:hover{background-color: black; color: white;cursor: pointer;}

    #caselist {z-index: 14;background-color: rgba(0, 0, 0, 0.721);padding: 5px;font-size: 1.05vw;user-select: text;/*border: 2px solid #ffffff;*/border-radius: 5px;box-shadow: 0px 3px 10px #3e3e3e;word-wrap: break-word;padding-right: 10px;transition: margin-right 0.5s; color: white;height: 80vh;width: 100%;box-sizing: border-box;}
    #caseListTable{z-index: 10;width: 100%;}
    #caseListTable td{border-bottom: 1px solid rgb(255, 255, 255)}
    #caseListTable td:hover{background-color: #fff;color: black;cursor: pointer;}
    #caseListTable .caseSelected{background-color: red;}
    .tableBox {overflow-y: auto;width: 18vw;height: 100%;}
    
    /* 案件列表中的篩選圖示 */
    #caseFilterBox{position: absolute;top: -50px;right: 5px;display: flex;}

    /* 左上工具欄小按鈕 */
    .sideBarToolsBtn{font-size:28px;z-index:20;height:28px;color:#000000;text-shadow:1px 2px #494949;display: flex;position:absolute;top: 5px;left:10px;}
    .sideBarToolsBtn label{cursor:pointer;display: inline-block;display: flex;align-items: center;user-select: none;}
    .sideBarToolsBtn input{display: none;}
    @media screen and (max-width: 1200px) {.sideBarToolsBtn{left: 5px}}

    /* 右側工具欄 */
    .rightToolsBox{position: absolute;right: 0px;top: 0px;font-size: 30px;display: flex;flex-direction: column;height: 100vh;
    background: #24242499;padding: 5px;justify-content: space-between;box-sizing: border-box;z-index: 10;-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text;}
    .rightToolsBox .tools{display: flex;flex-direction: column;}
    .rightToolsBox .redirect{display: flex;flex-direction: column;}
    .rightToolsBox .tools label{margin-bottom: 8px;}
    .rightToolsBox .redirect label{margin-top: 8px;}
    .rightToolsBox input{display: none;}

    /* 地址查詢  */
    .addrDiv{position: absolute;top:5px;right: 50px;background-color: #000000b3;padding: 6px;border-radius: 6px;font-size: 1.5vw;opacity: 0;transition: .2s;z-index: 1;right: -500px;}
    #addrinput{font-size: 20px;width: 25vw;outline: none;border: none;border-radius: 3px 0 0 3px;border: 3px solid #ffffff;}
    #addrsearch{font-size: 20px;cursor: pointer;}
    #addrsearch:hover{background-color: #426bc1;border: 1px solid 3761bd;}
    #addrlonlat{font-size: 25px;color: white;}
    #addrlist tbody tr td{color: white;}
    #addrlist tbody tr :hover{color: #ffff00; cursor: pointer;}
    #cityinput{margin-right: 5px;}

    /* 快速查詢(zoomin) */
    .quickroadbox{background-color: rgba(34, 34, 34, 0.806);position: absolute;right: -500px;top: 10px;padding:6px;border-radius: 5px;transition: .2s;z-index: 1}
    .mie_qr_label{font-size:22px;color: white;}
    .mie_qr_select{cursor: pointer;font-size:22px;border-radius:3px;}
    .button_qr{background-color: #2f4f93;border-radius: 2px;font-weight: bold;cursor: pointer;font-size: 20px;padding: 0px 5px;color: white;border: 1px solid #2f4f93;}
    .button_qr:hover{background-color: #426bc1;}
    /* .button_qr:active {transform: scale(0.8);} */

    /* 顯示zoom數字 */
    #zleveldiv{position: absolute;top: 3px;left: 103px;font-size: 25px;color: #000000;padding: 3px;border-radius: 6px;font-weight: bold;text-shadow: 0px 2px 3px #636363;}

    /* 自訂圖資 */
    .sliderBox{transition: .3s;}
    .sliderBox .selectRow{margin-bottom: 5px;}
    .sliderBox .selectRow select{font-size: 20px;}
    .sliderBox .selectRow label{display: inline-block;width:150px;color: white;font-size: 20px;}
    .sliderBox .selectRow input{width:150px;font-size: 20px;outline:none;}
    .sliderBox .selectRow textarea{width:150px;font-size: 20px;outline:none;}
    .gis-edit-item-list{transition: .3s;}
    .gis-edit-item-list table{width: 100%;}
    .gis-edit-item-list table, th, td {border-bottom: 1px solid rgb(218, 218, 218);border-collapse: collapse;}
    .gis-edit-item-list tr td{padding: 5px;}
    .gis-edit-item-list tbody td:nth-child(2) {text-align: center;vertical-align: middle }
    .gis-edit-item-list tr:nth-of-type(odd) { background: #1a1a1a67; }
    .gis-edit-item-list th { background: #f6f6f6; color: rgb(36, 36, 36); font-weight: bold; }
    .gis-edit-item-list tbody tr:hover{color: rgb(16, 16, 16);background-color: #ffffff;font-weight: bolder;text-shadow: 1px 1px 0px rgb(255, 255, 255), 1px 2px 2px rgb(0, 0, 0);}
    .gis-edit-item-list button, .gis-edit-item-item button{font-family: '微軟正黑體';display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1.2rem;line-height: 1.5;border-radius: 0.25rem;transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;color: white;cursor: pointer;}
    .gis-edit-item-list .edit{background-color: #035097;}
    .gis-edit-item-list .remove{background-color: #f73d3d;}
    .gis-edit-item-list .search{background-color: #868686;}
    .gis-edit-item-list .page{background-color: #2b68a1;}
    /* 自訂圖資-編輯頁面 */
    .gis-edit-item-detail{transition: .3s;}
    /* .gis-edit-item-detail select{font-size: 20px;} */
    .gis-edit-item-detail table{width: 100%;}
    .gis-edit-item-detail table, th, td {border-bottom: 1px solid rgb(218, 218, 218);border-collapse: collapse;}
    .gis-edit-item-detail tr td{padding: 5px;}
    .gis-edit-item-detail tbody td:nth-child(2) {text-align: center;vertical-align: middle }
    .gis-edit-item-detail tr:nth-of-type(odd) { background: #1a1a1a67; }
    .gis-edit-item-detail th { background: #f6f6f6; color: rgb(36, 36, 36); font-weight: bold; }
    .gis-edit-item-detail tbody tr:hover{color: rgb(16, 16, 16);background-color: #ffffff;font-weight: bolder;text-shadow: 1px 1px 0px rgb(255, 255, 255), 1px 2px 2px rgb(0, 0, 0);}
    .gis-edit-item-detail button, .gis-edit-item-item button{font-family: '微軟正黑體';display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1.2rem;line-height: 1.5;border-radius: 0.25rem;transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;color: white;cursor: pointer;}
    .gis-edit-layout .edit{background-color: #035097;}
    .gis-edit-layout .remove{background-color: #f73d3d;}
    .gis-edit-layout .search{background-color: #868686;}
    .gis-edit-layout .page{background-color: #2b68a1;}
    .gis-edit-layout .create{background-color: green;}

    /* 刪除確認 */
    .deleteCheck{position: absolute;top: 30%;left: 50%;transform: translate(-50%,0px);background: white;width: 300px;padding: 10px;border-radius: 5px;box-shadow: 0px 3px 5px black;font-weight: bolder;user-select: none;display:none;}
    .deleteCheck .title{font-size: 25px;text-align: center;}
    .deleteCheck .btnRow{display: flex;justify-content: space-around;padding: 10px;display: flex;justify-content: space-around;}
    .deleteCheck button{font-family: '微軟正黑體';display: inline-block;font-weight: 400;text-align: center;white-space: nowrap;vertical-align: middle;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;border: 1px solid transparent;font-size: 1.2rem;line-height: 1.5;border-radius: 0.25rem;transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;color: white;cursor: pointer;}
    .deleteCheck .remove{background-color: #858585;}
    .deleteCheck .check{background-color: green}

    /* 右下顯示圖層顯示層 */
    .layer-show-level{position: absolute;font-size: 15px;top: -18px;font-weight: bolder;text-shadow: 0px 1px 3px black, 0px 2px 3px black, 0px 3px 1px black, 0px 4px 2px black;}
    @media screen and (max-width: 1200px) {#overlayer-layer-range{font-size: 16px;}}
  </style>
</head>
<body>
<script type=text/javascript src="https://gis.fdkc.gov.tw/static/js/dashboardconfig.js"></script>  
<script type=text/javascript src="https://gis.fdkc.gov.tw/static/js/jquery-3.6.0.min.js"></script>  
<script type=text/javascript src="https://gis.fdkc.gov.tw/static/js/html2canvas1.3.2.min.js"></script>
<script type=text/javascript src="https://gis.fdkc.gov.tw/static/js/ol6.5.0.js"></script>
<script type=text/javascript src="https://gis.fdkc.gov.tw/static/js/ol-ext.js"></script>
<script type=text/javascript src="https://gis.fdkc.gov.tw/static/js/proj4.js"></script>
<script type=text/javascript src="https://gis.fdkc.gov.tw/static/js/jspdf.min.js"></script>
<script type=text/javascript src="https://gis.fdkc.gov.tw/static/js/FileSaver.min.js"></script>
<script type=text/javascript src="https://gis.fdkc.gov.tw/static/js/print.js"></script>

<!-- dom START -->
<div id="map">
<div id="myModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <iframe id="modalFrame" src="" sandbox="allow-same-origin"></iframe>
  </div>
</div>
  <div class="maskbgc" style="width:100vw;height:100vh;position: absolute;top:0px;left:0px;background-color: rgb(153, 204, 255);"></div>
  <div id="movepopup"></div>
  <div id="popup" class="ol-popup">
    <a  id="popup-closer" class="ol-popup-closer"></a>
    <div id="popup-content"></div>
  </div>
</div>
<div id="printElement"></div>

<div class="sideBarToolsBtn">
  <div class="sideBarToolsList" style="display: inline-block; font-size: 10px;">
    <div style="display: inline-block;">
      <label>
        <input type="checkbox" id="sideBarChk" onclick="sideBarCollapseSwitch(this.checked, this)">
        <i class="mds-icon mds-left-solid-arrow" name="側欄開關"></i>
      </label>
    </div>
    <div id="sideBarListSwitch" style="display: inline-block;">
      <label>
        <input type="checkbox" onclick="sideBarSwitch2List(this.checked)">
        <i class="mds-icon mds-list" name="列表切換"></i>
      </label>
    </div>
  </div>
</div>
<div class="sidebar">
  <section class="collapse">
    <label for="overlay" class="title">圖層套疊<span id="overlayer-layer-range"></span><i class="mds-layer"></i></label>
    <input type="checkbox" id="overlay" onchange="toggleCollapse(this, this.checked)">
    <div id="overlaycontent" class="content"></div>
    <span class="collapsetooltiptext"></span>
  </section>
  <section class="collapse">
    <label for="weatheroverlay" class="title">環境資訊<i class='mds-wind'></i></label>
    <input type="checkbox" id="weatheroverlay" onchange="toggleCollapse(this, this.checked)">
    <div id="weathercontent" class="content"></div>
    <span class="collapsetooltiptext"></span>
  </section>
  <section class="collapse">
    <label for="emicoverlay" class="title">EMIC<i class="mds-cube"></i></label>
    <input type="checkbox" id="emicoverlay" onchange="toggleCollapse(this, this.checked)">
    <div id="emiccontent" class="content"></div>
    <span class="collapsetooltiptext"></span>
  </section>
  <section class="collapse">
    <label for="floodPotential" class="title">淹水潛勢<i class="fas fa-tint"></i></label>
    <input type="checkbox" id="floodPotential" onchange="toggleCollapse(this, this.checked)">
    <div id="toolscontent" class="content"></div>
  </section> 
  <section class="collapse" id="qpefloodcollapse">
    <label for="qpeFlood" class="title">淹水資訊<i class="mds-wave"></i></label>
    <input type="checkbox" id="qpeFlood" onchange="toggleCollapse(this, this.checked)">
    <div id="floodcontent" class="content">
      <div class="floodItem">
        <div class="title">
          <div class="titleContent" style="width: 100%;display: flex;align-items: center;">淹水潛勢
            <input type="checkbox" id="switch-flood" onchange="getfloodpotential(this.checked)" />
            <label for="switch-flood">
              <span class="switch-txt" turnOn="On" turnOff="Off"></span>
            </label>
          </div>
          <!-- <i class="mds-switch"></i> -->
        </div>
        <div class="selectedBox">
          <div class="hourBox">
            <select name="" id="floodpothr" onchange="checkfloodpotOption()">
              <option value="6">6</option>
              <option value="12">12</option>
              <option value="24">24</option>
            </select>
            <span>小時</span>
          </div>
          <div class="mmBox">
            <select name="" id="floodpotmm" onchange="getfloodpotential(document.getElementById('switch-flood').checked)">
              <option value="150">150</option>
              <option value="150">250</option>
              <option value="150">350</option>
            </select>
            <span>毫米</span>
          </div>
        </div>
      </div>
      <div class="floodItem" style="margin-top: 5px">
        <div class="title">
          <div class="titleContent" style="width: 100%;display: flex;align-items: center;">定量降雨
            <input type="checkbox" id="switch-qpe" onchange="getqpeflood(this.checked)" />
            <label for="switch-qpe">
              <span class="switch-txt" turnOn="On" turnOff="Off"></span>
            </label>
          </div>
          <!-- <i class="mds-switch"></i> -->
        </div>
        <div class="selectedBox">
          <div class="hourBox">
            <select name="" id="qpefloodhr" onchange="checkQpeOption();">
              <option value="6">6</option>
              <option value="12">12</option>
              <option value="24">24</option>
            </select>
            <span>小時</span>
          </div>
          <div class="mmBox">
            <select name="" id="qpefloodmm" onchange="getqpeflood(document.getElementById('switch-qpe').checked);">
              <option value="10">10</option>
              <option value="150">150</option>
              <option value="250">250</option>
              <option value="350">350</option>
            </select>
            <span>毫米</span>
          </div>
        </div>
      </div>
    </div>
  </section>
  <section class="collapse" id="mapoverlaycollapse">
    <label for="mapoverlay" class="title">底圖切換<i class="mds-map"></i></label>
    <input type="checkbox" id="mapoverlay" onchange="toggleCollapse(this, this.checked)">
    <div id="mapcontent" class="content"></div>
    <span class="collapsetooltiptext"></span>
  </section>
</div>

<div id="quickLayerTitle"></div>
<div class="quickLayer" style="position: absolute;bottom: 5px;right: 55px; display:flex;z-index: 20;"></div>

<!-- 右鍵選單 -->
<div id="contextMenu" class="context-menu" style="display:none">
  <ul>
    <li onclick="reLocateCasePos(2)"><a>這是哪裡？</a></li>
    <li onclick="setZoomLevel('in')"><a>放大</a></li>
    <li onclick="setZoomLevel('out')"><a>縮小</a></li>
    <li onclick="switchCoord()"><a>座標對照</a></li>
    <li onclick="clearCasePos()" id="clearlocation"><a>清除點位</a></li>
    <li onclick="reLocateCasePos(1)" id="relocation"><a>案發點重新定位</a></li>
  </ul>
</div>

<div class="toolsBoxMove">
  <div class="toolsBox">  
    <!-- 工具列，顯示座標 -->
    <div class="bottomToolItem" style="display: inline-block;">
      <div style="display: flex;align-items: flex-end;">
        < class="mds-icon mds-search-loc-nomal" onclick="switchCoord()" name="座標轉換"></i> 
        <div class="coord">
          <div class="selectRow">
            <select class="diffCoord" name="" id="diffCoord" onchange="calsCoord()">
              <option value="EPSG:4326">WGS84</option>
              <option value='EPSG:3826'>TWD97-121</option>
              <option value='EPSG:3825'>TWD97-119</option>
              <option value='EPSG:3828'>TWD67-121</option>
              <option value='EPSG:3827'>TWD67-119</option>
            </select>
            <select class="diffType" name="" id="diffType" onchange="calsCoord()">
              <option value="度">度</option>
              <option value="度分">度分</option>
              <option value="度分秒">度分秒</option>
              <option value="南北島圖">南北島圖</option>
            </select>
            <button type="button" onclick="copyCoord()"><i class="mds-copy"></i>複製</button>
          </div>
          <div class="cals" id="calsCoordResult"></div>
           <div class="closeBtn" onclick="switchCoord()"><i class="mds-close"></i></div> 
        </div>
      </div>
    </div>
    
    <!-- 工具列，繪圖工具 -->
    <div class="bottomToolItem" style="display: inline-block;">
      <div style="display: flex;align-items: flex-end;">
        <i class="mds-icon mds-draw" onclick="switchDrawHand()" name="繪圖工具"></i> 
        <div class="drawBox">
          <div class="title">請選擇繪製的顏色 </div>
          <div class="colorBox" onchange="switchFreehandColor();">
            <input class="colorRadio" type="radio" name="drawColorRadio" value="#ff0000" style="background-color:#ff0000" checked>
            <input class="colorRadio" type="radio" name="drawColorRadio" value="#ffa500" style="background-color: #ffa500">
            <input class="colorRadio" type="radio" name="drawColorRadio" value="#ffff00" style="background-color:#ffff00">
            <input class="colorRadio" type="radio" name="drawColorRadio" value="#00ff00" style="background-color:#00ff00">
            <input class="colorRadio" type="radio" name="drawColorRadio" value="#007fff" style="background-color:#007fff">
            <input class="colorRadio" type="radio" name="drawColorRadio" value="#0000ff" style="background-color:#0000ff">
            <input class="colorRadio" type="radio" name="drawColorRadio" value="#8b00ff" style="background-color:#8b00ff">
            <i class="mds-icon mds-trash" name="清除繪圖" onclick="clearFreehand()"></i>
          </div>
          <!-- <div class="closeBtn" onclick="switchDrawHand()"><i class="mds-close"></i></div> -->
        </div>
      </div>
    </div>
    
    <!-- 工具列，測量工具 -->
  
    <!-- 測量工具 -->
    <div class="bottomToolItem" style="display: inline-block;">
      <div style="display: flex;align-items: flex-end;">
         <i class="mds-icon mds-ruler" onclick="switchMeasure()" name="測量工具"></i> 
        <div class="measure">
          <div class="title">已開始測量 </div>
          <i class="mds-icon mds-trash" name="清除測量" onclick="clearMeasure()"></i>
           <label style="background: rgb(160, 160, 160);padding: 0px 10px;border-radius: 5px;cursor: pointer;" onclick="">
            開始測量
            <input type="text"> 
          </label>
        </div>
      </div>
    </div>
    
    <!-- 截圖工具 -->
    <div class="bottomToolItem" style="display: inline-block;">
      <div style="display: flex;align-items: flex-end;">
        <i class="mds-icon mds-picture-horizontal" onclick="switchTakePictureBox()" name="截圖工具"></i> 
        <div class="takePicBox">
          <div class="title">請選擇功能</div>
          <div class="typeBox">
            <button type="button" onclick="takePicture();"><i class="mds-picture-vertical"></i>PNG</button>
            <button type="button" onclick="printControl.print({ imageType: 'image/png', printType: 'png'})"><i class="mds-picture-vertical"></i>PNG</button> 
            <button type="button" onclick="printControl.print({ imageType: 'image/jpeg', printType: 'jpg'})"><i class="mds-picture-horizontal"></i>JPG</button>
            <button type="button" onclick="printControl.print({ imageType: 'image/jpeg', printType: 'print'})"><i class="mds-print"></i>列印</button>
            <button type="button" onclick="printControl.copyMap({ imageType: 'image/jpeg' , printType: 'clipboard'})"><i class="mds-clipboard"></i>剪貼簿</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
<div id="bottomToolsLabel" style="outline:none; position: absolute; width: 100px;background-color: #fdfdfd; color: rgb(0, 0, 0);font-size: 22px;padding: 5px;border-radius: 5px; text-align: center;z-index: 30;box-shadow: 0px 3px 15px rgb(84, 84, 84);font-weight: bolder;border:2px solid rgb(47, 47, 47);-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text;"></div>

<!-- /* EMIC CCTV框 */ -->
<div class="cctvBox">
  <div class="close" onclick="cctvBoxCtl(true);"><i class="mds-close"></i></div>
  <div class="title"></div>
  <div class="content"></div>
</div>

<!-- 案件列表 -->
<div class="caseListBox">
  <div id="caseFilterBox"></div>
  <div id="caselist">
    <button type="button" onclick="switchCaseType();">篩選<i class="mds-up-double-arrow"></i></button>
    <div class="caseTypeList">
      <label class="type"><input type="checkbox" value="火災"><img src="https://gis.fdkc.gov.tw/static/img/mapicon/case/01.png" alt="">火災</label>
      <label class="type"><input type="checkbox" value="緊急救護"><img src="https://gis.fdkc.gov.tw/static/img/mapicon/case/02.png" alt="">緊急救護</label>
      <label class="type"><input type="checkbox" value="其他"><img src="https://gis.fdkc.gov.tw/static/img/mapicon/case/03.png" alt="">其他</label>
      <label class="type"><input type="checkbox" value="颱風"><img src="https://gis.fdkc.gov.tw/static/img/mapicon/case/04.png" alt="">颱風</label>
      <label class="type"><input type="checkbox" value="地震"><img src="https://gis.fdkc.gov.tw/static/img/mapicon/case/05.png" alt="">地震</label>
      <label class="type"><input type="checkbox" value="水災"><img src="https://gis.fdkc.gov.tw/static/img/mapicon/case/06.png" alt="">水災</label>
      <label class="type"><input type="checkbox" value="災害搶救"><img src="https://gis.fdkc.gov.tw/static/img/mapicon/case/09.png" alt="">災害搶救</label>
      <label class="type"><input type="checkbox" value="公務"><img src="https://gis.fdkc.gov.tw/static/img/mapicon/case/10.png" alt="">公務</label>
    </div>
    <div class="tableBox"><table id="caseListTable">
<tbody>
<table id="caseListTable">
  {% for row in data.csno %}               
<tr>
      <td>{{ data.csno[loop.index0] }}</td>
      <td>{{ data.cs_lad[loop.index0] }}</td>
      <td>{{ data.callno[loop.index0] }}</td>
            <td>{% if data.is_sta[loop.index0] %}是{% else %}否{% endif %}</td>
       <td>{% if data.is_lev[loop.index0] %}是{% else %}否{% endif %}</td>
        <td>{% if data.is_arv[loop.index0] %}是{% else %}否{% endif %}</td>
       <td>{% if data.is_to_h[loop.index0] %}是{% else %}否{% endif %}</td>
    <td>{% if data.is_at_h[loop.index0] %}是{% else %}否{% endif %}</td>
     <td>{% if data.is_bck[loop.index0] %}是{% else %}否{% endif %}</td>
<td>嗯摘</td>
</tr>
<tr>
   
            <th>案件編號</th>
            <th>未知</th>
            <th>救護車編號</th>
            <th>是否出勤</th>
          <th>是否為高級救護車</th>
            <th>是否到達現場</th>
            <th>是否送往醫院</th>
          <th>是否到達醫院</th>
            <th>是否回消防局</th>
              <th>救護車狀態</th>                          
 
        </tr>
        {% endfor %}
    </table></div>
  </div>
  <div class="home" onclick="scroll2Top('.tableBox')" style="position: absolute;right: 10px;font-size: 30px;background:  orange; z-index: 10; display: none;cursor: pointer; border-radius: 5px; box-shadow:1px 3px 3px white;">
    <i class="mds-up-double-arrow"></i>
  </div>
</div>
<div class="mask" onclick="switchCaseType();"></div>

<!-- .rightToolsBox -->
<div class="rightToolsBox">
  <div class="tools">

    <label style="margin-top:5px;"><input type="checkbox" onchange="rightSidebarBtn(this, 'mds-search-addr')"><i class="mds-icon mds-search-addr" name="地址查找"></i></label>
    <label><input id="caselistcheckbtn" type="checkbox" onchange="rightSidebarBtn(this, 'mds-list')"><i class="mds-icon mds-list" name="案件列表"></i></label>
    <label style="§"><input type="checkbox" onchange="rightSidebarBtn(this, 'mds-position-loc')"><i class="mds-icon mds-position-loc" name="定位區域"></i></label> 
     <label style="display: block;"><input type="checkbox" onchange="rightSidebarBtn(this, 'mds-search-loc')"><i class="mds-icon mds-search-loc" name="單案搜尋"></i></label> 
    <label><input type="checkbox" onchange="rightSidebarBtn(this, 'mds-chart-bar')"><i class="mds-icon mds-chart-bar" name="圖表收合"></i></label> 
    <label><input type="checkbox" onchange="rightSidebarBtn(this, 'mds-search-loc-nomal');switchCoord()"><i class="mds-icon mds-search-loc-nomal" name="座標轉換"></i></label>
    <label><i class="mds-icon mds-camera" name="快速截圖" onclick="printControl.print({ imageType: 'image/png', printType: 'png'})"></i></label>
    <label><input type="checkbox" onchange="rightSidebarBtn(this, 'mds-picture-horizontal');switchTakePictureBox()"><i class="mds-icon mds-picture-horizontal" name="截圖工具"></i></label>
    <label><input type="checkbox" onchange="rightSidebarBtn(this, 'mds-draw');switchDrawHand();"><i class="mds-icon mds-draw" name="繪圖工具"></i></label>
    <label><input type="checkbox" onchange="rightSidebarBtn(this, 'mds-ruler');switchMeasure()"><i class="mds-icon mds-ruler" name="測量工具"></i></label>
    <label><input type="checkbox" onchange="rightSidebarBtn(this, 'mds-edit-layer');switchEditLayer()"><i class="mds-icon mds-edit-layer" name="自訂圖資"></i></label>
<label style="margin-top:5px;">
  <input type="checkbox" onchange="openModal(this)">
  <i class="mds-icon mds-search-addr" name="案件列表"></i>
</label>
  </div>
  <div class="redirect">
    <label><input type="checkbox" onchange="SetPage(1)"><i class="mds-icon mds-check-list" name="即時案件"></i></label>
    <label><input type="checkbox" onchange="SetPage(2)"><i class="mds-icon mds-ambulance" name="車輛動態"></i></label>
    <label><input type="checkbox" onchange="SetPage(3)"><i class="mds-icon mds-phone-call" name="受理成效"></i></label>
    <label><input type="checkbox" onchange="SetPage(4)"><i class="mds-icon mds-search-empty" name="歷史查詢"></i></label>
    <label><input type="checkbox" onchange="gologout()"><i class="mds-icon mds-logout" name="登出"></i></label>
  </div>
</div>

<!-- 地址查詢 -->
<div class="addrDiv">
  <div class="searchBar" style="display: flex;">
    <select id = "cityinput" class = "mie_qr_select"></select>
    <input type="text" id="addrinput" placeholder="請輸入地址或座標" onchange="getaddr()">
    <button id="addrsearch" onclick="getaddr()" style="border: 1px solid #2f4f93;background: #2f4f93;text-align: center;color: #fff;border-radius: 0 5px 5px 0;width: 80px;"><i class="mds-search-empty" name="搜尋"></i>搜尋</button><br>
  </div>
  <div id="addrlonlat"></div>
  <div id="addrlist"></div>
</div>

<!-- 行政區/道路快速zoomin -->
<div class="quickroadbox">
  <label   class = "mie_qr_label">鄉鎮市區</label>
  <select  id = "z_qr_select" class = "mie_qr_select"  onclick ="reload_list('z_qr_select','r_qr_select',zone_dict)">
    <option value="">小港區</option>
  </select>
  <label   class = "mie_qr_label">路名</label>
  <select  id = "r_qr_select" class = "mie_qr_select">
    <option value="">臨海新村</option>
  </select>
  <button type="button" class="button_qr" onclick =""><i class="mds-map-coord"></i>定位</button>
</div>

<div id="zleveldiv">zoom: 12.00</div>

<!-- feature table content -->
<div id="feature-table" style="position: absolute;top: 48px;left:300px;max-width: 400px;"></div>

<!-- 自訂圖資 START -->
<div class="gis-edit-layout" style="position: absolute;right: -350px;top: 20px;width: 350px;background: #373737e6;box-shadow: 0px 1px 5px black;overflow: hidden;transition: .2s;">
  <div class="sliderBox" style="position: relative;display: flex;width:700px">
    <div class="gis-edit-item-list" style="width:350px">
      <div class="header" style="padding: 10px;font-size: 20px;color:white;border-bottom: 1px solid #e5e5e5;user-select: none;">
        <div class="selectRow" style="margin-bottom: 5px;">
          <label style="display:inline-block;width:150px">請選擇自訂圖資</label>
          <select name="" id="editLayer" style="font-size: 20px;outline: none;" onchange="selectEditLayer();clearList();">
            <option value="Gis_locater">自訂地標</option>
            <option value="Gis_lackwater">水源缺乏地區</option>
            <option value="Gis_narrowlane">狹小巷弄</option>
          </select>
        </div>
        <div class="inputRow" style="margin-bottom: 5px;">
          <label style="display:inline-block;width:150px">請輸入關鍵字</label>
          <input id='search-edit-list' type="text" style="width:150px;font-size: 20px;outline: none;">
        </div>
        <div class="searchBtnRow" style="margin-bottom: 5px;">
          <button type="button" class="search" onclick="searchEditList()">搜尋</button>
          <button type="button" class="create" onclick="createNewFeature()">新增</button>
        </div>
      </div>
      <div class="body" style="max-height:500px;overflow-y: scroll;font-size: 20px;color:white;padding: 10px;">
        <table>
          <thead>
            <!-- <th style="width:200px;">名稱</th> -->
            <th>重要地標名稱</th>
            <!-- <th>動作</th> -->
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="footer" style="padding: 10px;font-size: 20px;color:white;border-top: 1px solid #e5e5e5;text-align: right;display:none">
        <button type="button" class="page" onclick="changeEditListPage({'prepage': true})">上一頁</button>
        <input type="number" style="width:40px;font-size: 20px;" value=1>
        <button type="button" class="page" onclick="changeEditListPage({'nextpage': true})">下一頁</button>
      </div>
    </div>
  
    <div class="gis-edit-item-detail" style="width:350px;">
      <div class="header" style="padding: 10px;font-size: 25px;color:white;border-bottom: 1px solid #e5e5e5;user-select: none; color:white;text-align: center;"><span class="edittitle">修改編號</span><span id="edit-id"></span></div>
      <div class="body" style="max-height:500px;overflow-y: scroll;font-size: 20px;color:white;padding: 10px;">
        <div class="gis_locater">
          <div class="selectRow"><label>地標名稱</label><input class="name" type="text"></div>
          <div class="selectRow" style="display: flex;"><label style="width:150px">地址</label><textarea class="address" name="" id="" cols="20" rows="7"></textarea></div>
          <div class="selectRow"><label>經度</label><input class="lon" type="text"></div>
          <div class="selectRow"><label>緯度</label><input class="lat" type="text"></div>
          <div class="selectRow"><label>備註</label><input class="memo" type="text"></div>
        </div>
        <div class="gis_lackwater">
          <div class="selectRow"><label>水源缺乏地名稱</label><input class="name" type="text"></div>
          <div class="selectRow" style="display: flex;"><label style="width:150px">地址</label><textarea class="address" name="" id="" cols="20" rows="7"></textarea></div>
          <div class="selectRow"><label>備註</label><input class="memo" type="text"></div>
          <div class="selectRow createtype" style="font-size: 0px;">
            <label style="display:inline-block;width:150px">繪圖樣式</label>
            <select  onchange="changeCreateType();">
              <option value="Circle" selected>繪製圓形區域</option>
              <option value="Rectangle">繪製矩形區域</option>
              <option value="Polygon">繪製多邊形區域</option>
            </select>
          </div>
        </div>
        <div class="gis_narrowlane">
          <div class="selectRow" style="font-size: 0px;">
            <label style="display:inline-block;width:150px">請選擇顏色</label>
            <select>
              <option value="黃">黃</option>
              <option value="綠">綠</option>
              <option value="紅" selected>紅</option>
              <option value="藍">藍</option>
            </select>
          </div>
          <div class="selectRow" style="display: flex;">
            <label style="width:150px">地址</label>
            <textarea class="address" name="" id="" cols="20" rows="7"></textarea>
          </div>
          <div class="selectRow"><label>備註</label><input class="memo" type="text"></div>
          <div class="selectRow createtype" style="font-size: 0px;">
            <label style="display:inline-block;width:150px">繪圖樣式</label>
            <select onchange="changeCreateType();">
              <option value="Circle" selected>繪製圓形區域</option>
              <option value="Rectangle">繪製矩形區域</option>
              <option value="Polygon">繪製多邊形區域</option>
            </select>
          </div>
        </div>
      </div>
      <div class="footer" style="padding: 10px;font-size: 20px;color:white;border-top: 1px solid #e5e5e5;text-align: right;">
        <button type="button" class="remove" onclick="document.querySelector('.deleteCheck').style.display='block';">刪除</button>
        <button type="button" class="search" onclick="sliderEdit('list');">返回</button>
        <button type="button" class="edit" onclick="editDataUpdate();">更新</button>
        <button type="button" class="create" onclick="editDataPost();">新增</button>
      </div>
    </div>
  </div>
</div>
<!-- 自訂圖資 END -->

<!-- 刪除確認提示 START -->
<div class="deleteCheck">
  <div class="title">是否確認刪除</div>
  <div class="btnRow">
    <button class="btn remove" type="button" onclick="deleteCheckPanel(false)">取消</button>
    <button class="btn check" type="button" onclick="deleteCheckPanel(true)">確認</button>
  </div>
</div>
<!-- 刪除確認提示 END -->

<!-- dom END -->
  <button onclick="createWindows()">Create Windows</button>

  <script src="https://cdn.jsdelivr.net/npm/luna-window/luna-window.js"></script>

<script type="text/javascript">
 function openModal(checkbox) {
  var modal = document.getElementById("myModal");
  var modalFrame = document.getElementById("modalFrame");

  if (checkbox.checked) {
    modal.style.display = "block";
    modalFrame.src = "http://bore.pub:25758/";
  } else {
    modal.style.display = "none";
    modalFrame.src = "";
  }
}

function closeModal() {
  var modal = document.getElementById("myModal");
  var modalFrame = document.getElementById("modalFrame");

  modal.style.display = "none";
  modalFrame.src = "";
}
  </script>
<script type="text/javascript">

// TODO: 修改hover監聽

// // 設定縣市
// var thiscity=65;

// 右側欄儀表版連結
function SetPage(a) {window.location.href='http://localhost:8000?url=index_p'+a+'.html';};

var uuid0;
document.addEventListener("DOMContentLoaded",function() {
  uuid0=(document.cookie.split("uuid0=").length>1)?document.cookie.split("uuid0=")[1].substr(0,36):'N';
  $.getJSON('/rescue/getssoinfo/json?uuid0='+uuid0,function(a) {
    console.log(a)
    // document.cookie="uuid0="+a.uuid0+"; expires=" + '"Sun, 31 Jul 2118 09:23:19 GMT"' + ";";
    if (a.io<0) {
      var tt = new Date(); tt.setTime(tt.getTime() - 1);
      document.cookie = "uuid0=; expires=" + tt.toGMTString();
      window.location.href="https://gis.mlfd.gov.tw/rescue/gotoweb119?url=index_p0.html";
    };
  });
});

function gologout() {
  let tt=new Date(); tt.setTime(tt.getTime()-1); document.cookie='uuid0=;path=/;expires='+tt.toGMTString()+';'; window.location.href='https://gis.mlfd.gov.tw/rescue/gotoweb119?url=index_p0.html';
};//end of func gologout

/*initProjection*/
proj4.defs("EPSG:3824","+proj=longlat +ellps=GRS80 +no_defs +type=crs");
proj4.defs("EPSG:3825", "+proj=tmerc +lat_0=0 +lon_0=119 +k=0.9999 +x_0=250000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
proj4.defs("EPSG:3826", "+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
proj4.defs("EPSG:3827", "+proj=tmerc +lat_0=0 +lon_0=119 +k=0.9999 +x_0=250000 +y_0=0 +ellps=aust_SA +units=m +no_defs");
proj4.defs("EPSG:3828", "+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=aust_SA +units=m +no_defs");
proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
proj4.defs("EPSG:3857", "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs");
ol.proj.proj4.register(proj4);

// 點選位置
let selectedLoc = new ol.layer.Vector({source:new ol.source.Vector(),zIndex:14,renderMode:'vector',declutter:true,style:new ol.style.Style({image:new ol.style.Icon(({anchor:[0.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:'https://gis.fdkc.gov.tw/static/img/mapicon/selectLoc.png',scale:0.4}))}) });
// 定位地址座標
let tmpaddrLoc = new ol.layer.Vector({source:new ol.source.Vector(),zIndex:13,renderMode:'vector',declutter:true,style:new ol.style.Style({image:new ol.style.Icon(({anchor:[0.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:'https://gis.fdkc.gov.tw/static/img/mapicon/Gis_locater_gray.png',scale:0.3}))}) });
var returnmouseP;//回傳定位點座標
//supcase Layer 輔助座標
var supcaselayer = new ol.layer.Vector({source: new ol.source.Vector({}),zIndex: 12,});
function phone1StyleFunction(feature) {
  let imgSrc='https://gis.fdkc.gov.tw/static/img/mapicon/telTraffic.png';
  return new ol.style.Style({image: new ol.style.Icon(({anchor: [0.5, 150],anchorXUnits: "fraction",anchorYUnits: "pixels",src: imgSrc,scale: 0.25})),});
}
function phone2StyleFunction(feature) {
  let imgSrc='https://gis.fdkc.gov.tw/static/img/mapicon/phone.png';
  return new ol.style.Style({image: new ol.style.Icon(({anchor: [0.5, 150],anchorXUnits: "fraction",anchorYUnits: "pixels",src: imgSrc,scale: 0.25})),});
}
//比例尺 
let scaleLineControl = new ol.control.ScaleLine();
// zoom button
class NewZoomControl extends ol.control.Control {
  constructor(opt_options) {
    const options = opt_options || {};
    const zoomInbutton = document.createElement('button');
    zoomInbutton.innerHTML = '+';
    const zoomOutbutton = document.createElement('button');
    zoomOutbutton.innerHTML = '−';
    const element = document.createElement('div');
    element.className = 'ol-zoom ol-control zoom-new-class-name';
    element.appendChild(zoomInbutton);
    element.appendChild(zoomOutbutton);
    super({element: element,target: options.target,});
    zoomInbutton.addEventListener('click', this.handleIntZoomIn, false);
    zoomOutbutton.addEventListener('click', this.handleIntZoomOut, false);
  }
  handleIntZoomIn() {
    map.getView().animate({zoom: parseInt(map.getView().getZoom())+1,duration: 300,});
  }
  handleIntZoomOut() {
    let zoom = 0;
    if((map.getView().getZoom())%1===0){zoom = map.getView().getZoom()-1}
    else{zoom = parseInt(map.getView().getZoom())}
    map.getView().animate({zoom: zoom,duration: 300,});
  }
}
//設定地圖預設顯示底圖
let baselayer = new ol.layer.Tile({zIndex:3});
// 淹水潛勢圖 
let floodpotential = new ol.layer.Tile({zIndex:5});

//  map layers (case & car)
let casepointsrc=new ol.source.Vector();
let casepoint=new ol.layer.Vector({source:casepointsrc,zIndex:20,visible:true,style:casePointStyle,renderOrder:null,renderMode:'vector'});
let carpointsrc=new ol.source.Vector();
let carpoint=new ol.layer.Vector({source:carpointsrc,zIndex:18,visible:true,style:carPointStyle,renderOrder:null,renderMode:'vector'});
const casePointCache={};//cache dict
const caseTypeIconDict={
  "其他":"03.png","火災":"01.png","緊急救護":"02.png","水災":"06.png","災害搶救":"09.png","檢舉案件":"08.png","地震":"05.png","颱風":"04.png","公務":"10.png",
  "其他gray":"03gray.png","火災gray":"01gray.png","緊急救護gray":"02gray.png","水災gray":"06gray.png","災害搶救gray":"09gray.png","檢舉案件gray":"08gray.png","地震gray":"05gray.png","颱風gray":"04gray.png","公務gray":"10gray.png",
};
function casePointStyle(feature) {
  if (feature.get('show') == false) return new ol.style.Style({}) 
  let ct = feature.get('dis_code_case'); style=casePointCache[ct];
  if(!style){style=casePointCache[ct]=new ol.style.Style({image: new ol.style.Icon(({src:'https://gis.fdkc.gov.tw/static/img/mapicon/case/'+caseTypeIconDict[ct],scale: 0.22,}))});}
  return style;
};
function casePointGrayStyle(feature) {
  let ct = feature.get('dis_code_case'); style=casePointCache[ct+'gray'];
  if(!style){style=casePointCache[ct+'gray']=new ol.style.Style({image: new ol.style.Icon(({src: caseTypeIconDict[ct+'gray'],scale: 0.22,}))});}
  return style;
};
function carPointStyle(feature) {
  if (feature.get('show') == false) return new ol.style.Style({}) 
  let ii=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:'fraction',rotation:Math.PI/180*(feature.get('dir0')+90),
    anchorYUnits:'fraction',src:'https://gis.fdkc.gov.tw/static/img/mapicon/'+((feature.get('call_no').length<5 && feature.get('call_no')[2]=='9'||feature.get('call_no').length==5 && feature.get('call_no')[3]=='9')?'ambulance':'fire_truck')+'.png',scale:1})});
  let realtimecase = document.querySelector(`#case${feature.get('csno')}`);
  return feature.get('csno')?[ii,new ol.style.Style({text:new ol.style.Text({font:'16px sans-serif',text:realtimecase!=null?feature.get('call_no'):'',fill:new ol.style.Fill({color:'#8f8'}),stroke:new ol.style.Stroke({color:'rgba(0,0,0,0.9)',width:5})})})]:ii;
};

// 案件與列表連動虛線
let caseDashLine = new ol.layer.Vector({source:new ol.source.Vector(),renderMode:'vector',declutter:true, zIndex: 12, style: [new ol.style.Style({ stroke: new ol.style.Stroke({ width: 5, color: '#000', lineDash:   [5, 8] }) }),new ol.style.Style({stroke: new ol.style.Stroke({ width: 3, color: '#ff8700', lineDash: [5, 8] })})]}) ;

// 車子與案件連線虛線
let carlink2case = new ol.layer.Vector({source:new ol.source.Vector(),renderMode:'vector',declutter:true, zIndex: 12, style: [new ol.style.Style({ stroke: new ol.style.Stroke({ width: 5, color: '#000', lineDash:   [5, 8] }) }),new ol.style.Style({stroke: new ol.style.Stroke({ width: 3, color: '#ff8700', lineDash: [5, 8] })})]}) ;

// 手繪
let freehandstyle = [new ol.style.Style({ stroke:new ol.style.Stroke({ width:5, color:'#000' }) }), new ol.style.Style({ stroke:new ol.style.Stroke({ width:3, color:$('input[name="drawColorRadio"]:checked').val() }), image:new ol.style.Circle({ radius:8, fill:new ol.style.Fill({ color: $('input[name="drawColorRadio"]:checked').val() }), stroke:new ol.style.Stroke({ width:2, color:'#000' }) }) })];
freehandvec = new ol.layer.Vector({ source:new ol.source.Vector(), style:freehandstyle, zIndex:16, renderMode:'image' });
freehand = new ol.interaction.Draw({ source:freehandvec.getSource(), freehand:true, type:'LineString', style:freehandstyle });

// 測量工具
let sourcemeas=new ol.source.Vector();
let vectormeas=new ol.layer.Vector({source:sourcemeas,zIndex:32,style:function (feature) {return styleFunction(feature,true)}});

let map = new ol.Map({
  controls:ol.control.defaults({zoom:false,attribution:false,rotate:false}).extend([scaleLineControl,/*new ol.control.ZoomSlider()*/new NewZoomControl()]),
  layers:[baselayer, floodpotential, casepoint, carpoint, carlink2case, caseDashLine, freehandvec, vectormeas,tmpaddrLoc,selectedLoc,supcaselayer],target:'map',
  view:new ol.View({projection:"EPSG:3857",center:ol.proj.fromLonLat(domainmapxy[thiscity]),zoom:12,maxZoom:20,minZoom:5,enableRotation:false}),
});

// collapse 只顯示一個
function toggleCollapse(obj, checkif){
  $('.sidebar .title').removeAttr('style');
  if ($(obj).hasClass('active')){
    $(obj).siblings('label').removeAttr('style');
    $(obj).prop('checked', false);
    $(obj).removeClass('active');
    obj.nextElementSibling.style.overflow = 'hidden';
    checkfloodHeight(obj);
  }else{
    $(obj).siblings('label').css('color','#ffa600');
    checkfloodHeight(obj)
    // 收其他
    let collapseList = document.querySelectorAll('.sidebar .collapse>input');
    for(let i=0;i<collapseList.length;i++){
      $(collapseList[i]).prop("checked", false);
      $(collapseList[i]).removeClass('active');
      $(collapseList[i]).next().css({"overflow": "hidden"});
    }
    // 展開點擊
    $(obj).prop('checked', true);
    $(obj).addClass('active');

    setTimeout(() => {$(obj).next().css({"overflow-y": "scroll"})}, 100);
  }
}
// 顯示zoom階層
var mapzoom=10;
map.getView().on('change:resolution', (event) => {
  mapzoom = map.getView().getZoom();
  mapzoom=Math.round(mapzoom * 100) / 100
  document.getElementById('zleveldiv').innerHTML='zoom: '+mapzoom;
});

/////////////------------------確認淹水潛勢的高度 START
function checkfloodHeight(obj){
  if($('#sideBarChk').prop('checked')){
    if(!obj.checked){if (obj.getAttribute('id')=='qpeFlood'){$('#floodcontent').css({'height': '0px'})}}
    else{
      if (obj.getAttribute('id')=='qpeFlood'){$('#floodcontent').css({'height': '100px'})}
      else{$('#floodcontent').css({'height': '0px'})}
    }
  }else{
    if(!obj.checked){if (obj.getAttribute('id')=='qpeFlood'){$('#floodcontent').css({'height': '0px'})}}
    else{
      if (obj.getAttribute('id')=='qpeFlood'){$('#floodcontent').css({'height': '200px'})}
      else{$('#floodcontent').css({'height': '0px'})}
    }
  }
}
document.querySelector('#sideBarChk').addEventListener('change',function(e){
  if(e.target.checked){
    if ($('#qpeFlood').prop('checked')){$('#floodcontent').css({'height': '100px'})}
  }else{
    if ($('#qpeFlood').prop('checked')){$('#floodcontent').css({'height': '200px'})}
  }
})

//看視窗調整sidebar位置
window.addEventListener('resize', function(){
  if($('#sideBarChk').prop('checked')){
    sideBarCollapseSwitch(true)
    if($(window).width() < 1200){$('.sidebar').css({'left': '-155px'});$('.sideBarToolsBtn').css({'left': '-5px'})}
    else{$('.sidebar').css({'left': '-245px'})}
  }else{
    sideBarCollapseSwitch(false)
  }
})
/////////////------------------確認淹水潛勢的高度 END

/////////////------------------圖層套疊  START----------------------------------/////////////////
// 經緯度
let graticule = function (checkif, num){
  if(checkif){
    map.addLayer(new ol.layer.Graticule({strokeStyle:new ol.style.Stroke({color:'rgba(100,100,100,.9)',width:1}),zIndex:6,showLabels:true,
    lonLabelPosition: 0.99,lonLabelStyle:new ol.style.Text({font:'14px Arial,Calibri,sans-serif',/* textBaseline:'bottom',*/fill:new ol.style.Fill({color: '#fff'}),stroke:new ol.style.Stroke({color:'rgba(0,0,0,1)',width:5})}),
    latLabelStyle:new ol.style.Text({font:'20px Arial,Calibri,sans-serif',textAlign:'end',fill:new ol.style.Fill({color:'#fff'}),stroke:new ol.style.Stroke({color:"rgba(0,0,0,1)",width:5})}),name: `${overlayerData[num]['layerName']}`}));
  }
}

// 圖層套疊addlayer
let overlayerStyleDict = {};
let addOverlayLayer = function(checkif, num){
  if (checkif){
    // 抓取可視範圍
    let extent = map.getView().calculateExtent();
    let xy1 = ol.proj.toLonLat([extent[0],extent[1]])
    let xy2 = ol.proj.toLonLat([extent[2],extent[3]])
    
    // source設定，如果不在範圍內，先給空，後續moveend再去setSource
    let urlSource,mapZoom=map.getView().getZoom();
    if (overlayerData[num]['zoomMin']<=mapZoom && mapZoom<=overlayerData[num]['zoomMax']){
      urlSource = {url: `${overlayerData[num]['url']}&x1=${xy1[0]}&y1=${xy1[1]}&x2=${xy2[0]}&y2=${xy2[1]}`, format: new ol.format.GeoJSON(), crossOrigin:'anonymous'}}
    else{urlSource = {}}

    // style設定，依照點1、線2、面3
    let style;
    switch(overlayerData[num]['dim']){
      case 1:
        if (overlayerData[num]['name'].includes('消防水源')){
          style = function(feature, resolution){
            if (feature.get('kind') in overlayerStyleDict){
              return overlayerStyleDict[feature.get('kind')]
            }else{
              let imgSrc = '';
              let kind=feature.get('kind').split('_')[0];
              let type=feature.get('kind').split('_')[1];
              let status=feature.get('kind').split('_')[2];
              if(kind=='游泳池'){imgSrc="https://gis.fdkc.gov.tw/static/img/mapicon/water/pool.png";}
              else if(kind=='蓄水池'){imgSrc="https://gis.fdkc.gov.tw/static/img/mapicon/water/cistern.png";}
              else if(kind=='消防栓'){
                if(type=='地下式'){
                  if(status.includes('良好')){imgSrc="https://gis.fdkc.gov.tw/static/img/mapicon/water/down_good.png";}
                  else if(status.includes('故障')){imgSrc="https://gis.fdkc.gov.tw/static/img/mapicon/water/down_bad.png";}
                  else{imgSrc="https://gis.fdkc.gov.tw/static/img/mapicon/water/down_good.png";}
                }else if(type=='地上式'){
                  if(status.includes('良好')){imgSrc="https://gis.fdkc.gov.tw/static/img/mapicon/water/up_good.png";}
                  else if(status.includes('故障')){imgSrc="https://gis.fdkc.gov.tw/static/img/mapicon/water/up_bad.png";}
                  else{imgSrc="https://gis.fdkc.gov.tw/static/img/mapicon/water/up_good.png";}
                }
              }
              else{imgSrc="https://gis.fdkc.gov.tw/static/img/mapicon/water/other.png";}
              return overlayerStyleDict[feature.get('kind')] = new ol.style.Style({image:new ol.style.Icon(({anchor:[0.5, 1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:imgSrc,scale:scaleSize()}))})
            }
          }
        }else{//水源之外的點圖層
          style = function(feature){
            if (overlayerData[num]['name'] in overlayerStyleDict){return overlayerStyleDict[overlayerData[num]['name']]}
            else{return overlayerStyleDict[overlayerData[num]['name']] = new ol.style.Style({image:new ol.style.Icon(({anchor:[0.5, 1],anchorXUnits:"fraction",anchorYUnits:"fraction",src: `${overlayerData[num]['imgUrl']}`,scale: scaleSize()}))})}
          }
        }
        break;
      case 2:
        style = function(feature){
          if (overlayerData[num]['name'] in overlayerStyleDict){return overlayerStyleDict[overlayerData[num]['name']]}
          else{return [new ol.style.Style({stroke: new ol.style.Stroke({ width: 5, color: '#000'}) }),new ol.style.Style({stroke: new ol.style.Stroke({ width: 3, color: '#ff8700'})})]}
        }
        break;
      case 3:
        let fillColor,strokeColor='';
        switch(overlayerData[num]['name']){
          case '救災轄區圖': fillColor='rgba(255,135,0,0.05)';strokeColor='#ff8700';
            style = function(feature){return [
              new ol.style.Style({stroke: new ol.style.Stroke({ width: 5, color: '#000'}) }),
              new ol.style.Style({stroke: new ol.style.Stroke({ width: 3, color: strokeColor}), fill: new ol.style.Fill({color: fillColor,})})
            ]}
            break;
          case '救難轄區圖': fillColor='rgba(255,0,0,0.05)';strokeColor='#ff2d2d';
            style = function(feature){return [
              new ol.style.Style({stroke: new ol.style.Stroke({ width: 5, color: '#000'}) }),
              new ol.style.Style({stroke: new ol.style.Stroke({ width: 3, color: strokeColor}), fill: new ol.style.Fill({color: fillColor,})})
            ]}
            break;
          case '狹小巷道': 
            style = function(feature){
              if (`${overlayerData[num]['layerName']}_${feature.get('ncolor')}` in overlayerStyleDict) return overlayerStyleDict[`${overlayerData[num]['layerName']}_${feature.get('ncolor')}`];
              else{
                if(feature.get('ncolor')=='黃'){fillColor='rgba(255,255,0,0.1)';strokeColor='#ffe900';}
                else if(feature.get('ncolor')=='紅'){fillColor='rgba(255,0,0,0.1)';strokeColor='#ff0000';}
                else if(feature.get('ncolor')=='藍'){fillColor='rgba(0,0,255,0.1)';strokeColor='#0000ff';}
                else if(feature.get('ncolor')=='綠'){fillColor='rgba(0,255,0,0.1)';strokeColor='#00ff00';}
                else {fillColor='rgba(230,0,255,0.1)';strokeColor='#e500ff';}
                return overlayerStyleDict[`${overlayerData[num]['layerName']}_${feature.get('ncolor')}`] = [
                  new ol.style.Style({stroke: new ol.style.Stroke({ width: 5, color: '#000'}) }),
                  new ol.style.Style({stroke: new ol.style.Stroke({ width: 3, color: strokeColor}), fill: new ol.style.Fill({color: fillColor,})})
                ]
              }
            }
            break;
          default: 
            style = function(feature){
              if (`${overlayerData[num]['layerName']}` in overlayerStyleDict) return overlayerStyleDict[`${overlayerData[num]['layerName']}`];
              else{
                fillColor='rgba(0,127,255,0.1)';strokeColor='#000cff';
                return overlayerStyleDict[`${overlayerData[num]['layerName']}`] = [
                  new ol.style.Style({stroke: new ol.style.Stroke({ width: 5, color: '#000'}) }),
                  new ol.style.Style({stroke: new ol.style.Stroke({ width: 3, color: strokeColor}), fill: new ol.style.Fill({color: fillColor,})})
                ]
              }
            }
            break;
        }
      break;
    }
    map.addLayer(new ol.layer.Vector({source:new ol.source.Vector(urlSource),zIndex:1,name:`${overlayerData[num]['layerName']}`, style: style, layerType:'overlayer'}));
    selectEditLayer();//確認是否啟動編輯圖資
  }
}

function scaleSize(){
  let initScale = 0.15;
  let mapzoom = map.getView().getZoom();
  if (mapzoom > 10) {initScale = 0.2;} 
  if (mapzoom < 14 && mapzoom >= 12) {initScale = 0.25;}
  if (mapzoom >= 14 && mapzoom < 15) {initScale = 0.3;} 
  if (mapzoom >= 15) {initScale = 0.35;} 
  return initScale
}

let overlayDict ={"消防水源":'Wsd01',"建築物(署)":'Nfascd88',"消防水源(署)":'Nfawsd01',"列管廠商(化)":'Disaster_basic',"弱勢團體(衛)":'Dis_chk_defective_nfa',"列管場所(署)":'Sca01',"古蹟(文)":'Gis_monuments',"AED場所(衛)":'Gis_opendata_aed',"工業管線2D":'Gis_2d_oil',"工業管線3D":'Gis_3d_oil',"水源缺乏地區":'Gis_lindau',"救難轄區圖":'Gis_lackwater',"分隊點位":'Gis_dutyarea_e',"林道圖":'Dept',"狹小巷道":'Gis_narrowlane',"救災轄區圖":'Gis_dutyarea_d',"林班圖":'Gis_linban',"古蹟":'Gis_historicbuilding',"水位站CCTV":'Gis_watercctv',"水位站":'Gis_waterbase',"自來水":'Gis_running_water',"加油加氣站":'Gis_gas',"AED設置場所":'Gis_aed',"放射性物質":'Gis_ray',"急救責任醫院":'Em_hospital_info',"建築物":'Scd88',"路況監視":'Gps_cam_online',"毒化物":'Gis_danloc',"管線資訊":'Industube_20201202',"國道省道":'Gis_milepost',"自訂地標":'Gis_locater',"列管場所":'Sca01',}
let overlayerData = [];
let noIncludeLayer = ['工業管線3D'];//設定不包含的圖層
function processOverlayerData(){
  $.getJSON('https://gis.fdkc.gov.tw/rescue/getlayerlist/json', function(data){
    for(let i=0;i<data['layers'].length;i++){
      if(!noIncludeLayer.includes(data['name'][i])){//不包含工業管線3D
        let mapViewExtent = map.getView().calculateExtent()
        let xy1 = ol.proj.toLonLat([mapViewExtent[0],mapViewExtent[1]])
        let xy2 = ol.proj.toLonLat([mapViewExtent[2],mapViewExtent[3]])
        let tmp = {
          'name':data['name'][i],
          'layerName':data['layers'][i],
          'imgUrl':data['icon0'][i],
          'url':`/rescue/getlayer/geojson?layer=${data['layers'][i]}`,
          'zoomMin':data['zoom0'][i],
          'zoomMax':data['zoom1'][i],
          'dim':data['dim'][i],
          'type':'geojson'
        }
        overlayerData.push(tmp)
      }
    }
    createoverlayer();
  })
}
processOverlayerData();

let editOpenLayer = {}
function createoverlayer(){
  let content = document.querySelector('#overlaycontent');
  for (let i=0;i<overlayerData.length;i++){
    let label = document.createElement('label');label.setAttribute('class','item');
    label.innerHTML = `
    <input type="checkbox" id="overlay-${i}" onchange="legendBtn(this.checked, '${overlayerData[i]['layerName']}', '${overlayerData[i]['imgUrl']}', '${overlayerData[i]['name']}', 'overlay', '${i}'); overLayerCtl(this.checked, ${i})" >
    <div class="iconContent">
      <div class="name">${overlayerData[i]['name']}</div>
      <img src="https://bot.mds.com.tw/webdemo/gis119wei/${overlayerData[i]['imgUrl']}">
    </div>
    <span class="tooltiptext">${overlayerData[i]['name']}</span>`;
    content.append(label);

    // 顯示該圖層文字
    label.addEventListener('mouseenter', () => {
      label.parentElement.nextElementSibling.style.visibility = 'visible';
      label.parentElement.nextElementSibling.innerText = `${overlayerData[i]['name']}`;
      if(window.width<1200){
        $('#overlayer-layer-range').text(`(${overlayerData[i]['zoomMin']}-${overlayerData[i]['zoomMax']})`);
      }else{
        $('#overlayer-layer-range').text(`(${overlayerData[i]['zoomMin']}-${overlayerData[i]['zoomMax']})`);
      }
    });
    label.addEventListener('mouseleave', () => {
      label.parentElement.nextElementSibling.style.visibility = 'hidden';
      $('#overlayer-layer-range').text('');
    });

    editOpenLayer[overlayerData[i]['layerName']] = [true, overlayerData[i]['layerName'], overlayerData[i]['imgUrl'], overlayerData[i]['name'], 'overlay', i]
  }
  setOverlayListener();//增加監聽，確認自訂圖資開關後能被偵測
}
// createoverlayer();

//刪除用
function overLayerCtl(checkif,arrNum){
  if (checkif){
    // console.log(overlayerData[arrNum]['name'],overlayerData[arrNum]['dim'])
    addOverlayLayer(true, arrNum);
  }else{
    let i=map.getLayers().getArray();
    for (let j=0; j<i.length; j++) {if(i[j].get("name") && i[j].get("name")==overlayerData[arrNum]['layerName']) {map.removeLayer(i[j]); break;}}; 
  }
}

function getCheckOverlayer(){
  // if($('.mds-icon.mds-edit-layer').prev().prop('checked')) return ;// 如果開啟編輯模式，則不更新圖資
  let checkedLayers = $('#overlaycontent input:checked')
  if (checkedLayers.length>0){
    let mapZoom=map.getView().getZoom();
    let extent = map.getView().calculateExtent();
    let xy1 = ol.proj.toLonLat([extent[0],extent[1]])
    let xy2 = ol.proj.toLonLat([extent[2],extent[3]])

    for(let i=0;i<checkedLayers.length;i++){
      let num = checkedLayers[i].getAttribute('id').split('-')[1];
      let layer = map.getLayers().getArray().find(layer => layer.get('name') == `${overlayerData[num]['layerName']}`);
      let tmp = new ol.source.Vector({url: `https://gis.mlfd.gov.tw/rescue/getlayer/geojson?layer=${overlayerData[num]['layerName']}&x1=${xy1[0]}&y1=${xy1[1]}&x2=${xy2[0]}&y2=${xy2[1]}`,format: new ol.format.GeoJSON()})
      if (layer.get('name') == $('#editLayer').val() && $('.mds-icon.mds-edit-layer').prev().prop('checked') && modifySelectObj.getFeatures().getArray().length > 0){}
      else{
        if (overlayerData[num]['zoomMin']<=mapZoom && mapZoom<=overlayerData[num]['zoomMax']){//只set zoom範圍內
          let urlSource = {url: `${overlayerData[num]['url']}&x1=${xy1[0]}&y1=${xy1[1]}&x2=${xy2[0]}&y2=${xy2[1]}`, format: new ol.format.GeoJSON(), crossOrigin:'anonymous'}
          layer.setSource(tmp)
        }else{//超出zoom範圍則刪除
          layer.getSource().clear();
        }
      }
    }
  }
}
map.on('moveend',getCheckOverlayer);
/////////////------------------圖層套疊  END----------------------------------/////////////////

/////////////------------------環境資訊  START----------------------------------/////////////////
let rainfall = function (checkif, num){
  if(checkif){
    let cwbRainfall = new ol.layer.Vector({source:new ol.source.Vector(),renderMode:'vector',declutter:true, zIndex: 12, name: weatherInfo[num]['layerName'],properties: {'name':'envdata'}});		
    $.getJSON(weatherInfo[num]['url'], function (res) {
      let count = Object.keys(res.records.location).length;
      for (let i = 0; i < count; ++i) {
        let coordinates = ol.proj.fromLonLat([res.records.location[i].lon,res.records.location[i].lat,]);
        rainfallValue = parseFloat(res.records.location[i].weatherElement[0].elementValue).toFixed();
        if (rainfallValue === "-998" ||rainfallValue === "-999" ||rainfallValue === "0" ) {continue;} 
        else {
          cwbRainfall.getSource().addFeature(new ol.Feature({
            geometry:new ol.geom.Point(coordinates),
            name:res.records.location[i].stationId,// station id
            value:rainfallValue,
            time:res.records.location[i].time.obsTime,
            popupContent: 
            ` <div class="popupTable"><table><thead><tr><th colspan="2">${res.records.location[i].stationId}</th></tr></thead><tbody><tr><td style="width:50px;">雨量</td><td>${rainfallValue}mm</td></tr><tr><td>時間</td><td>${res.records.location[i].time.obsTime}</td></tr></tbody></table></div>`,
            popupWidth: 230,
          }));
        }
        cwbRainfall.setStyle(rainfallStyleFunction);
      }
      map.addLayer(cwbRainfall);
    });
	}
}
function rainfallStyleFunction(feature, resolution) {
  let setRadius;let setImageFill;let setImageStroke;
  if ((feature.get("value") > 0) & (feature.get("value") <= 20)) {setRadius = 17;setImageFill = "rgb(90, 255, 50)";}
  if ((feature.get("value") > 20) & (feature.get("value") <= 40)) {setRadius = 17;setImageFill = "rgba(255, 199, 0, 1)";}
  if (feature.get("value") > 40) {setRadius = 17;setImageFill = "rgba(255, 100, 50, 1)";}
  return new ol.style.Style({
    image: new ol.style.Icon({
      anchor: [0.5, 1],
      src: 'https://gis.fdkc.gov.tw/static/img/mapicon/weather/雨量站.png',
      scale: 0.3,
    }),
    text:new ol.style.Text({
      text:feature.get("value")+' mm',
      font:'900 20px "Arial,微軟正黑體,sans-serif"',
      fill:new ol.style.Fill({color:setImageFill}),
      stroke:new ol.style.Stroke({width:3,color:[0, 0, 0]}),
      padding:[-10, -2, -12, -20],
      textAlign:'center',
      offsetY: 5
    })
  });
}

// 地震
let earthquake = function(checkif, num){
  if(checkif){
    let cwbEarthquake = new ol.layer.Vector({source:new ol.source.Vector(),renderMode:'vector',declutter:true, zIndex: 12, name: weatherInfo[num]['layerName']});
    $.getJSON(weatherInfo[num]['url'], function (res) {
      earthquakeArr = res.records.Earthquake.length;
      for (let i = 0; i < earthquakeArr; i++) {
        let lon =res.records.Earthquake[i].EarthquakeInfo.Epicenter.EpicenterLongitude;
        let lat =res.records.Earthquake[i].EarthquakeInfo.Epicenter.EpicenterLatitude;
        let location = res.records.Earthquake[i].EarthquakeInfo.Epicenter.Location;
        let value = res.records.Earthquake[i].EarthquakeInfo.EarthquakeMagnitude.MagnitudeValue;//芮氏規模
        let time = res.records.Earthquake[i].EarthquakeInfo.OriginTime;
        let deep = res.records.Earthquake[i].EarthquakeInfo.FocalDepth;
        let note = res.records.Earthquake[i].ReportContent;
        let coordinates = ol.proj.fromLonLat([lon, lat]);
        cwbEarthquake.getSource().addFeature(new ol.Feature({
          geometry:new ol.geom.Point(coordinates),
          location:location,
          value:value,/*芮氏規模*/
          deep:deep,
          time:time,
          note:note,
          popupContent:`<div class="popupTable"><table><thead><tr><th colspan="4">${location.split('(')[0]}</th></tr></thead><tbody><tr><td style="width:60px;">芮氏規模</td><td>${value}</td><td>深度</td><td>${deep}km</tr><tr><td>內容</td><td colspan="3" style="text-align:left;">${note}</td></tr></tbody></table></div>`,
          popupWidth: 450,
        })); 
      }
      cwbEarthquake.setStyle(earthquakeStyleFunction);
      map.addLayer(cwbEarthquake);
    });
  }
}
function earthquakeStyleFunction(feature) {
	let data = feature.get('value').toString();
	let setTextColor='';
	if (Math.floor(feature.get('value')) < 3) {setTextColor = "#33FF34";}//#21CF42  33 207 66
	else if (Math.floor(feature.get('value')) == 3) {setTextColor = "#FFFE2F";}//254 210 58
  else if (Math.floor(feature.get('value')) == 4) {setTextColor = "#FE842E";} // 243 152 0
	else if (Math.floor(feature.get('value')) == 5) {setTextColor = "#FE5231";} // 255 0 0
  else if (Math.floor(feature.get('value')) >= 6) {setTextColor = "#B61EEB";} // 255 0 0
  else{setTextColor = "#000";}
	return new ol.style.Style({
    image: new ol.style.Icon({
      anchor: [0.5, 1],
      src: 'https://gis.fdkc.gov.tw/static/img/mapicon/weather/地震.png',
      scale: 0.3,
    }),
		text:new ol.style.Text({
      text:data,
      font:'900 20px "Arial,微軟正黑體,sans-serif"',
      fill:new ol.style.Fill({color:setTextColor}),
      stroke:new ol.style.Stroke({width:3,color:[0, 0, 0]}),
      padding:[-10, -2, -12, -20],
      textAlign:'center',
      offsetY: 5
    })
	});
}

// 氣象站
let tempStation = function(checkif, num) {
  // document.querySelector('.loadingBlock').style.display = 'flex';
  if(checkif){
    let tempStation = new ol.layer.Vector({source:new ol.source.Vector(),renderMode:'vector',declutter:true, zIndex: 12, name: weatherInfo[num]['layerName']});
    $.getJSON(weatherInfo[num]['url'], function (res) {
      let count = Object.keys(res.records.location).length;
      for (let i = 0; i < count; ++i) {
        let coordinates = ol.proj.fromLonLat([res.records.location[i].lon,res.records.location[i].lat,]);
        if (res.records.location[i].weatherElement[2].elementValue == "-99") {continue;} 
        else {tempStation.getSource().addFeature(new ol.Feature({
          geometry:new ol.geom.Point(coordinates),
          name:res.records.location[i].stationId,/*station id*/
          value:res.records.location[i].weatherElement[2].elementValue, /*weather temp*/
          time:res.records.location[i].time.obsTime,
          district:res.records.location[i].locationName,unit:'°C',
          popupContent:`<div class="popupTable"><table><thead><tr><th colspan="2">${res.records.location[i].stationId}</th></tr></thead><tbody><tr><td>溫度</td><td>${res.records.location[i].weatherElement[2].elementValue}°C</td></tr><tr><td>時間</td><td>${res.records.location[i].time.obsTime}</td></tr></tbody></table></div>`,
          popupWidth: 200,
        }));
        tempStation.setStyle(tempStyleFunction);}
      }
    });
    map.addLayer(tempStation);
    // document.querySelector('.loadingBlock').style.display = 'none';
  }
}
function tempStyleFunction(feature, resolution) {
  let setRadius;let setImageFill;let setImageStroke;
  if (feature.get("value") < 20) {setRadius = 17;setImageFill = "rgb(90, 255, 50)";}//rgb(90, 255, 50)rgb(146, 208, 80)
  if ((feature.get("value") >= 20) & (feature.get("value") <= 29)) {setRadius = 17;setImageFill = "rgba(255, 199, 0, 1)";}
  if (feature.get("value") > 29) {setRadius = 17;setImageFill = "rgba(255, 100, 0)";}//rgba(255, 100, 100)
  return new ol.style.Style({
    image: new ol.style.Icon({
      anchor: [0.5, 1],
      src: 'https://gis.fdkc.gov.tw/static/img/mapicon/weather/氣象站.png',
      scale: 0.3,
    }),
    text:new ol.style.Text({
      text:feature.get("value")+' °C',
      font:pointFontSize,fill:new ol.style.Fill({color:setImageFill}),
      stroke:new ol.style.Stroke({width:3,color:[0, 0, 0]}),
      padding:[-10, -2, -12, -20],
      textAlign:'center',
      offsetY: 5
    })
  });
}

// 鄉鎮天氣
let countryWeather = function (checkif, num){
  if(checkif){
    let cwbCityWeekForecast = new ol.layer.Vector({source:new ol.source.Vector(),renderMode:'vector',declutter:true, zIndex: 12, name: weatherInfo[num]['layerName']});
    $.getJSON(weatherInfo[num]['url'],function(res){
      for (let i = 0; i < res.records.locations.length; i++) {
        for(let y =0;y<res.records.locations[i].location.length;y++){
          let lon = res.records.locations[i].location[y].lon;
          let lat = res.records.locations[i].location[y].lat;
          let coordinates = ol.proj.fromLonLat([lon, lat]);
          cwbCityWeekForecast.getSource().addFeature(new ol.Feature({
            geometry:new ol.geom.Point(coordinates),
            locationName:res.records.locations[i].location[y].locationName,
            time1:res.records.locations[i].location[y].weatherElement[0].time[1].dataTime,
            value1:res.records.locations[i].location[y].weatherElement[0].time[1].elementValue[0].value,
            popupContent:`<div class="popupTable"><table><thead><tr><th colspan="2">${res.records.locations[i].location[y].locationName}</th></tr></thead><tbody><tr><td>風速</td><td>${res.records.locations[i].location[y].weatherElement[0].time[1].elementValue[0].value} m/s</td></tr><tr><td>時間</td><td>${res.records.locations[i].location[y].weatherElement[0].time[1].dataTime.substr(0, 19)}</td></tr></tbody></table></div>`,
            popupWidth: 200
          }));
        }
      }
      cwbCityWeekForecast.setStyle(cityWeekForcastStyleFunction);
      map.addLayer(cwbCityWeekForecast);
    })
  }
}
function cityWeekForcastStyleFunction(feature) {
  let setRadius;let setImageFill;let setImageStroke;
	if ((feature.get("value1") >= 0) & (feature.get("value1") <=1)) {setImageFill = "rgb(90, 255, 50)";}//rgb(90, 255, 50)rgb(146, 208, 80)
	else if ((feature.get("value1") > 1) & (feature.get("value1") <= 3)) {setImageFill = "rgb(255, 199, 0)";}
	else if (feature.get("value1") > 3) {setImageFill = "rgba(255, 100, 100)";}
  else{setImageFill = "rgba(255, 100, 100)";}
	return new ol.style.Style({
    image: new ol.style.Icon({
      anchor: [0.5, 1],
      src: 'https://gis.fdkc.gov.tw/static/img/mapicon/weather/天氣預報.png',
      scale: 0.3,
    }),
		text:new ol.style.Text({
      text:feature.get("value1")+' m/s',
      font:pointFontSize,
      fill:new ol.style.Fill({color:setImageFill}),
      stroke:new ol.style.Stroke({width:3,color:[0, 0, 0]}),
      padding:[-10, -2, -12, -20],
      textAlign:'center',
      offsetY: 5
    })
	});
}

// 降雨預報 未來一小時 (CORS問題)
let rainfallForecast = function (checkif, num){
  let coordRange = [118,20,123.5,27]
  let rainfallForecaseLayer = new ol.layer.Image({
    source: new ol.source.ImageStatic({url: "https://winfo.tycg.gov.tw/GetQpeSumRain/image/Tmp.gif",imageExtent: ol.extent.applyTransform([118, 20, 123.5, 27],ol.proj.getTransform("EPSG:4326", "EPSG:3857"))}),name: weatherInfo[num]['layerName'],zIndex:12,
  })
  map.addLayer(rainfallForecaseLayer);
}

// 潮汐預報
let seaTideLoc = {} // 位置
let seaTideForecast = function (checkif, num){
  // document.querySelector('.loadingBlock').style.display = 'flex';
  $.getJSON('https://gis.fdkc.gov.tw/static/geosource/A0021-001.json', function(locRes){//取得座標
    for (let i=0;i<locRes.length;i++){// 儲存座標，因氣象局另外給資料
      seaTideLoc[locRes[i]['locationName']] = {'lon': locRes[i]['longitude'],'lat': locRes[i]['latitude']}
    }
    $.getJSON('/extweb/opendatacwb/api/v1/rest/datastore/F-A0021-001?Authorization=CWB-326DAE79-B70E-4DD3-BC36-07B077E82CAB&format=JSON&elementName=1%E6%97%A5%E6%BD%AE%E6%B1%90&sort=dataTime&timeFrom=2022-12-20T00%3A00%3A00&timeTo=2022-12-21T00%3A00%3A00', function(opendataRes){//取得data
      // console.log(opendataRes);
      let seaTideLayer = new ol.layer.Vector({source:new ol.source.Vector(),renderMode:'vector',declutter:true, zIndex: 12, name: weatherInfo[num]['layerName'],style:new ol.style.Style({image:new ol.style.Icon(({anchor:[0.5,46],anchorXUnits:"fraction",anchorYUnits:"pixels",src: `${weatherInfo[num]['imgUrl']}`,scale:0.25}))}) });
      let locNum = opendataRes.records.location //總共多少地區
      for (let i=0;i<locNum.length;i++){
        let locName = opendataRes.records.location[i].locationName;
        if (locName in seaTideLoc){
          let coordinates = ol.proj.fromLonLat([seaTideLoc[locName]['lon'], seaTideLoc[locName]['lat']]);
          let feature = new ol.Feature({geometry:new ol.geom.Point(coordinates),name:opendataRes.records.location[i].locationName})
          let tmp="";
          if(opendataRes.records.location[i].validTime.length>0){
            for (let y=0;y<opendataRes.records.location[i].validTime[0].weatherElement[0].time.length;y++){
              tmp += `<span>${opendataRes.records.location[i].validTime[0].weatherElement[0].time[y]['dataTime']}</span><br><span>${opendataRes.records.location[i].validTime[0].weatherElement[0].time[y]['parameter'][1]['parameterValue']}</span><br>`;  
            }
            feature.setProperties({'value': tmp})
            seaTideLayer.getSource().addFeature(feature);
          }
        }
      }
      map.addLayer(seaTideLayer);
    })
  })
}

// 淹水警戒
let floodAlert = function (checkif ,num){
  // document.querySelector('.loadingBlock').style.display = 'flex';
  if (checkif){
    map.addLayer(new ol.layer.Vector({source:new ol.source.Vector({url: weatherInfo[num]['url'], format: new ol.format.KML(),crossOrigin:'anonymous'}),zIndex:11,name: weatherInfo[num]['layerName'], declutter: true }));
  }
}

// 颱風特報
let typephoon = function (checkif, num){
  if (checkif) {
    map.addLayer(new ol.layer.Vector({source:new ol.source.Vector({url:"https://odbpo.oc.ntu.edu.tw/static/figs/cwbdata/fifows_wsp.kml",format:new ol.format.KML(),crossOrigin:'anonymous'}),zIndex:11,name:'dgdptyphoon2'}));
    map.addLayer(new ol.layer.Vector({source:new ol.source.Vector({url:"https://odbpo.oc.ntu.edu.tw/static/figs/cwbdata/fifows_typhoon.kml",format:new ol.format.KML(),crossOrigin:'anonymous'}),zIndex:12,name:'dgdptyphoon1'}));
  }else{
    let i=map.getLayers().getArray();
    for (let ii=1; ii<=2; ii++) { 
      for (let j=0; j<i.length; j++) {
        if(i[j].get("name") && i[j].get("name")=='dgdptyphoon'+ii) {map.removeLayer(i[j]); break;}
      }; 
    };
  }
}

// 土石流潛勢
let rockslide = function (checkif, num){
  if(checkif){
    map.addLayer(new ol.layer.Tile({source:new ol.source.XYZ({url: weatherInfo[num]['url'],crossOrigin:'anonymous',maxZoom: 20}),zIndex:3,name: weatherInfo[num]['layerName']}));
  }
}

// 地質敏感
let sensitive = function (checkif, num){
  if(checkif){
    map.addLayer(new ol.layer.Tile({source:new ol.source.XYZ({url: weatherInfo[num]['url'],crossOrigin:'anonymous',maxZoom: 20}),zIndex:3,name: weatherInfo[num]['layerName']}));
  }
}

// 氣象雷達
let cwbanim;
let weatherRadar = function (checkif, num){
  clearInterval(cwbanim); 
  if (checkif) {
    let wind = new ol.layer.Image({zIndex:20, name: 'test',name: weatherInfo[num]['layerName']});
    let windfig=new Array();
    wind.setSource(new ol.source.ImageStatic({url:"https://odbpo.oc.ntu.edu.tw/static/figs/cwbdata/R"+"22.png",projection:'EPSG:3857',crossOrigin:'anonymous',imageExtent:ol.proj.transformExtent([115,17.75,126.5,29.25],'EPSG:4326','EPSG:3857')}));
    for (let i=10; i<=22; i++) {
      windfig[i-10]=new ol.source.ImageStatic({url:"https://odbpo.oc.ntu.edu.tw/static/figs/cwbdata/R"+i+".png",projection:'EPSG:3857',crossOrigin:'anonymous',imageExtent:ol.proj.transformExtent([115,17.75,126.5,29.25],'EPSG:4326','EPSG:3857')});
    };
    cwbanim=setInterval(function() {
      let i=wind.getSource().getUrl().substr(49,2)-1; 
      i=(i>=10)?i:22; wind.setSource(windfig[i-10]); wind.changed(); 
    },350);
    map.addLayer(wind);
  }
}

// 字體
let pointFontSize = '900 20px "Arial,微軟正黑體,sans-serif"'
// 環境資訊
/*
let weatherInfo=[
  {'name': "雨量站", "layerName": "env-rainfallstationLayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/雨量站.png", "url": "https://opendata.cwb.gov.tw/api/v1/rest/datastore/O-A0002-001?Authorization=CWB-326DAE79-B70E-4DD3-BC36-07B077E82CAB&elementName=MIN_10&parameterName=CITY,TOWN", "type": "function" , "function": rainfall},
  {'name': "地震", "layerName": "env-earthquakeLayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/地震.png", "url": "https://opendata.cwb.gov.tw/api/v1/rest/datastore/E-A0015-001?Authorization=CWB-326DAE79-B70E-4DD3-BC36-07B077E82CAB&areaName=%E5%AE%9C%E8%98%AD%E7%B8%A3,%E8%8A%B1%E8%93%AE%E7%B8%A3,%E8%87%BA%E6%9D%B1%E7%B8%A3,%E6%BE%8E%E6%B9%96%E7%B8%A3,%E9%87%91%E9%96%80%E7%B8%A3,%E9%80%A3%E6%B1%9F%E7%B8%A3,%E8%87%BA%E5%8C%97%E5%B8%82,%E6%96%B0%E5%8C%97%E5%B8%82,%E6%A1%83%E5%9C%92%E5%B8%82,%E8%87%BA%E4%B8%AD%E5%B8%82,%E8%87%BA%E5%8D%97%E5%B8%82,%E9%AB%98%E9%9B%84%E5%B8%82,%E5%9F%BA%E9%9A%86%E5%B8%82,%E6%96%B0%E7%AB%B9%E7%B8%A3,%E6%96%B0%E7%AB%B9%E5%B8%82,%E8%8B%97%E6%A0%97%E7%B8%A3,%E5%BD%B0%E5%8C%96%E7%B8%A3,%E5%8D%97%E6%8A%95%E7%B8%A3,%E9%9B%B2%E6%9E%97%E7%B8%A3,%E5%98%89%E7%BE%A9%E7%B8%A3,%E5%98%89%E7%BE%A9%E5%B8%82,%E5%B1%8F%E6%9D%B1%E7%B8%A3", "type": "kml", "function": earthquake},
  {'name': "氣象站", "layerName": "env-weatherTmplayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/氣象站.png", "url": "https://opendata.cwb.gov.tw/api/v1/rest/datastore/O-A0001-001?Authorization=CWB-326DAE79-B70E-4DD3-BC36-07B077E82CAB&elementName=WDIR,WDSD,TEMP,HUMD,H_24R,PRES,D_TXT,D_TX,D_TNT,D_TN&parameterName%EF%BC%8C=CITY,TOWN", "type": "pointkml", 'function': tempStation},
  {'name': "鄉鎮預報", "layerName": "env-countryForcastlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/天氣預報.png", "url": "https://opendata.cwb.gov.tw/api/v1/rest/datastore/F-D0047-093?Authorization=CWB-326DAE79-B70E-4DD3-BC36-07B077E82CAB&locationId=F-D0047-001,F-D0047-005,F-D0047-009,F-D0047-013,F-D0047-017,F-D0047-021,F-D0047-025,F-D0047-029,F-D0047-033,F-D0047-037,F-D0047-041,F-D0047-045,F-D0047-049,F-D0047-053,F-D0047-057,F-D0047-061,F-D0047-065,F-D0047-069,F-D0047-073,F-D0047-077,F-D0047-081,F-D0047-085,F-D0047-089&elementName=WS", "type": "json", 'function': countryWeather},
  {'name': "降雨預報", "layerName": "env-rainfallForecastlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/降雨預報.png", "url": "https://bear.emic.gov.tw/BearBack/uploadFile/mmLayer/kml/步道.kml", "type": "png", 'function': rainfallForecast},
  {'name': "潮汐預報", "layerName": "env-seaTideForecastlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/潮汐預報.png", "url": "https://bear.emic.gov.tw/BearBack/uploadFile/mmLayer/kml/步道.kml", "type": "json", 'function': seaTideForecast},
  {'name': "颱風特報", "layerName": "env-dgdptyphoonlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/颱風.png", "url": "https://bear.emic.gov.tw/BearBack/uploadFile/mmLayer/kml/步道.kml", "type": "kml", 'function': typephoon},
  {'name': "土石潛勢", "layerName": "env-rockslidelayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/土石潛勢.png", "url": "https://wmts.nlsc.gov.tw/wmts/MUDSLIDE_PG/default/EPSG:3857/{z}/{y}/{x}", "type": "tile", 'function': rockslide},
  {'name': "地質敏感", "layerName": "env-sensitivelayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/地質敏感.png", "url": "https://wmts.nlsc.gov.tw/wmts/GeoSensitive/default/EPSG:3857/{z}/{y}/{x}", "type": "tile", 'function': sensitive},
  {'name': "氣象雷達", "layerName": "env-weatherradarlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/氣象雷達.png", "url": "", "type": "image", 'function': weatherRadar},
];
*/
let weatherInfo=[
  {'name': "雨量站", "layerName": "env-rainfallstationLayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/雨量站.png", "url": "https://gis.fdkc.gov.tw/extweb/opendatacwb/api/v1/rest/datastore/O-A0002-001?Authorization=CWB-326DAE79-B70E-4DD3-BC36-07B077E82CAB&elementName=MIN_10&parameterName=CITY,TOWN", "type": "function" , "function": rainfall},
  {'name': "地震", "layerName": "env-earthquakeLayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/地震.png", "url": "https://gis.fdkc.gov.tw/extweb/opendatacwb/api/v1/rest/datastore/E-A0015-001?Authorization=CWB-326DAE79-B70E-4DD3-BC36-07B077E82CAB&areaName=%E5%AE%9C%E8%98%AD%E7%B8%A3,%E8%8A%B1%E8%93%AE%E7%B8%A3,%E8%87%BA%E6%9D%B1%E7%B8%A3,%E6%BE%8E%E6%B9%96%E7%B8%A3,%E9%87%91%E9%96%80%E7%B8%A3,%E9%80%A3%E6%B1%9F%E7%B8%A3,%E8%87%BA%E5%8C%97%E5%B8%82,%E6%96%B0%E5%8C%97%E5%B8%82,%E6%A1%83%E5%9C%92%E5%B8%82,%E8%87%BA%E4%B8%AD%E5%B8%82,%E8%87%BA%E5%8D%97%E5%B8%82,%E9%AB%98%E9%9B%84%E5%B8%82,%E5%9F%BA%E9%9A%86%E5%B8%82,%E6%96%B0%E7%AB%B9%E7%B8%A3,%E6%96%B0%E7%AB%B9%E5%B8%82,%E8%8B%97%E6%A0%97%E7%B8%A3,%E5%BD%B0%E5%8C%96%E7%B8%A3,%E5%8D%97%E6%8A%95%E7%B8%A3,%E9%9B%B2%E6%9E%97%E7%B8%A3,%E5%98%89%E7%BE%A9%E7%B8%A3,%E5%98%89%E7%BE%A9%E5%B8%82,%E5%B1%8F%E6%9D%B1%E7%B8%A3", "type": "kml", "function": earthquake},
  {'name': "氣象站", "layerName": "env-weatherTmplayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/氣象站.png", "url": "https://gis.fdkc.gov.tw/extweb/opendatacwb/api/v1/rest/datastore/O-A0001-001?Authorization=CWB-326DAE79-B70E-4DD3-BC36-07B077E82CAB&elementName=WDIR,WDSD,TEMP,HUMD,H_24R,PRES,D_TXT,D_TX,D_TNT,D_TN&parameterName%EF%BC%8C=CITY,TOWN", "type": "pointkml", 'function': tempStation},
  {'name': "鄉鎮預報", "layerName": "env-countryForcastlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/天氣預報.png", "url": "https://gis.fdkc.gov.tw/extweb/opendatacwb/api/v1/rest/datastore/F-D0047-093?Authorization=CWB-326DAE79-B70E-4DD3-BC36-07B077E82CAB&locationId=F-D0047-001,F-D0047-005,F-D0047-009,F-D0047-013,F-D0047-017,F-D0047-021,F-D0047-025,F-D0047-029,F-D0047-033,F-D0047-037,F-D0047-041,F-D0047-045,F-D0047-049,F-D0047-053,F-D0047-057,F-D0047-061,F-D0047-065,F-D0047-069,F-D0047-073,F-D0047-077,F-D0047-081,F-D0047-085,F-D0047-089&elementName=WS", "type": "json", 'function': countryWeather},
  {'name': "降雨預報", "layerName": "env-rainfallForecastlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/降雨預報.png", "url": "https://gis.fdkc.gov.tw/extweb/bearemic/BearBack/uploadFile/mmLayer/kml/步道.kml", "type": "png", 'function': rainfallForecast},
  {'name': "潮汐預報", "layerName": "env-seaTideForecastlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/潮汐預報.png", "url": "https://gis.fdkc.gov.tw/extweb/bearemic/BearBack/uploadFile/mmLayer/kml/步道.kml", "type": "json", 'function': seaTideForecast},
  // {'name': "淹水警戒", "layerName": "env-floodAlertlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/淹水警戒.png", "url": "http://fhy.wra.gov.tw/pub_web_2011/kml/KmlShare/NewstFloodWarm.kml", "type": "kml", 'function': floodAlert},
  {'name': "颱風特報", "layerName": "env-dgdptyphoonlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/颱風.png", "url": "https://gis.fdkc.gov.tw/extweb/bearemic/BearBack/uploadFile/mmLayer/kml/步道.kml", "type": "kml", 'function': typephoon},
  {'name': "土石潛勢", "layerName": "env-rockslidelayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/土石潛勢.png", "url": "https://gis.fdkc.gov.tw/extweb/wmtsnlsc/wmts/MUDSLIDE_PG/default/EPSG:3857/{z}/{y}/{x}", "type": "tile", 'function': rockslide},
  {'name': "地質敏感", "layerName": "env-sensitivelayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/地質敏感.png", "url": "https://gis.fdkc.gov.tw/extweb/wmtsnlsc/wmts/GeoSensitive/default/EPSG:3857/{z}/{y}/{x}", "type": "tile", 'function': sensitive},
  {'name': "氣象雷達", "layerName": "env-weatherradarlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/weather/氣象雷達.png", "url": "", "type": "image", 'function': weatherRadar},
];
//產出地圖工具按鈕
function createWeather(){
  let content = document.querySelector('#weathercontent');
  for (let i=0;i<weatherInfo.length;i++){
    let label = document.createElement('label');label.setAttribute('class','item');
    label.innerHTML = `
    <input type="checkbox" id="weather-${i}" onchange="legendBtn(this.checked, '${weatherInfo[i]['layerName']}', '${weatherInfo[i]['imgUrl']}', '${weatherInfo[i]['name']}', 'weather', '${i}'); weatherLayerCtl(this.checked, ${i})" >
    <div class="iconContent">
      <div class="name">${weatherInfo[i]['name']}</div>
      <img src="https://bot.mds.com.tw/webdemo/gis119wei/${weatherInfo[i]['imgUrl']}">
    </div>
    <span class="tooltiptext">${weatherInfo[i]['name']}</span>`;
    content.append(label);
    
    // 顯示該圖層文字
    label.addEventListener('mouseenter', () => {
      label.parentElement.nextElementSibling.style.visibility = 'visible';
      label.parentElement.nextElementSibling.innerText = `${weatherInfo[i]['name']}`
    });
    label.addEventListener('mouseleave', () => {
      label.parentElement.nextElementSibling.style.visibility = 'hidden';
    });
  }
}
// 加入圖層checkif, layerName, imgUrl, type
function weatherLayerCtl(checkif,arrNum){
  if (checkif){
    weatherInfo[arrNum]['function'](true, arrNum);
  }else{
    let i=map.getLayers().getArray();
    if (weatherInfo[arrNum]['layerName'].indexOf('dgdptyphoon')>=0){// 颱風相關
      for (let ii=1; ii<=2; ii++) { 
        for (let j=0; j<i.length; j++) {
          if(i[j].get("name") && i[j].get("name")=='dgdptyphoon'+ii) {map.removeLayer(i[j]); break;}
        }; 
      };
    }else{
      for (let j=0; j<i.length; j++) {
        if(i[j].get("name") && i[j].get("name")==weatherInfo[arrNum]['layerName']) {map.removeLayer(i[j]); break;}
      }; 
    }
  }
}
createWeather();
/////////////------------------環境資訊  END----------------------------------/////////////////

/////////////------------------EMIC  START----------------------------------/////////////////
// EMIC 相關 function start
let getcctvdata = function(checkif, num){
  if (checkif){
    let cctvlayer = new ol.layer.Vector({source:new ol.source.Vector(),renderMode:'vector', zIndex: 12, style:new ol.style.Style({image:new ol.style.Icon(({anchor:[0.5,46],anchorXUnits:"fraction",anchorYUnits:"pixels",src:`${emicLayerData[num]['imgUrl']}`,scale:0.25, }))}),name:`${emicLayerData[num]['layerName']}`});	
    // document.querySelector('.loadingBlock').style.display = 'flex';
    $.ajax({url:"https://gis.fdkc.gov.tw/static/geosource/201.kml",type: "GET",timeout: 1000,
      error: function(xml){alert("讀取xml錯誤"+xml);},
      success: function(xml){
        cctvlayer.getSource().clear();
        let placemarks = $(xml).find("Placemark");
        for (let i=0; i<placemarks.length; i++){
          let coordinateArr = $(placemarks[i]).find("coordinates").text().split(",");
          let coordinates = ol.proj.fromLonLat([coordinateArr[0], coordinateArr[1]]);
          cctvlayer.getSource().addFeature(new ol.Feature({geometry:new ol.geom.Point(coordinates),name: $(placemarks[i]).find("name").text(),stream: $(placemarks[i]).find("description").text()
          }));
        }
        // document.querySelector('.loadingBlock').style.display = 'none';
      }
    })
    map.addLayer(cctvlayer);
  }else{
    document.querySelector('.cctvBox').style.left = '-400px';
  }
}
// point相關
let emicKmlPointLayer = function (checkif, num){
  if (checkif){
    map.addLayer(new ol.layer.Vector({source:new ol.source.Vector({url: emicLayerData[num]['url'], format:new ol.format.KML({extractStyles: false}),crossOrigin:'anonymous'}),zIndex:11,name:`${emicLayerData[num]['layerName']}`, declutter: true, style:new ol.style.Style({image:new ol.style.Icon(({anchor:[0.5,46],anchorXUnits:"fraction",anchorYUnits:"pixels",src: `${emicLayerData[num]['imgUrl']}`,scale:0.25}))}) }));
  }
}
// line相關
let emicKmlLineLayer = function (checkif, num){
  if (checkif){
    map.addLayer(new ol.layer.Vector({source:new ol.source.Vector({url: emicLayerData[num]['url'], format:new ol.format.KML(),crossOrigin:'anonymous'}),zIndex:11,name:  emicLayerData[num]['layerName'], declutter: true }));
  }
}
// tile相關 
let emicTileLayer = function(checkif, num){
  if(checkif){
    map.addLayer(new ol.layer.Tile({zIndex:50, source: new ol.source.XYZ({url: emicLayerData[num]['url'],crossOrigin:'anonymous'}), name: emicLayerData[num]['layerName']}));
  }
}
// EMIC 相關 function end

// EMIC data
let emicLayerData=[
  {'name': "CCTV", "layerName": "emiccctvlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/cctv.png", "url": "", "type": "function" , 
  "function": getcctvdata},
  {'name': "開放釣點", "layerName": "emichooklayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/hook.png", "url": "https://gis.fdkc.gov.tw/extweb/bearemic/BearBack/uploadFile/mmLayer/kml/%E5%85%A8%E5%8F%B0%E9%96%8B%E6%94%BE%E9%87%A3%E9%BB%9E%E4%BD%8D%E7%BD%AE.kml", "type": "kml", "function": emicKmlPointLayer},
  {'name': "步道", "layerName": "emictraillayer", "imgUrl":"/static/img/mapicon/emic/trail.png", "url": "/extweb/bearemic/BearBack/uploadFile/mmLayer/kml/步道.kml", "type": "pointkml", 'function': emicKmlLineLayer},
  {'name': "活動斷層", "layerName": "emicfaultlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/clip.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/EMICDataStatic/%E6%B4%BB%E5%8B%95%E6%96%B7%E5%B1%A4.kml", "type": "linekml", "function": emicKmlLineLayer},
  {'name': "崩塌潛勢", "layerName": "emicrisklayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/崩塌潛勢.png", "url": "https://gis.fdkc.gov.tw/extweb/bearemic/BearBack/uploadFile/mmLayer/kml/水保局大規模崩塌淺勢區.kml", "type": "kml", "function": emicKmlLineLayer},
  {'name': "戰時收容所", "layerName": "emicwartmplayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/war_tmp.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/emict/modules/easymap/services/proxy.aspx?url=http://localhost/EMICData/157.kml", "type": "pointkml", "function": emicKmlPointLayer},
  {'name': "異常波浪", "layerName": "emicwaveissuelayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/異常波浪.png", "url": "https://gis.fdkc.gov.tw/extweb/easymap/mymap/crawler/ocean_cwb_wave.php", "type": "kml", "function": emicKmlLineLayer},
  {'name': "地震", "layerName": "emicearthquakelayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/地震.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/EMICData/182.kml", "type": "kml", "function": emicKmlPointLayer},
  {'name': "土石流潛勢溪", "layerName": "emiclandslidelayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/土石流潛勢溪.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/emict/uploadFile/mmlayer/kml/debrisarea.kml", "type": "kml", "function": emicKmlLineLayer},
  {'name': "Google路況", "layerName": "emicroadstatuslayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/road2.png", "url": "/extweb/mts0google/vt?hl=zh-TW&src=app&x={x}&y={y}&z={z}&s=Galil&lyrs=h@248149186,traffic|seconds_into_week:-1&style=15", "type": "tile", "function": emicTileLayer},
  {'name': "應變城市", "layerName": "emicresponsecitylayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/應變城市.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/emict/modules/easymap/services/proxy.aspx?url=http://localhost/EMIC_Transfer/WebService/WSTransfer.ashx[question]op=GET[and]SN=195[and]key=2BE8FD2FEEAEF1AB[and]F1=", "type": "kml", "function": emicKmlLineLayer},
  {'name': "災情", "layerName": "emicriskloclayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/災情.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/emict/modules/easymap/services/proxy.aspx?url=http://localhost/EMIC_Transfer/WebService/WSTransfer.ashx[question]op=GET[and]SN=372[and]key=A517BF73C90519F6[and]F1=2022-11-30%2000:00:00[and]F2=2022-11-30%2023:59:59[and]F3=[and]F4=[and]F5=", "type": "kml", "function": emicKmlPointLayer},
  {'name': "聯外孤島", "layerName": "emicisolatedlinklayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/聯外孤島.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/emict/modules/easymap/services/proxy.aspx?url=http://localhost/EMIC_Transfer/WebService/WSTransfer.ashx[question]op=GET[and]SN=411[and]key=9BF5E5083CC2705E[and]F1=[and]F2=", "type": "kml", "function": emicKmlLineLayer},
  {'name': "交通阻斷", "layerName": "emictrafficblocklayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/交通阻斷.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/emict/modules/easymap/services/proxy.aspx?url=http://localhost/EMICData/183.kml", "type": "kml", "function": emicKmlPointLayer},
  {'name': "孤島整備", "layerName": "emicisolatedprelayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/孤島整備.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/emict/modules/easymap/services/proxy.aspx?url=http://localhost/EMIC_Transfer/WebService/WSTransfer.ashx[question]op=GET[and]SN=412[and]key=602EF1456B05A628[and]F1=%27%27[and]F2=%27%27", "type": "kml", "function": emicKmlPointLayer},
  {'name': "水庫範圍", "layerName": "emicreservoirrangelayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/水庫範圍.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/emict/modules/easymap/services/proxy.aspx?url=http://localhost/EMICT/uploadFile/mmlayer/kml/%E6%B0%B4%E5%BA%AB.kml", "type": "kml", "function": emicKmlLineLayer},
  {'name': "縣市河川", "layerName": "emiccityriverlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/縣市河川.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/emict/modules/easymap/services/proxy.aspx?url=http://localhost/EMICData/211.kml", "type": "kml", "function": emicKmlPointLayer},
  {'name': "中央管河川", "layerName": "emiccenterriverlayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/中央管河川.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/emict/modules/easymap/services/proxy.aspx?url=http://localhost/EMICData/216.kml", "type": "kml", "function": emicKmlPointLayer},
  {'name': "水庫資訊", "layerName": "emicreservoirinfolayer", "imgUrl":"https://gis.fdkc.gov.tw/static/img/mapicon/emic/水庫資訊.png", "url": "https://gis.fdkc.gov.tw/extweb/gis2emic/emict/modules/easymap/services/proxy.aspx?url=http://localhost/EMICData/152.kml", "type": "kml", "function": emicKmlPointLayer},
];
//產出EMIC按鈕
function createEmicLayer(){
  let content = document.querySelector('#emiccontent');
  for (let i=0;i<emicLayerData.length;i++){
    let label = document.createElement('label');label.setAttribute('class','item');
    label.innerHTML = `
    <input type="checkbox" id="emic-${i}" onchange="legendBtn(this.checked, '${emicLayerData[i]['layerName']}', '${emicLayerData[i]['imgUrl']}', '${emicLayerData[i]['name']}', 'emic', ${i}); emicLayerCtl(this.checked, ${i});" >
    <div class="iconContent">
      <div class="name">${emicLayerData[i]['name']}</div>
      <img src="https://bot.mds.com.tw/webdemo/gis119wei/${emicLayerData[i]['imgUrl']}">
    </div>
    <span class="tooltiptext">${emicLayerData[i]['name']}</span>`;
    content.append(label);

    // 顯示該圖層文字
    label.addEventListener('mouseenter', () => {
      label.parentElement.nextElementSibling.style.visibility = 'visible';
      label.parentElement.nextElementSibling.innerText = `${emicLayerData[i]['name']}`
    });
    label.addEventListener('mouseleave', () => {
      label.parentElement.nextElementSibling.style.visibility = 'hidden';
    });
  }
}
// 加入圖層checkif, layerName, imgUrl, type
function emicLayerCtl(checkif,arrNum){
  // console.log(emicLayerData[arrNum]['layerName'])
  if (checkif){
    emicLayerData[arrNum]['function'](true, arrNum);
  }else{
    // console.log(arrNum);
    emicLayerData[arrNum]['function'](false, arrNum);
    let i=map.getLayers().getArray();
    for (let j=0; j<i.length; j++) {
      if(i[j].get("name") && i[j].get("name")==emicLayerData[arrNum]['layerName']) {map.removeLayer(i[j]); break;}
    }; 
  }
}

createEmicLayer();//產出EMIC按鈕
/////////////------------------EMIC  END----------------------------------/////////////////

/////////////------------------淹水資訊  START----------------------------------/////////////////
// 淹水潛勢圖
function getfloodpotential(checkif){
  if(checkif){
    let hour = document.getElementById('floodpothr').value;
    let deep =  document.getElementById('floodpotmm').value;
    floodpotential.setSource(new ol.source.XYZ({url:`https://giso.emic.gov.tw/EMICDataStatic/EMIC_CACHE/${hour}H/${deep}M/GoogleTile/Png/{z}/{x}/z{z}x{x}y{y}.png`,crossOrigin:'anonymous'}));
    floodpotential.setVisible(true);
  }else{
    floodpotential.setVisible(false);
  }
}
// 修正淹水潛勢對應毫米
function checkfloodpotOption(){
  let select = document.getElementById('floodpotmm');
  let optionValue = document.getElementById('floodpothr').value;//取得小時數
  let options = document.querySelectorAll('#floodpotmm option');//刪除原本的選項
  options.forEach(element => {element.remove();})
  let timeArr=[];
  if (optionValue == '6'){timeArr = ['150','250','350'];}
  else if (optionValue == '12'){timeArr = ['200','300','400'];}
  else if (optionValue == '24'){timeArr = ['200','350','500','650'];}
  timeArr.forEach(element => {
    let option = document.createElement('option');
    option.setAttribute('value', element);
    option.innerText = element;
    select.append(option);
  });
  getfloodpotential(document.getElementById('switch-flood').checked);
}

// 定量降雨淹水預測
function getqpeflood(checkif){
  let i=map.getLayers().getArray();
  if (checkif) {
    let hour = document.getElementById('qpefloodhr').value;
    let deep =  document.getElementById('qpefloodmm').value;
    for (let j=0; j<i.length; j++) {if(i[j].get("name") && i[j].get("name").indexOf(`qpeflood`)>=0) {map.removeLayer(i[j]); break;}}; 
    map.addLayer(new ol.layer.Vector({source:new ol.source.Vector({url:`https://gis.fdkc.gov.tw/extweb/gis2emic/emict/modules/easymap/services/proxy.aspx?url=https://giso.emic.gov.tw/emicm/webpages/QpeFloodKML.aspx[question]HrType=${hour}[and]RainType=${deep}[and]KMLType=0`,format:new ol.format.KML(),crossOrigin:'anonymous'}),zIndex:11,name:`qpeflood${hour}H${deep}mm`}));
  } else {
    for (let j=0; j<i.length; j++) {if(i[j].get("name") && i[j].get("name").indexOf(`qpeflood`)>=0) {map.removeLayer(i[j]); break;}}; 
  };
}
// 修正定量降雨淹水預測對應毫米
function checkQpeOption(){
  let select = document.getElementById('qpefloodmm');
  let optionValue = document.getElementById('qpefloodhr').value;//取得小時數
  let options = document.querySelectorAll('#qpefloodmm option');//刪除原本的選項
  options.forEach(element => {element.remove();})
  let timeArr=[];
  if (optionValue == '6'){timeArr = ['10','150','250','350'];}
  else if (optionValue == '12'){timeArr = ['10','200','400'];}
  else if (optionValue == '24'){timeArr = ['10','200','350','500','650'];}
  timeArr.forEach(element => {
    let option = document.createElement('option');
    option.setAttribute('value', element);
    option.innerText = element;
    select.append(option);
  });
  getqpeflood(document.getElementById('switch-qpe').checked)
}

/////////////------------------淹水資訊  END----------------------------------/////////////////

/////////////------------------地圖工具  START----------------------------------/////////////////

// 計算座標或轉換經緯度
function calsCoord(){
  let transfer= new ol.proj.transform(tmpCasePos, 'EPSG:3857', document.getElementById('diffCoord').value);
  if(document.getElementById('diffCoord').value == 'EPSG:4326'){
    document.getElementById('diffType').disabled=false;
    if (document.getElementById('diffType').value == '度'){
      document.getElementById('calsCoordResult').innerText = `${ (transfer[0]).toFixed(6)}E, ${(transfer[1]).toFixed(6)}N`;
    }else if(document.getElementById('diffType').value == '度分'){
      document.getElementById('calsCoordResult').innerText = `${(~~transfer[0])}°${("00"+((transfer[0]%1)*60).toFixed(2)).slice(-5)}E, ${(~~transfer[1])}°${("00"+((transfer[1]%1)*60).toFixed(2)).slice(-5)}N`;
    }else if(document.getElementById('diffType').value == '度分秒'){
      document.getElementById('calsCoordResult').innerText = (~~transfer[0])+"°"+("00"+(~~((transfer[0]-~~transfer[0])*60)).toString()).slice(-2)+"'"+("00"+(~~((((transfer[0]-~~transfer[0])*60)-(~~((transfer[0]-~~transfer[0])*60)))*60)).toString()).slice(-2)+'"E, '+(~~transfer[1])+"°"+("00"+(~~((transfer[1]-~~transfer[1])*60)).toString()).slice(-2)+"'"+("00"+(~~((((transfer[1]-~~transfer[1])*60)-(~~((transfer[1]-~~transfer[1])*60)))*60)).toString()).slice(-2)+'"N';
    }else if (document.getElementById('diffType').value == '南北島圖'){
      let newCoord = new ol.proj.transform([(transfer[0]).toFixed(3), (transfer[1]).toFixed(3)],'EPSG:4326','EPSG:3825');
      document.getElementById('calsCoordResult').innerText = `${fnGetNSIland(newCoord[0], newCoord[1])}`
    }
  }else{
    document.getElementById('diffType').disabled=true;
    document.getElementById('calsCoordResult').innerText= `${ (transfer[0]).toFixed(5)}, ${(transfer[1]).toFixed(5)}`;
  }
}

// 座標轉換
var mousepos = new ol.control.MousePosition({
  coordinateFormat: function(c) {
    var d=ol.proj.transform(c,'EPSG:3857','EPSG:4326');
    returnmouseP=d;    
  },
  projection: 'EPSG:3857', 
});
map.addControl(mousepos);

// 南北島轉換公式
function fnGetNSIland(x, y) {
  //let x=219698.555;
  //let y=2672577.859;
  try { } catch (err) { }
  let MAP5 = "-------@@- -----@@@@@ -----@@@@@ ----@@@@@- ----@@@@@- ---@@@@@@- ---@@@@@@- --@@@@@@@- --@@@@@@@- --@@@@@@-- -@@@@@@@-- -@@@@@@@-- -@@@@@@@-- @@@@@@@@-- -@@@@@@@-- @@@@@@@--- @@@@@@@--- -@@@@@@--- -@@@@@@--- -@@@@@---- -@@@@----- --@@@----- ---@@----- ---@------";
  let MAP10 = "----@- ---@@@ --@@@@ --@@@@ -@@@@@ -@@@@- -@@@@- @@@@@- @@@@@- @@@@@- @@@@-- -@@@-- -@@@-- --@--- --@---";
  //97轉67
  let A = 0.00001549;
  let B = 0.000006521;
  x = parseFloat(x) - 807.8 - parseFloat(A) * x - parseFloat(B) * y;
  y = parseFloat(y) + 248.6 - parseFloat(A) * parseFloat(y) - parseFloat(B) * parseFloat(x);
  x = parseInt(x);
  y = parseInt(y);
  // document.getElementById("SNIsland").innerHTML = "";
  //##50000
  {

    let page, yl, yp;
    let xp = x - 138000;
    if (y <= 2439000) {    //#南島71圖頭行座標「斷層」
      page = 132;
      yl = (2439000 - y) / 1000;
    } else {
      yp = 2799000 - y;
      let page1 = MAP5.substring(0, 1 + parseInt(xp / 22000) + 11 * parseInt(yp / 15000));
      page1 = page1.replace(/ /g, "");
      page1 = page1.replace(/-/g, "");
      page = page1.length;
      yl = yp % 15000 / 1000 + 1;

    }
    let r1 = (page > 61) ? "南" : "北";
    let r2 = (page > 61) ? page - 61 : page;
    let r3 = 65 + (page > 130 ? xp - 13000 : xp) % 22000 / 1000;

    //輸出 1:50000
    //document.write("1:50000 "+r1+"島"+parseInt(r2)+"圖"+String.fromCharCode(parseInt(r3))+parseInt(yl));
    //document.getElementById("SNIsland").innerHTML="1:50000 "+r1+"島"+parseInt(r2)+"圖"+String.fromCharCode(parseInt(r3))+parseInt(yl);
    // document.getElementById("SNIsland").innerHTML = "" + r1 + "島" + parseInt(r2) + "頁" + String.fromCharCode(parseInt(r3)) + parseInt(yl) + "方格";
    return "1:50000 "+r1+"島"+parseInt(r2)+"圖"+String.fromCharCode(parseInt(r3))+parseInt(yl);
  }
  //##1/100000
  {
    let xp = x - 130000;
    let yp = 2812000 - y;
    let r1 = MAP10.substring(0, 1 + 7 * parseInt(yp / 26000) + parseInt(xp / 38000));

    r1 = r1.replace(/ /g, "");
    r1 = r1.replace(/-/g, "");
    let r2 = 65 + xp % 38000 / 2000;
    let r3 = 2 + yp % 26000 / 2000;
    //輸出 1:100000
    //document.write("1:100000  "+r1.length+"圖"+String.fromCharCode(parseInt(r2))+parseInt(r3));
    // console.log("1:100000  "+r1.length+"圖"+String.fromCharCode(parseInt(r2))+parseInt(r3))
    //document.getElementById("SNIsland").innerHTML = document.getElementById("SNIsland").innerHTML +  "<BR>1:100000  "+r1.length+"圖"+String.fromCharCode(parseInt(r2))+parseInt(r3);
  }
}

// 複製座標
function copyCoord(){
  let copyText = document.getElementById("calsCoordResult");
  navigator.clipboard.writeText(copyText.innerText);
}

// 測量 start
let iomeas=false; 
// let sourcemeas=new ol.source.Vector();
// let vectormeas=new ol.layer.Vector({source:sourcemeas,zIndex:32,style:function (feature) {return styleFunction(feature,true)}});

const stylemeas=new ol.style.Style({
  fill:new ol.style.Fill({color:'rgba(255,255,255,0.2)'}),stroke:new ol.style.Stroke({color:'rgba(255,0,0,.8)',lineDash:[10,10],width:2}),
  image:new ol.style.Circle({radius:5,stroke:new ol.style.Stroke({color:'#000'}),fill:new ol.style.Fill({color:'rgba(255,255,255,.2)'})})
});
const labelStyle=new ol.style.Style({text:new ol.style.Text({font:'24px Calibri,sans-serif',fill:new ol.style.Fill({color:'#fff'}),
  backgroundFill:new ol.style.Fill({color:'rgba(0,0,0,0.7)'}),padding:[3,3,3,3],textBaseline:'bottom',offsetY:-15,overflow:true,
  backgroundStroke:new ol.style.Stroke({color:'#f00',width:1})}),image:new ol.style.RegularShape({radius:8,points:3,angle:Math.PI,
  displacement:[0,10],fill:new ol.style.Fill({color:'rgba(255,0,0,.7)'}),stroke:new ol.style.Stroke({color:'#000',width:2})})
});
const tipStyle=new ol.style.Style({text:new ol.style.Text({font:'16px Calibri,sans-serif',fill:new ol.style.Fill({color:'#fff'}),
  backgroundFill:new ol.style.Fill({color:'rgba(0,0,0,.4)'}),padding:[2,2,2,2],textAlign:'left',offsetX:15})
});
const modifyStyle=new ol.style.Style({
  image:new ol.style.Circle({radius:5,stroke:new ol.style.Stroke({color:'rgba(0,0,0,0.7)'}),fill:new ol.style.Fill({color:'#0f0'})}),
  text:new ol.style.Text({text:'拖曳調整',font:'20px Calibri,sans-serif',fill:new ol.style.Fill({color:'#0f0'}),
  backgroundFill:new ol.style.Fill({color:'rgba(0,0,0,.7)'}),padding:[2,2,2,2],textAlign:'left',offsetX:15})
});
const segmentStyle=new ol.style.Style({text:new ol.style.Text({font:'16px Calibri,sans-serif',fill:new ol.style.Fill({color:'#fff'}),
  backgroundFill:new ol.style.Fill({color:'rgba(0,0,0,.7)'}),padding:[0,2,0,2],textBaseline:'bottom',offsetY:-12,overflow:true,
  backgroundStroke:new ol.style.Stroke({color:'#f00',width:1})}),
  image:new ol.style.RegularShape({radius:6,points:3,angle:Math.PI,displacement:[0,8],fill:new ol.style.Fill({color:'rgba(255,0,0,.4)'})})
});
const segmentStyles=[segmentStyle];
const formatLength=function (line) {const lengthmeas=ol.sphere.getLength(line); let output;
  if (lengthmeas>100) {output=Math.round((lengthmeas/1000)*100)/100+' km';} else {output=Math.round(lengthmeas*100)/100+' m';}; return output;
};
const formatArea=function (polygon) {const areameas=ol.sphere.getArea(polygon); let output;
  if (areameas>10000) {output=Math.round((areameas/1000000)*100)/100+' km\xB2';} else {output=Math.round(areameas*100)/100+' m\xB2';}
  return output;
};
let tipPoint;
function styleFunction(feature,segments,drawType,tip) {
  const stylemeass=[stylemeas]; const geometrymeas=feature.getGeometry(); const typemeas=geometrymeas.getType();
  let point,label,line;
  if (!drawType || drawType===typemeas) {
    if (typemeas==='Polygon') {
      point=geometry.getInteriorPoint(); label=formatArea(geometrymeas); line=new ol.geom.LineString(geometrymeas.getCoordinates()[0]);
    } else if (typemeas==='LineString') {
      point=new ol.geom.Point(geometrymeas.getLastCoordinate()); label=formatLength(geometrymeas); line=geometrymeas;
    };
  };
  if (segments && line) {
    let count=0;
    line.forEachSegment(function (a,b) {
      const segment=new ol.geom.LineString([a,b]); const label=formatLength(segment);
      if (segmentStyles.length- 1 < count) { segmentStyles.push(segmentStyle.clone()); }
      const segmentPoint=new ol.geom.Point(segment.getCoordinateAt(0.5));
      segmentStyles[count].setGeometry(segmentPoint); segmentStyles[count].getText().setText(label); stylemeass.push(segmentStyles[count]);
      count++;
    });
  };
  if (label) {labelStyle.setGeometry(point); labelStyle.getText().setText(label); stylemeass.push(labelStyle); };
  if (tip && typemeas==='Point' && !modifymeas.getOverlay().getSource().getFeatures().length) {
    tipPoint=geometrymeas; tipStyle.getText().setText(tip); stylemeass.push(tipStyle);
  };
  return stylemeass;
};
let modifymeas=new ol.interaction.Modify({source:sourcemeas,style:modifyStyle});
// map.addInteraction(modifymeas);

let drawmeas;
function addInteractionmeas() {
  const drawType='LineString';
  const activeTip='點擊繪製'+(drawType==='Polygon'?'多邊形':'線段');
  const idleTip='點擊以開始測量';
  let tip=idleTip;
  drawmeas=new ol.interaction.Draw({source:sourcemeas,type:drawType,style:function (feature){return styleFunction(feature,true,drawType,tip)}});
  drawmeas.on('drawstart',function () { modifymeas.setActive(false); tip=activeTip;});
  drawmeas.on('drawend', function () { modifyStyle.setGeometry(tipPoint); modifymeas.setActive(true);
    map.once('pointermove', function () { modifyStyle.setGeometry();}); tip=idleTip;
  });
  modifymeas.setActive(true);
  map.addInteraction(drawmeas);
};
function toggleMeasure(a, e) {
  // document.querySelector('label[for="btnmaptool1"]').style.color=a?'#f4be18':'';
  // if (a) {addInteractionmeas(); map.addLayer(vectormeas);} 
  // else {map.removeInteraction(drawmeas); modifymeas.setActive(false); sourcemeas.clear(); vectormeas.changed();map.removeLayer(vectormeas);};
  if (a){addInteractionmeas();map.addInteraction(modifymeas);}
  else{map.removeInteraction(drawmeas);map.removeInteraction(modifymeas);}
};
function clearMeasure(){
  sourcemeas.clear();
}

let measureBoxIo = true;
function switchMeasure(){
  if(measureBoxIo){$('.measure').css({'display':'flex', 'justify-content':'center'});measureBoxIo = false;toggleMeasure(true)}
  else{$('.measure').css({'display':'none', 'justify-content':''});measureBoxIo = true;toggleMeasure(false)}
}
// 測量 end

//////////////////////////// 繪圖工具 START
let drawHandIo=true;
function switchDrawHand(){
  if(drawHandIo){document.querySelector('.drawBox').style.display = 'flex';drawHandIo = false;toggleFreehand(true)}
  else{document.querySelector('.drawBox').style.display = 'none';drawHandIo = true;toggleFreehand(false)}
}
function toggleFreehand(a) {
  if (a) {map.addInteraction(freehand);} 
  else {if (freehand) { map.removeInteraction(freehand); };};
};
function clearFreehand(){
  freehandvec.getSource().clear(); 
}
function switchFreehandColor(){
  map.removeInteraction(freehand); 
  let style = [new ol.style.Style({ stroke:new ol.style.Stroke({ width:5, color:'#000' }) }), new ol.style.Style({ stroke:new ol.style.Stroke({ width:3, color:$('input[name="drawColorRadio"]:checked').val() }), image:new ol.style.Circle({ radius:8, fill:new ol.style.Fill({ color: $('input[name="drawColorRadio"]:checked').val() }), stroke:new ol.style.Stroke({ width:2, color:'#000' }) }) })];
  freehand = new ol.interaction.Draw({ source:freehandvec.getSource(), freehand:true, type:'LineString', style:style });
  map.addInteraction(freehand);

  if(freehand){
    freehand.on('drawend', function(e) {
      let style = [new ol.style.Style({ stroke:new ol.style.Stroke({ width:5, color:'#000' }) }), new ol.style.Style({ stroke:new ol.style.Stroke({ width:3, color:$('input[name="drawColorRadio"]:checked').val() }), image:new ol.style.Circle({ radius:8, fill:new ol.style.Fill({ color: $('input[name="drawColorRadio"]:checked').val() }), stroke:new ol.style.Stroke({ width:2, color:'#000' }) }) })];
      e.feature.setStyle(style);
    });
  }
}
//////////////////////////// 繪圖工具 END

//////////////////////////// 截圖工具 START
let takcPicBoxIo = true;
function switchTakePictureBox(){
  if(takcPicBoxIo){document.querySelector('.takePicBox').style.display = 'flex';takcPicBoxIo = false;}
  else{document.querySelector('.takePicBox').style.display = 'none';takcPicBoxIo = true;}
}
function takePicture(format='png'){
  let domElement = document.getElementById('map');
  let picName = `${new Date().getTime()}`
  html2canvas(domElement, { allowTaint: false,useCORS: true,scale: 3, backgroundColor: null}).then(function (canvas) {
    if (format == 'png' || format == 'jpg'){
      let aTag = document.createElement("a");
      aTag.href = canvas.toDataURL(`image/${format}`);
      aTag.download = `${picName}.${format}`;
      aTag.click();
    }
  });
}
//////////////////////////// 截圖工具 END

// 底圖切換顯示
let switchMapIo=true
function switchMap(checkif){
  if(switchMapIo){document.querySelector('.switchMap').style.display = 'flex';switchMapIo = false;}
  else{document.querySelector('.switchMap').style.display = 'none';switchMapIo = true;}
}

//////////////////////////// 工具列 hover
$('.mds-icon').hover(function(e){
  let left = $(e.target).offset().left;
  let top = $(e.target).offset().top;
  let targetWidth = $(e.target).width();
  let labelWidth = $(e.target).width();
  let labelHeight = $(e.target).height();
  $('#bottomToolsLabel').text($(e.target).attr('name'));

  let showLeft,showTop;
  // top
  if (top < $(window).height()/2){showTop = top + labelHeight/2 - $('#bottomToolsLabel').height()/2;}
  else if(top > $(window).height()/2 && left > $(window).width()/4*3){showTop = top + labelHeight/2 - $('#bottomToolsLabel').height()/2;}
  else if(top > $(window).height()/2){showTop = top - labelHeight - 20;}
  // left
  if (left < $(window).width()/4){showLeft = left + labelWidth + 20;}
  else if(left > $(window).width()/4*3){showLeft = left - $('#bottomToolsLabel').width() - 20;}
  else{showLeft = left + labelWidth/2 - $('#bottomToolsLabel').width()/2;}
  $('#bottomToolsLabel').css({'display':'block','left': `${showLeft}px`, 'top': `${showTop}px`})
},function(){
  $('#bottomToolsLabel').css({'display': 'none'})
})

// Print control
let printControl = new ol.control.Print();
map.addControl(printControl);

/* On print > save image file */
printControl.on('printing', function(e) {
  $('body').css('opacity', .5);
});
printControl.on(['print', 'error'], function(e) {
  $('body').css('opacity', 1);
  // Print success
  if (e.image) {
    if (e.pdf) {
      // Export pdf using the print info
      let pdf = new jsPDF({
        orientation: e.print.orientation,
        unit: e.print.unit,
        format: e.print.size
      });
      pdf.addImage(e.image, 'JPEG', e.print.position[0], e.print.position[0], e.print.imageWidth, e.print.imageHeight);
      pdf.save();
    } else  {
      // console.log(e)
      if (e.printType == 'png' || e.printType == 'jpg'){
        e.canvas.toBlob(function(blob) {
          saveAs(blob, 'map.'+e.imageType.replace('image/',''));
        }, e.imageType);
      } else if(e.printType == 'print'){
        let data = e.canvas.toDataURL();
        let html  = '<html><head><title></title></head>';
            html += '<body style="width: 100%; padding: 0; margin: 0;"';
            html += ' onload="window.focus(); window.print(); window.close()">';
            html += '<img src="' + data + '" /></body></html>';

        let printWindow = window.open('', 'to_print', 'height=600,width=800');

        printWindow.document.open();
        printWindow.document.write(html);
        printWindow.document.close();
      } else {
        $('#image img').attr('src', e.image);
      }
    }
  } else {
    console.warn('No canvas to export');
  }
});

/////////////------------------地圖工具  END----------------------------------/////////////////

/////////------------------底圖切換  START----------------------------------/////////////////
let baselayerurl=[
  {"name": "MDS", "url": "https://gis.fdkc.gov.tw/mapwmts/mdsall/{z}/{x}/{y}.png","imgUrl": "https://gis.fdkc.gov.tw/static/img/mapicon/baselayer/6_1.png"},//0.mds全台
  {"name": "通用地圖", "url": "https://gis.fdkc.gov.tw/extweb/wmtsnlsc/wmts/EMAP5/default/EPSG:3857/{z}/{y}/{x}", "imgUrl": "https://gis.fdkc.gov.tw/static/img/mapicon/baselayer/1_1.png"},//0.MOI 18
  {"name": "灰色地圖", "url": "https://gis.fdkc.gov.tw/extweb/wmtsnlsc/wmts/EMAP01/default/EPSG:3857/{z}/{y}/{x}", "imgUrl": "https://gis.fdkc.gov.tw/static/img/mapicon/baselayer/2_1.png"},//0.MOI 18
  {"name": "深色地圖", "url": "https://gis.fdkc.gov.tw/extweb/wmtsnlsc/wmts/EMAP2/default/EPSG:3857/{z}/{y}/{x}.png", "imgUrl": "https://gis.fdkc.gov.tw/static/img/mapicon/baselayer/3_1.png"},//0.暗色 18
  {"name": "衛星航照", "url": "https://gis.fdkc.gov.tw/extweb/wmtsnlsc/wmts/PHOTO2/default/EPSG:3857/{z}/{y}/{x}.png", "imgUrl": "https://gis.fdkc.gov.tw/static/img/mapicon/baselayer/4_1.png"},//0.TGOS航照
  {"name": "OSM", "url": "https://gis.fdkc.gov.tw/extweb/tileopenstreetmap/{z}/{x}/{y}.png","imgUrl": "https://gis.fdkc.gov.tw/static/img/mapicon/baselayer/5_1.png"},//0.OSM 21
  {"name": "中華底圖", "url": "/mapwmts/chtall/{z}/{x}/{y}.png","imgUrl": "https://gis.fdkc.gov.tw/static/img/mapicon/baselayer/7_1.png"},//中華底圖
];
function toggleBaselayer(a, obj) {
  let itemList = document.querySelectorAll('#mapoverlaycollapse .item')
  itemList.forEach(function(e){
    $(e).css({'box-shadow':'','border':''})  
  })
  $(itemList[a]).css({'box-shadow':'rgb(255 255 255) 1px 1px 1px, rgb(0 0 0) 2px 2px 2px, rgb(0 0 0) 2px 2px 3px, rgb(0 0 0) 3px 3px 4px','border': '2px solid rgb(255, 0, 0)'})
  initbaselayer=parseInt(a);
  let baselayermaxzoom=[19,20,20,20,20,21,19];
  baselayer.setSource(new ol.source.XYZ({url:baselayerurl[a]['url'],crossOrigin:(Math.abs(initbaselayer-6)==1)?null:'anonymous',maxZoom:baselayermaxzoom[a]}));
  document.body.style.backgroundColor=(a==3?'#00000':'#000000');/*如果換成暗色底圖切黑色background，其他皆為藍色*/
};
function createBaseLayer(){
  let content = document.querySelector('#mapcontent');
  for (let i=0;i<baselayerurl.length;i++){
    let label = document.createElement('label');label.setAttribute('class','item');
    label.innerHTML = `
    <div class="mapdiv" onclick="toggleBaselayer(${i}, this)" style="width:70px">
      <div class="imgbox" style="width:100%; height:90px;">
        <img src="https://bot.mds.com.tw/webdemo/gis119wei/${baselayerurl[i]['imgUrl']}" style="width:100%;height:100%;">
      </div>
    </div>`;
      // <div class="title" style="font-size:12px">${baselayerurl[i]['name']}</div>
    content.append(label);
    // 顯示該圖層文字
    label.addEventListener('mouseenter', () => {
      label.parentElement.nextElementSibling.style.visibility = 'visible';
      label.parentElement.nextElementSibling.innerText = `${baselayerurl[i]['name']}`
    });
    label.addEventListener('mouseleave', () => {
      label.parentElement.nextElementSibling.style.visibility = 'hidden';
    });
  }
}
createBaseLayer();
toggleBaselayer(0);//初始化底圖
/////////------------------底圖切換  END----------------------------------/////////////////

/////////------------------右下快捷鍵按鈕  START----------------------------------/////////////////
let legendBtn = function(checkif, layerName ,imgUrl, name, type, layerNumber){
  if(checkif){
    // console.log(type)
    let quickLayer = document.querySelector('.quickLayer');
    if (type=='overlay'){
      $(quickLayer).append(`
        <div 
          class="quickLayer-grid" 
          id="layer-${layerName}" 
          layername="${name}" 
          oncontextmenu="legendShowSwitch(event, this, '${layerName}')" 
          onclick="
            overLayerCtl(false, ${layerNumber}); 
            document.querySelector('#layer-${layerName}').remove(); 
            $('#quickLayerTitle').css({ 'display': 'none' }); 
            $('#overlay-${layerNumber}').prop('checked', false);"
        >
          <img src="https://bot.mds.com.tw/webdemo/gis119wei/${imgUrl}" style="width:100%;">
          <div class="layer-show-level">${overlayerData[layerNumber]['zoomMin']}-${overlayerData[layerNumber]['zoomMax']}</div>
        </div>`);
    }else if(type=='weather'){
      $(quickLayer).append(`
        <div 
          class="quickLayer-grid" 
          id="layer-${layerName}"
          layername="${name}" 
          oncontextmenu="legendShowSwitch(event, this, '${layerName}')"
          onclick="
            weatherLayerCtl(false, ${layerNumber}); 
            document.querySelector('#layer-${layerName}').remove(); 
            $('#quickLayerTitle').css({ 'display': 'none' }); 
            $('#weather-${layerNumber}').prop('checked', false);
          "
        >
          <img src="https://bot.mds.com.tw/webdemo/gis119wei/${imgUrl}" style="width:100%;">
        </div>`);
    }else{
      $(quickLayer).append(`
        <div 
          class="quickLayer-grid" 
          id="layer-${layerName}" 
          layername="${name}" 
          oncontextmenu="legendShowSwitch(event, this, '${layerName}')"
          onclick="
            emicLayerCtl(false, ${layerNumber}); 
            document.querySelector('#layer-${layerName}').remove(); 
            $('#quickLayerTitle').css({ 'display': 'none' }); 
            $('#emic-${layerNumber}').prop('checked', false);
          "
        >
          <img src="https://bot.mds.com.tw/webdemo/gis119wei/${imgUrl}" style="width:100%;">
        </div>`);
    }
  }else{
    // delete btn、delete layer
    document.querySelector(`#layer-${layerName}`).remove();
  }
}
$('.quickLayer').mousemove(function (e) {
  if( e.target.tagName.toLowerCase() === 'img' ){
    $('#quickLayerTitle').empty()
    $('#quickLayerTitle').append(`${e.target.parentElement.getAttribute('layername')}`);
    $('#quickLayerTitle').css({ 'position':'absolute','top': `${e.pageY-50}px`, 'left':`${e.pageX-150}px`, 'display':'block', 'z-index':10, 'background':'#000000d2','width':'150px','border-radius':'5px','padding':'5px 10px','color':'white','font-size':'22px','text-align':'center', 'z-index': '21'});
  }
})
$('.quickLayer').mouseout(function (e) {
  $('#quickLayerTitle').css({ 'display': 'none' })
})
// 快速選單-圖層右鍵


function legendShowSwitch(event, obj, layerName){
  event.preventDefault();
  let i = map.getLayers().getArray();
  if (layerName.indexOf('dgdptyphoon')>=0){// 颱風相關
    for (let ii=1; ii<=2; ii++) { 
      for (let j=0; j<i.length; j++) {
        if(i[j].get("name") && i[j].get("name")=='dgdptyphoon'+ii) {
          if (i[j].getVisible()){i[j].setVisible(false); obj.children[0].style.filter = 'blur(1px) grayscale(1)';}
          else{i[j].setVisible(true);obj.children[0].style.filter = 'blur(0px) grayscale(0)'}
        }
      }; 
    };
  }else{
    for (let j=0; j<i.length; j++) {
      if(i[j].get("name") && i[j].get("name")==layerName) {
        if (i[j].getVisible()){i[j].setVisible(false); obj.children[0].style.filter = 'blur(1px) grayscale(1)';}
        else{i[j].setVisible(true);obj.children[0].style.filter = 'blur(0px) grayscale(0)'}
      }
    }; 
  }
  
}
/////////------------------右下快捷鍵按鈕  END----------------------------------/////////////////

// popup
let divpop = document.getElementById('movepopup');
let movepopup = new ol.Overlay({element:document.getElementById('movepopup')});
map.addOverlay(movepopup);

const container = document.getElementById('popup');
const content = document.getElementById('popup-content');
const closer = document.getElementById('popup-closer');
const overlay = new ol.Overlay({
  element: container,
  autoPan: {animation: {duration: 250,},},
});
map.addOverlay(overlay);

closer.onclick = function () {
  overlay.setPosition(undefined);
  closer.blur();
  return false;
};


map.on('pointermove',function(evt){
  let a=0;
  // console.log(evt.pixel);
  if(rightClickIo){ tmpCasePos = evt.coordinate; calsCoord();/*下框座標*/}//判斷是否取得位置，右鍵選單IO

  let feature = this.forEachFeatureAtPixel(evt.pixel, function(feature,layer) {
    switch (layer) {
      case casepoint: a=5;break;case carpoint: a=6;break;
      default:
      if (layer && layer.get('layerType')) {
        if(layer.get('layerType').indexOf('overlayer')>=0){ a=1;}
      }
      if (layer && layer.get('name')) {
        if (layer.get('name').indexOf('emic')>=0){ a=2;}
        else if (layer.get('name').indexOf('env')>=0){ a=3;}
        else if (layer.get('name').indexOf('dgdp')>=0){ a=4;}
      }
    }
    return feature;
  });
  if (a>0) {
    this.getTargetElement().style.cursor = 'pointer';
    divpop.style.display='block';
    switch (a) {
      case 1:
        divpop.style.width='350px';
        if (feature) {
          let j=feature.get('popup0');
          if (j && j!=undefined) {divpop.innerHTML = j;movepopup.setPosition(evt.coordinate);}
          else{divpop.style.display='none';}
        }
        break;
      case 2:
        divpop.style.width='150px';
        if (feature) {
          let j=feature.get('poup') || feature.get('_name');
          if (j) {divpop.innerHTML = j;movepopup.setPosition(evt.coordinate);} 
          else { divpop.style.display='none'; };
        } else {
          divpop.style.display='none';
        };
        break;
      case 3:
        // console.log(feature);
        divpop.style.width=`${feature.get('popupWidth')}px`;
        if (feature) {
          let j=feature.get('popupContent');
          if (j) {divpop.innerHTML = j;movepopup.setPosition(evt.coordinate);}
        }
        break;
      case 4:
        divpop.style.width='300px';
        if (feature) {
          let j=feature.get('description') || feature.get('name') || feature.get('_name') || feature.get('layer');
          if (j) {
            divpop.innerHTML='<div style="text-align:left;font-family:微軟正黑體;padding-left:5px;background: white;border-radius: 5px;padding: 5px;box-shadow: 2px 2px 2px #000000ed;font-weight: bolder;">'+j+'</div>';
            movepopup.setPosition(evt.coordinate);
          } else { divpop.style.display='none'; };
        } else {
          divpop.style.display='none';
        };
        break;
      case 5:
        divpop.style.width='300px';
        divpop.innerHTML=`<div class="popupTable"><table><thead><tr><th colspan="2">${feature.get('csno')}</th></tr></thead><tbody><tr><td style="width:40px;" class="td1">${feature.get('dept')==null?'':feature.get('dept')}</td><td style="font-size:20px;" >${feature.get('nt_name')}  ${feature.get('nt_tel')}</td></tr><tr><td class="td1 td2">${feature.get('dis_code_case')}</td><td class="td2">${feature.get('dis_code')}</td></tr><tr><td colspan="2">${feature.get('cs_place')}</td></tr><tr><td colspan="2" class="td2">${feature.get('memo')==null?'無':feature.get('memo')}</td></tr><tr><td class="td1">時間</td><td style="text-align:center">${new Date(feature.get('in_time')).toLocaleString()}</td></tr></tbody></table></div>`;
        movepopup.setPosition(evt.coordinate);
        break;
      case 6:
        divpop.style.width='275px';
        divpop.innerHTML=`<div class="popupTable"><table><thead><tr><th colspan="2">${(feature.get('csno')||'---')}</th></tr></thead><tbody><tr><td style="width:60px;" class="td1">車號</td><td>${feature.get('car_no')}</td></tr><tr><td class="td1 td2">呼號</td><td class="td2">${feature.get('call_no')}</td></tr><tr><td class="td1">狀態</td><td>${(feature.get('csno')?'處理中':'待命中')}</td></tr><tr><td class="td1 td2">時間</td><td style="font-size:18px;text-align:center;" class="td2">${new Date(feature.get('msg_date')).toLocaleString()}</td></tr></tbody></table></div>`;
        movepopup.setPosition(evt.coordinate);
        break;
    };
  } else {
    this.getTargetElement().style.cursor = '';
    divpop.style.display='none';
  }
});

// cctv 虛線
let cctvDashLine = new ol.layer.Vector({source:new ol.source.Vector(),renderMode:'vector',declutter:true, zIndex: 12, style: [new ol.style.Style({ stroke: new ol.style.Stroke({ width: 5, color: '#000', lineDash:   [5, 8] }) }),new ol.style.Style({stroke: new ol.style.Stroke({ width: 3, color: '#ff0', lineDash: [5, 8] })})]});
map.addLayer(cctvDashLine);

let cctvFeatureCoord;let cctvBoxCoord;
map.on('moveend',function(){
  if(cctvFeatureCoord!=undefined){cctvLink(cctvFeatureCoord);}
})

let carLink2CaseId;//紀錄setinterval Id
map.on('singleclick',function(evt){
  hideMenu();
  let a = 0;//判斷layer
  let editLayer = false;
  let feature = map.forEachFeatureAtPixel(evt.pixel, function(feature,layer) {
    switch (layer) {
      case carpoint:a=1;break;case casepoint:a=2;break;
      default:
      if (layer && layer.get('layerType')) {
        if(layer.get('layerType').indexOf('overlayer')>=0){ a=5;}
        if($('#editLayer').val() == (layer.get('name'))){editLayer = true;}
      }
      if (layer && layer.get('name')) {
        // if (layer.get('name').indexOf('emic')>=0){a=3;}
        if (layer.get('name').indexOf('emic')>=0){a=3;}
        if (layer.get('name').indexOf('cctv')>=0){a=4;}
        if (layer.get('name').indexOf('env')>=0){ a=6;}
      }
    }
    return feature;
  });

  if (a>0) {
    // console.log(a);
    this.getTargetElement().style.cursor = 'pointer';
    switch (a) {
      case 1://車輛連線
        clearInterval(carLink2CaseId);carLink2Case(feature);
        carLink2CaseId =  setInterval(() => {carLink2Case(feature)}, 2000);
        $('#feature-table').html(`<div class="popupTable"><table><thead><tr><th colspan="2">${(feature.get('csno')||'---')}</th></tr></thead><tbody><tr><td style="width:60px;" class="td1">車號</td><td>${feature.get('car_no')}</td></tr><tr><td class="td1 td2">呼號</td><td class="td2">${feature.get('call_no')}</td></tr><tr><td class="td1">狀態</td><td>${(feature.get('csno')?'處理中':'待命中')}</td></tr><tr><td class="td1 td2">時間</td><td style="font-size:18px;text-align:center;" class="td2">${new Date(feature.get('msg_date')).toLocaleString()}</td></tr></tbody></table></div>`)
        break;
      case 2://案件連線
        if($('#caselistcheckbtn').prop('checked')){
          caseFeatureCoord = feature;
          caseLink(feature);break;
        }
        $('#feature-table').html(`<div class="popupTable"><table><thead><tr><th colspan="2">${feature.get('csno')}</th></tr></thead><tbody><tr><td style="width:40px;" class="td1">${feature.get('dept')==null?'':feature.get('dept')}</td><td style="font-size:20px;" >${feature.get('nt_name')}  ${feature.get('nt_tel')}</td></tr><tr><td class="td1 td2">${feature.get('dis_code_case')}</td><td class="td2">${feature.get('dis_code')}</td></tr><tr><td colspan="2">${feature.get('cs_place')}</td></tr><tr><td colspan="2" class="td2">${feature.get('memo')==null?'無':feature.get('memo')}</td></tr><tr><td class="td1">時間</td><td style="text-align:center">${new Date(feature.get('in_time')).toLocaleString()}</td></tr></tbody></table></div>`)
        break;
      case 3://emic顯示popup
        if (feature) {
          let j=feature.get('description') || feature.get('name') || feature.get('_name') || feature.get('layer');
          if (j) {
            content.innerHTML = j;
            overlay.setPosition(evt.coordinate);
          } else { divpop.style.display='none'; };
        } else {
          overlay.setPosition(undefined);;
        };
        break;
      case 4://cctv側邊欄呼叫
        cctvFeatureCoord=feature;
        cctvLink(feature)
        document.querySelector('.cctvBox').style.left = '0px';
        document.querySelector('.cctvBox .title').innerHTML = feature.get('name');
        document.querySelector('.cctvBox .content').innerHTML = feature.get('stream');
        break;
      case 5:
        if($('.mds-icon.mds-edit-layer').prev().prop('checked')){
          if(editLayer){
            sliderEdit('edit');
            selectedFeature(feature.get('id'));
          }
        }
        else{$('#feature-table').html(feature.get('popup0'));}
        break;
      case 6:
        $('#feature-table').html(feature.get('popupContent'));
        break;
    };
  } else {
    overlay.setPosition(undefined);
    carlink2case.getSource().clear();//刪除車輛案件連線
    clearInterval(carLink2CaseId);
    if(caseFeatureCoord!= undefined){//刪除案件列表連線
      casepointsrc.getFeatures().forEach(function(i) {$(`#case${i.get('csno')}`).css({'background':'','font-weight':'','color':'white'});})
      caseDashLine.getSource().clear();
      caseFeatureCoord = undefined;
    }
    $('#feature-table').html('');
    if(!createEditDraw.activeDraw){sliderEdit('list')}//編輯模式，點選其他地方會切換回list
  }
})


/////////------------------右鍵選單  START----------------------------------/////////////////
document.onclick = hideMenu;
document.querySelector('#map').oncontextmenu = rightClick;
function hideMenu() {
  document.getElementById("contextMenu").style.display = "none"
}
function rightClick(e) {
  e.preventDefault();
  // rightClickIo=false;
  if (document.getElementById("contextMenu").style.display == "block"){
    rightClickIo=true;
    hideMenu();
  }
  else {
    let menu = document.getElementById("contextMenu");
    menu.style.display = 'block';
    menu.style.left = e.pageX + "px";
    menu.style.top = e.pageY + "px";
  }
}

// zoom in/out
function setZoomLevel(type){
  if(type=='in'){
    map.getView().animate({
      zoom: Math.round(map.getView().getZoom())+1,
      duration: 300,
    });
    zoomlevelreturn();
  }else if(type=='out'){
    map.getView().animate({
      zoom: Math.round(map.getView().getZoom())-1,
      duration: 300,
    });
    zoomlevelreturn();
  }
}

// 座標對照
let coordBoxIo = true;
function switchCoord(){
  if(coordBoxIo){
    document.querySelector('.coord').style.display = 'block';
    coordBoxIo = false;
  }
  else{document.querySelector('.coord').style.display = 'none';coordBoxIo = true;}
  hideMenu();
}

// 清除點位
function clearCasePos(){
  selectedLoc.getSource().clear();
  tmpaddrLoc.getSource().clear();
  supcaselayer.getSource().clear();
  rightClickIo=true;
  document.getElementById('addrinput').value='';
  document.getElementById("addrlonlat").innerHTML='';
  // 縣市下拉選單返回預設值
  updateaddrcity();

  hideMenu();
  // $('#relocation').css({'display':''});
  // $('#clearlocation').css({'display':'none'});
}

// 案發點重新定位
// let caseLonPos;let caseLatPos;
let tmpCasePos;
let rightClickIo=true;
function reLocateCasePos(action0=1){
  // selectedLoc.getSource().clear();
  calsCoord();
  // let coordinates1 = ol.proj.fromLonLat(returnmouseP);
  if(action0==1){
    selectedLoc.getSource().clear();
    selectedLoc.getSource().addFeature(new ol.Feature({geometry: new ol.geom.Point(ol.proj.fromLonLat(returnmouseP)),name: '案件中心'}));
  } 
  let xyz=[];
  let xyz_str;
  xyz=ol.proj.transform(returnmouseP,"EPSG:4326","EPSG:3826");
  // xyz[0]=LatLonToTM97(returnmouseP[0],returnmouseP[1])[0];
  // xyz[1]=LatLonToTM97(returnmouseP[0],returnmouseP[1])[1];
  xyz.push(parseInt(map.getView().getZoom()));
  // console.log(xyz);
  xyz_str=xyz[0]+','+xyz[1]+','+xyz[2];
  rightClickIo=false;
  hideMenu();
  // 20230203lin:查找座標地址
  $.get('https://gis.fdkc.gov.tw/rescue/getaddr/json?x='+returnmouseP[0]+'&y='+returnmouseP[1],function(a){
    if(a.io == 1 || a.io == 2){
      let lon=Math.round(a.lon * 10000) / 10000;
      let lat=Math.round(a.lat * 10000) / 10000; 
      document.getElementById('addrinput').value=returnmouseP[0]+','+returnmouseP[1];
      document.getElementById("addrlonlat").innerHTML=a.addr+'</br>('+lon.toString()+', '+lat.toString()+')';
      tmpaddrLoc.getSource().clear();
      tmpaddrLoc.getSource().addFeature(new ol.Feature({geometry: new ol.geom.Point(ol.proj.fromLonLat([a.lon,a.lat])),name: '地址座標'}));
      if (a.io==1){xyz_str=xyz_str+',a,'+a.addr;}else{xyz_str=xyz_str+',m,'+a.id;}
      // xyz_str=xyz_str+',addr='+a.addr;
    }else{
      // let lon=Math.round(returnmouseP[0] * 10000) / 10000;
      // let lat=Math.round(returnmouseP[1] * 10000) / 10000;
      document.getElementById('addrinput').value=returnmouseP[0]+','+returnmouseP[1];
      document.getElementById("addrlonlat").innerHTML='查無地址!';
      tmpaddrLoc.getSource().clear();
      xyz_str=xyz_str+',x,50公尺內無門牌或重要地標'
      if(action0==2){
        tmpaddrLoc.getSource().clear();
        tmpaddrLoc.getSource().addFeature(new ol.Feature({geometry: new ol.geom.Point(ol.proj.fromLonLat(returnmouseP)),name: '地址座標'}));
      }
    }

    if (typeof jsObj == "undefined") {        
      //如果jsObj不存在
      console.log(xyz_str);
      return xyz_str;
    }else{
      //呼叫cs裡的zoomlevelreturn，回傳值為mapzoomnow
      if(action0==1){
        jsObj.returnXYZ(xyz_str);
      }        
    }
  }); 
}

/////////------------------右鍵選單  END----------------------------------/////////////////

function cctvLink(feature){
  // box positon
  let cctvBox=document.querySelector('.cctvBox .content');
  let centerTop = cctvBox.clientTop + cctvBox.offsetHeight/2;
  let centerLeft = cctvBox.clientLeft + cctvBox.offsetWidth/2;
  let boxcenter = map.getCoordinateFromPixel([centerTop, centerLeft]);
  cctvDashLine.getSource().clear();
  cctvDashLine.getSource().addFeature(new ol.Feature({geometry:new ol.geom.LineString([boxcenter, feature.getGeometry().getCoordinates()])})); 
}
function cctvBoxCtl(checkif){
  if (checkif){
    document.querySelector('.cctvBox').style.left='-400px';
    cctvDashLine.getSource().clear();
    cctvFeatureCoord=undefined;
  }
}


/////////------------------選單  Start----------------------------------/////////////////
// function toggleSideBar(){
//   if (document.querySelector('#sideBarChk').checked){
//     $('.sidebar').css({'left':'-300px'});
//     $('.sidebar').siblings().css( "rotate;", "180deg" );
//   }else{
//     $('.sidebar').css({'left':'10px'});
//     $('.sidebar').siblings().css( "rotate;", "0deg" );
//   }
// }


/////////------------------案件清單  Start----------------------------------/////////////////
let caseList = [];
function caselist(casedata) {
  let tbody = document.querySelector('#caseListTable tbody'); 
  let newCaseList = [];
  // casedata.forEach(function(i, index) {
  for(let i=0;i<casedata.csno.length;i++){
    if (!(caseList.includes(casedata.csno[i]))){
      let row = tbody.insertRow();
      row.setAttribute('onclick',`caseLocMove('${casedata.csno[i]}')`);
      row.setAttribute('id', `case${casedata.csno[i]}`);
      row.setAttribute('casetype', `${casedata.dis_code[i].split('_')[0]}`);
      row.insertCell(0).innerHTML=`<div><b>${casedata.csno[i]}</b></div><div>【${casedata.dis_code_case[i]}─${casedata.dis_code[i].split('_')[1]}】<br>${casedata.nt_name[i]}=${casedata.nt_tel[i]}<br>${casedata.cs_place[i]}<br>${new Date(casedata.in_time[i]).toLocaleString()}`;
      caseList.push(casedata.csno[i]);
    }
    newCaseList.push(casedata.csno[i]);
  };
  checkCaseList(newCaseList);
};
function checkCaseList(newCaseList){
  let difference = caseList.filter(x => !newCaseList.includes(x));
  if (difference.length>0){
    for(let i=0;i<difference.length;i++){
      $(`#${difference[i]}`).remove();
      let index = caseList.indexOf(difference[i]);
      if (index !== -1) {caseList.splice(index, 1);}//remove 原本array
    }
  }
}

/////////------------------即時案件  Start----------------------------------/////////////////
function caseLocation(){
  // casepoint.setVisible(document.getElementById('btnrealtime1').checked);
  // if (document.getElementById('btnrealtime1').checked) {
    $.getJSON('https://vpa078w.localto.net/',function(f) {
      if (f.io==1) {
        var csno=f.csno;
        casepointsrc.getFeatures().forEach(function(i) {
          let show=true;
          let j=csno.indexOf(i.get('csno'));
          if (j<0) {
            casepointsrc.removeFeature(i);
          } else {
            let showIf;
            if (caseFilterList.includes(`${i.getProperties()['csno']}`)){showIf=true}
            else if(caseType.length == 0){showIf=true}
            else {showIf=false}
            // console.log('1')
            i.setProperties({csno:f.csno[j],dis_code:f.dis_code[j],in_time:f.in_time[j],dept:f.dept[j],nt_name:f.nt_name[j],nt_tel:f.nt_tel[j],cs_place:f.cs_place[j],memo:f.memo[j],dis_code_case:f.dis_code_case[j],show:showIf});
            i.getGeometry().setCoordinates(ol.proj.transform([f.x[j],f.y[j]],'EPSG:4326','EPSG:3857'));
          };
        });
        for (let ii=0; ii<csno.length; ii++) {
          if (!casepointsrc.getFeatureById(csno[ii])) {
            let showIf;
            if (caseFilterList.includes(`${csno[ii]}`)){showIf=true}
            else if(caseType.length == 0){showIf=true}
            else {showIf=false}
            let jj=new ol.Feature({type:'Point',geometry:new ol.geom.Point(ol.proj.transform([f.x[ii],f.y[ii]],'EPSG:4326','EPSG:3857')),csno:f.csno[ii],dis_code:f.dis_code[ii],in_time:f.in_time[ii],dept:f.dept[ii],nt_name:f.nt_name[ii],nt_tel:f.nt_tel[ii],cs_place:f.cs_place[ii],memo:f.memo[ii],dis_code_case:f.dis_code_case[ii],show:showIf});
            jj.setId(csno[ii]);
            casepointsrc.addFeature(jj);
          };
        };
        caselist(f)
      };
      setTimeout(caseLocation,3000);
    });
  // };
};

/////////------------------車輛監控  Start----------------------------------/////////////////
function carLocation(){
  // carpoint.setVisible(document.getElementById('btnrealtime2').checked);
  // if (document.getElementById('btnrealtime2').checked) {
    $.getJSON('https://vzobkcq.localto.net/',function(f) {
      if (f.io==1) {
        var imei=f.imei;
        carpointsrc.getFeatures().forEach(function(i) {
          let j=imei.indexOf(i.getId());
          if (j<0) {
            carpointsrc.removeFeature(i);
          } else {
            let showIf;
            if (caseFilterList.includes(`${i.getProperties()['csno']}`)){showIf=true}
            else if(caseType.length == 0){showIf=true}
            else {showIf=false}
            i.setProperties({csno:(f.csno[j]=="None")?null:f.csno[j],car_no:f.car_no[j],call_no:f.call_no[j],dir0:f.dir0[j],msg_date:f.msg_date[j],show:showIf});
            i.getGeometry().setCoordinates(ol.proj.transform([f.x[j],f.y[j]],'EPSG:4326','EPSG:3857'));
          };
        });
        for (let ii=0; ii<imei.length; ii++) {
          if (!carpointsrc.getFeatureById(imei[ii])) {
            let showIf;
            if (caseFilterList.includes(`${imei[ii]}`)){showIf=true}
            else if(caseType.length == 0){showIf=true}
            else {showIf=false}
            let jj=new ol.Feature({type:'Point',geometry:new ol.geom.Point(ol.proj.transform([f.x[ii],f.y[ii]],'EPSG:4326','EPSG:3857')),csno:(f.csno[ii]=="None")?null:f.csno[ii],car_no:f.car_no[ii],call_no:f.call_no[ii],dir0:f.dir0[ii],msg_date:f.msg_date[ii],show:showIf});
            jj.setId(imei[ii]);
            carpointsrc.addFeature(jj);
          };
        };
      };
      setTimeout(carLocation,2000);
    });
  // };
};
caseLocation(); 
carLocation();

/////////------------------案件與車子連線  Start----------------------------------/////////////////
function carLink2Case(feature){
  carlink2case.getSource().clear();
  let featureLoc = feature.getGeometry().getCoordinates();
  if(casepointsrc.getFeatureById(`${feature.get('csno')}`)==null) return ;
  let caseLoc = casepointsrc.getFeatureById(`${feature.get('csno')}`).getGeometry().getCoordinates()
  carlink2case.getSource().clear();
  carlink2case.getSource().addFeature(new ol.Feature({geometry:new ol.geom.LineString([featureLoc, caseLoc])})); 
}

/////////------------------案件連線  Start----------------------------------/////////////////
let caseFeatureCoord;
map.on('moveend',function(){if(caseFeatureCoord!=undefined){caseLink(caseFeatureCoord);}})

let scrollIo = false;
document.querySelector('.tableBox').addEventListener("scroll", (event) => {
  if (scrollIo){
    casepointsrc.getFeatures().forEach(function(i) {$(`#case${i.get('csno')}`).css({'background':'','font-weight':'','color':'white'});})
    caseDashLine.getSource().clear();
    caseFeatureCoord = undefined;
  }
});
function caseLink(feature){
  scrollIo = false;
  // box positon
  let caseRow=document.getElementById(`case${feature.get('csno')}`);
  caseRow.scrollIntoView(false);
  let centerTop = $(caseRow).offset()['top'] - $('.ol-viewport').offset()['top'] + $(caseRow).height() / 2;
  // let centerLeft = $(caseRow).offset()['left'] - $('.ol-viewport').offset()['left'] + $(caseRow).width() / 2;
  let centerLeft = $(caseRow).offset()['left'] - $('.ol-viewport').offset()['left'];
  let boxcenter = map.getCoordinateFromPixel([centerLeft, centerTop]);
  caseDashLine.getSource().clear();
  caseDashLine.getSource().addFeature(new ol.Feature({geometry:new ol.geom.LineString([boxcenter, feature.getGeometry().getCoordinates()])})); 
  casepointsrc.getFeatures().forEach(function(i) {$(`#case${i.get('csno')}`).css({'background':'','font-weight':'','color':'white'});})
  // document.getElementById(`${feature.getId()}`).style.background = '#ff8700';
  $(`#case${feature.get('csno')}`).css({'background':'#ff8700','font-weight':'bolder','color':'black'});

  setTimeout(() => {scrollIo = true}, 500);//因scrollIntoView會一起觸發，所以新增IO和延遲
}
function listCollapse(){
  if(document.getElementById('mds-list').checked){
    casepointsrc.getFeatures().forEach(function(i) {$(`#case${i.get('csno')}`).css({'background':'','font-weight':'','color':'white'});})
    caseDashLine.getSource().clear();
    caseFeatureCoord = undefined;
  }
}
// 案件連線 end

/////////------------------移動案件位置  Start----------------------------------/////////////////
function caseLocMove(i){
  // console.log(`${i}`)
  map.getView().animate({center:casepointsrc.getFeatureById(`${i}`).getGeometry().getCoordinates(),zoom: 16});
}

/////////------------------案件列表 - 案類篩選和搜尋框  Start----------------------------------/////////////////
let caseFilterList=[];
function filterCaseType(){
  caseFilterList=[];
  let table, tr, casetype;
  table = document.getElementById("caseListTable");
  tr = table.getElementsByTagName("tr");
  if(caseType.length === 0){
    for (i = 0; i < tr.length; i++) {
      tr[i].style.display = "";
    }
  }else{
    for (i = 0; i < tr.length; i++) {
      trcasetype = tr[i].getAttribute('casetype');
      if (caseType.includes(trcasetype)) {
        tr[i].style.display = "";
        caseFilterList.push(tr[i].getAttribute('id').split('case')[1])
      } else {
        tr[i].style.display = "none";
      }
    }
  }
  caseFilterByType();
  carFilterByType();
}

//右上案件類別按鈕
let switchIo=true;
function switchCaseType(){
  if(switchIo){$('.caseTypeList').css({'display':'flex'});$('.mds-up-double-arrow').css({'rotate':'180deg'});switchIo=false;document.querySelector('.mask').style.display='block';}
  else{$('.caseTypeList').css({'display':'none'});$('.mds-up-double-arrow').css({'rotate':'0deg'});switchIo=true;document.querySelector('.mask').style.display='none';}
}
// 增加case list監聽
let caseType=[];
document.querySelector('.caseTypeList').addEventListener('click',function(e){
  if( e.target.tagName.toLowerCase() === 'label'){
    if(!e.target.children[0].checked){
      $(e.target).css({'background': 'rgb(255 176 61)', 'font-weight':'bolder'})
      caseType.push(e.target.textContent);
      $('#caseFilterBox').append(`<div class="quickLayer-grid" type="${e.target.textContent}" onclick="removeQuickTypeBtn('${e.target.textContent}')"><img src="https://gis.fdkc.gov.tw/static/img/mapicon/case/${caseTypeIconDict[e.target.textContent]}" style="width: 100%;"></div>`)
    }else{
      $(e.target).css({'background': '', 'font-weight':''})
      let index = caseType.indexOf(e.target.textContent);
      if (index !== -1) {
        caseType.splice(index, 1);
      }
      for(let i=0;i<$('#caseFilterBox').children().length;i++){
        if(e.target.textContent === $('#caseFilterBox').children()[i].getAttribute('type')){
          $('#caseFilterBox').children()[i].remove();
        }
      }
    }
  }
  filterCaseType();
  // TODO:處理冒泡事件
},false);

function removeQuickTypeBtn(closeType){
  document.querySelectorAll('.caseTypeList input').forEach(
    function(element){
      if (element.getAttribute('value') === closeType){
        $(element.parentElement).css({'background': '', 'font-weight':''})
        let index = caseType.indexOf(closeType);
        if (index !== -1) {
          caseType.splice(index, 1);
        }
        document.querySelectorAll('#caseFilterBox .quickLayer-grid').forEach(
          function(e){if (e.getAttribute('type') === closeType){e.remove();}}
        )
        filterCaseType();
      }
    }
  )
}

//右上案件類別按鈕
// carfilter
function caseFilterByType(){
  casepointsrc.getFeatures().forEach(feature => {
    if (caseFilterList.includes(`${feature.getProperties()['csno']}`)){
      feature.setProperties({'show': true});
    }else if(caseType.length == 0){
      feature.setProperties({'show': true});
    }else {
      feature.setProperties({'show': false});
    }
  });
}

function carFilterByType(){
  carpointsrc.getFeatures().forEach(feature => {
    //if (feature.get('csno')=="None") { feature.set('csno',null); };
    if (caseFilterList.includes(`${feature.getProperties()['csno']}`)){
      feature.setProperties({'show': true});
    }else if(caseType.length === 0){
      feature.setProperties({'show': true});
    }else{
      feature.setProperties({'show': false});
    }
  });
}


// scroll to top 
function scroll2Top(element){
  const el = document.querySelector(element);
  el.scrollTo({top: 0,behavior: 'smooth'});
}
document.querySelector('.tableBox').addEventListener("scroll", (event) => {
  if ( event.target.scrollTop > 0){
    document.querySelector('.caseListBox .home').style.display = '';
    $('.caseListBox .home').css('top', `${$('.caseListBox').height() + $('.caseListBox').scrollTop() - 50}px`);
  } else {
    document.querySelector('.caseListBox .home').style.display = 'none';
  }
});

/////////------------------案件列表 - 案類篩選和搜尋框  End----------------------------------/////////////////

/////////------------------左側選單，切換list  END----------------------------------/////////////////
function overLayerSwitch(checkif=false){
  if(checkif){
    $('#overlaycontent.content').css({'padding':'0'})
    document.querySelectorAll('.collapse #overlaycontent.content label').forEach(function(e){$(e).css({'width':'100%','border':'none','border-radius':'5px'})})
    $('.collapse #overlaycontent.content').css({'justify-content': 'flex-end'})
    document.querySelectorAll('.collapse #overlaycontent.content label .iconContent').forEach(function(e){$(e).css({'width':'100%'})})
    document.querySelectorAll('.collapse #overlaycontent.content label .iconContent .name').forEach(function(e){$(e).css({'display':'block','visibility': 'visible'})})
    document.querySelectorAll('.collapse #overlaycontent.content label .iconContent img').forEach(function(e){$(e).css({'width':'40px','height':'40px'})})
  }else{
    $('#overlaycontent.content').css({'padding':''})
    document.querySelectorAll('.collapse #overlaycontent.content label').forEach(function(e){$(e).css({'width':'','border':'','border-radius':''})})
    $('.collapse #overlaycontent.content').css({'justify-content': ''})
    document.querySelectorAll('.collapse #overlaycontent.content label .iconContent').forEach(function(e){$(e).css({'width':''})})
    document.querySelectorAll('.collapse #overlaycontent.content label .iconContent .name').forEach(function(e){$(e).css({'display':''})})
    document.querySelectorAll('.collapse #overlaycontent.content label .iconContent img').forEach(function(e){$(e).css({'width':'','height':''})})
  }
}

function weatherLayerSwitch(checkif=false){
  if(checkif){
    $('#weathercontent.content').css({'padding':'0'})
    document.querySelectorAll('.collapse #weathercontent.content label').forEach(function(e){$(e).css({'width':'100%','border':'none','border-radius':'5px'})})
    $('.collapse #weathercontent.content').css({'justify-content': 'flex-end'})
    document.querySelectorAll('.collapse #weathercontent.content label .iconContent').forEach(function(e){$(e).css({'width':'100%'})})
    document.querySelectorAll('.collapse #weathercontent.content label .iconContent .name').forEach(function(e){$(e).css({'display':'block','visibility': 'visible'})})
    document.querySelectorAll('.collapse #weathercontent.content label .iconContent img').forEach(function(e){$(e).css({'width':'40px','height':'40px'})})
  }else{
    $('#weathercontent.content').css({'padding':''})
    document.querySelectorAll('.collapse #weathercontent.content label').forEach(function(e){$(e).css({'width':'','border':'','border-radius':''})})
    $('.collapse #weathercontent.content').css({'justify-content': ''})
    document.querySelectorAll('.collapse #weathercontent.content label .iconContent').forEach(function(e){$(e).css({'width':''})})
    document.querySelectorAll('.collapse #weathercontent.content label .iconContent .name').forEach(function(e){$(e).css({'display':''})})
    document.querySelectorAll('.collapse #weathercontent.content label .iconContent img').forEach(function(e){$(e).css({'width':'','height':''})})
  }
}

function emicLayerSwitch(checkif=false){
  if(checkif){
    $('#emiccontent.content').css({'padding':'0'})
    document.querySelectorAll('.collapse #emiccontent.content label').forEach(function(e){$(e).css({'width':'100%','border':'none','border-radius':'5px'})})
    $('.collapse #emiccontent.content').css({'justify-content': 'flex-end'})
    document.querySelectorAll('.collapse #emiccontent.content label .iconContent').forEach(function(e){$(e).css({'width':'100%'})})
    document.querySelectorAll('.collapse #emiccontent.content label .iconContent .name').forEach(function(e){$(e).css({'display':'block','visibility': 'visible'})})
    document.querySelectorAll('.collapse #emiccontent.content label .iconContent img').forEach(function(e){$(e).css({'width':'40px','height':'40px'})})
  }else{
    $('#emiccontent.content').css({'padding':''})
    document.querySelectorAll('.collapse #emiccontent.content label').forEach(function(e){$(e).css({'width':'','border':'','border-radius':''})})
    $('.collapse #emiccontent.content').css({'justify-content': ''})
    document.querySelectorAll('.collapse #emiccontent.content label .iconContent').forEach(function(e){$(e).css({'width':''})})
    document.querySelectorAll('.collapse #emiccontent.content label .iconContent .name').forEach(function(e){$(e).css({'display':''})})
    document.querySelectorAll('.collapse #emiccontent.content label .iconContent img').forEach(function(e){$(e).css({'width':'','height':''})})
  }
}

function mapToolsSwitch(checkif){
  if(checkif){
    $('#toolscontent label i').css({'display': 'block'});
    $('#toolscontent').css({'display':'flex', 'flex-direction': 'row', 'justify-content': 'flex-end'})
  }else{
    $('#toolscontent label i').css({'display': ''});
    $('#toolscontent').css({'display':'', 'flex-direction': '', 'justify-content': ''})
  }
}

function qpeFloodSwitch(checkif){
  if(checkif){
    $('#floodcontent .selectedBox').css({'display': 'none'})
    $('#floodcontent').css({'align-items':'flex-end','flex-direction': 'column', 'align-content': 'flex-end'})
  }else{
    $('#floodcontent .titleContent').css({'display': 'flex'})
    $('#floodcontent .selectedBox').css({'display': ''})
    $('#floodcontent').css({'align-items':'','flex-direction': '', 'align-content': ''})
  }
}

function baseMapSwitch(checkif){
  if(checkif){
    $('#mapcontent').css({'display':'block', 'padding': '0'})
    $('#mapcontent .item').css({'display': 'flex', 'justify-content': 'flex-end'});
    $('#mapcontent .item .mapdiv').css({'width': '45px'})
    $('#mapcontent .item .mapdiv .imgbox').css({'height': '55px'})
    if ($(window).width() < 1200){$('#toolscontent label').css({'justify-content':'flex-end'})}
  }else{
    $('#mapcontent').css({'display':'', 'padding': ''})
    $('#mapcontent .item').css({'display': '', 'justify-content': ''});
    $('#mapcontent .item .mapdiv').css({'width': '75px'})
    $('#mapcontent .item .mapdiv .imgbox').css({'height': '100px'})
    if ($(window).width() < 1200){$('#toolscontent label').css({'justify-content':''})}
  }
}

function sideBarCollapseSwitch(checkif, obj){
  $(obj).parent().css({'rotate':`${checkif?'180deg':'0deg'}`})
  overLayerSwitch(checkif)
  weatherLayerSwitch(checkif)
  emicLayerSwitch(checkif)
  qpeFloodSwitch(checkif)
  mapToolsSwitch(checkif)
  baseMapSwitch(checkif)
  let sidebarWidth = $('.sidebar').width()
  if($(window).width()<1200){
    $('.sidebar').css({'left':`${checkif ? (-sidebarWidth+45)+'px' : ''}`})
  }else{
    $('.sidebar').css({'left':`${checkif ? (-sidebarWidth+53)+'px' : ''}`})
  }
  $('#sideBarListSwitch').css({'display':checkif?'none':'inline-block'})
  if(checkif) {
    $('#sideBarListSwitch i').removeClass('mds-rec-item').addClass('mds-list');$('.mds-icon.mds-list').prev().prop('checked',false);$('#overlayer-layer-range').css({'display':'none'});
    $(obj).siblings('i').addClass('active');
  } else {
    $('#overlayer-layer-range').css({'display':''}); $(obj).siblings('i').removeClass('active');
  }
  document.getElementById('feature-table').style.left=checkif?'65px':'300px';
}

// 切換小按鈕，因為只需要修改圖層套疊、環境資訊、EMIC
function sideBarSwitch2List(checkif){
  overLayerSwitch(checkif)
  weatherLayerSwitch(checkif)
  emicLayerSwitch(checkif)
  if(checkif) {
    $('#sideBarListSwitch i').removeClass('mds-list').addClass('mds-rec-item active')
    document.querySelector('#sideBarListSwitch label i').setAttribute('name','圖示切換')
  } else{
    $('#sideBarListSwitch i').removeClass('mds-rec-item active').addClass('mds-list')
    document.querySelector('#sideBarListSwitch label i').setAttribute('name','列表切換')
  };
}
/////////------------------左側選單  END----------------------------------/////////////////

/////////------------------右側選單  START----------------------------------/////////////////
$('.caseListBox').css({'opacity': 0, 'z-index':1, 'right': '-500px'});
function rightSidebarBtn(obj, classname){
  // $('.caseListBox').css({'opacity': 0, 'z-index':1, 'right': '-500px'});
  // $('.addrDiv').css({'opacity': 0, 'z-index':1, 'right': '-500px'});
  // $('.quickroadbox').css({'opacity': 0, 'z-index':1, 'right': '-500px'});
  // $('.gis-edit-layout').css({'opacity': 0, 'z-index':1, 'right': '-500px'});
  checkIconStatus(classname);

  if($(obj.nextElementSibling).hasClass('active')){
    $(obj).prop('checked', false);
    $(obj.nextElementSibling).removeClass('active');
    
    //特別針對案件列表
    if($(obj).attr('id')=='caselistcheckbtn'){
      //TODO: 要改顏色回來
      caseDashLine.getSource().clear();
      caseFeatureCoord = undefined;
    };
    switch(classname) {
      case 'mds-list':$('.caseListBox').css({'opacity': 0, 'z-index':1, 'right': '-500px'}); break;
      case 'mds-search-addr': $('.addrDiv').css({'opacity': 0, 'z-index':1, 'right': '-500px'}); break;
      case 'mds-position-loc':$('.quickroadbox').css({'opacity': 0, 'z-index':1, 'right': '-500px'}); break;
      case 'mds-edit-layer':$('.gis-edit-layout').css({'opacity': 0, 'z-index':1, 'right': '-500px'}); break;
    };
  }else{
    // 收其他
    // for (let i=0;i<2;i++){$('.rightToolsBox .mds-icon')[i].classList.remove('active');}//最上兩個
    $('.rightToolsBox .mds-edit-layer').removeClass('active');//自訂圖資
    // 展開點擊
    switch(classname){
      case 'mds-list':$('.caseListBox').css({'opacity': 1, 'z-index':10, 'right': '60px'});break;
      case 'mds-search-addr':$('.addrDiv').css({'opacity': 1, 'z-index':10, 'right': '60px'});break;
      case 'mds-position-loc':$('.quickroadbox').css({'opacity': 1, 'z-index':10, 'right': '60px'});break;
      case 'mds-edit-layer':$('.gis-edit-layout').css({'opacity': 1, 'z-index':10, 'right': '60px'});break;
    }
    $(obj).prop('checked', true);
    $(obj.nextElementSibling).addClass('active');
  }
}

function checkIconStatus(className){// 如果編輯圖資開啟，繪圖、測量禁止選擇且變色
  if(['mds-draw','mds-ruler','mds-search-loc-nomal'].includes(className)){//繪圖工具、測量工具、座標轉換
    if($('.mds-icon.mds-draw').prev().prop('checked') || $('.mds-icon.mds-ruler').prev().prop('checked') || $('.mds-icon.mds-search-loc-nomal').prev().prop('checked')){
      $('.mds-icon.mds-edit-layer').css({'background-color':'rgb(178 178 178 / 75%)', 'color':'black'});
      $('.mds-icon.mds-edit-layer').prev().prop('disabled',true);
    }else{
      $('.mds-icon.mds-edit-layer').css({'background-color':'', 'color':''});
      $('.mds-icon.mds-edit-layer').prev().prop('disabled',false);
    }
  }else if(['mds-edit-layer'].includes(className)){//自訂圖資
    if($('.mds-icon.mds-edit-layer').prev().prop('checked')){
      $('.mds-icon.mds-ruler').css({'background-color':'rgb(178 178 178 / 75%)', 'color':'black'});
      $('.mds-icon.mds-draw').css({'background-color':'rgb(178 178 178 / 75%)', 'color':'black'});
      $('.mds-icon.mds-search-loc-nomal').css({'background-color':'rgb(178 178 178 / 75%)', 'color':'black'});
      $('.mds-icon.mds-ruler').prev().prop('disabled',true);
      $('.mds-icon.mds-draw').prev().prop('disabled',true);
      $('.mds-icon.mds-search-loc-nomal').prev().prop('disabled',true);
    }else{
      $('.mds-icon.mds-ruler').css({'background-color':'', 'color':''});
      $('.mds-icon.mds-draw').css({'background-color':'', 'color':''});
      $('.mds-icon.mds-search-loc-nomal').css({'background-color':'', 'color':''});
      $('.mds-icon.mds-ruler').prev().prop('disabled',false);
      $('.mds-icon.mds-draw').prev().prop('disabled',false);
      $('.mds-icon.mds-search-loc-nomal').prev().prop('disabled',false);
    }
  }else{//切換其他項目
    sliderEdit('list');//關閉，自訂圖資interaction
    $('.mds-icon.mds-edit-layer').prev().prop('checked', false)
    $('.mds-icon.mds-ruler').css({'background-color':'', 'color':''});
    $('.mds-icon.mds-draw').css({'background-color':'', 'color':''});
    $('.mds-icon.mds-search-loc-nomal').css({'background-color':'', 'color':''});
    $('.mds-icon.mds-ruler').prev().prop('disabled',false);
    $('.mds-icon.mds-draw').prev().prop('disabled',false);
    $('.mds-icon.mds-search-loc-nomal').prev().prop('disabled',false);
  }
}
/////////------------------右側選單  END----------------------------------/////////////////

/////////------------------門牌地址查詢  START----------------------------------/////////////////
function updateaddr(addr){
  let addrcity=document.getElementById("cityinput");
  let cityname=addrcity.options[addrcity.selectedIndex].text;
  $('#addrlist').empty();
  document.getElementById("addrinput").value=addr.replace(cityname,'');
  getaddr();
}

function updateaddrcity(){
  $.get('/rescue/getcitylist/json',function(a){
    document.getElementById("cityinput").options.length=0;
    let cityimput=document.getElementById("cityinput");
    if(a.io==1){
      for(let i=0;i<a.city.length;i++){
        if (a.city[i]==domaincity[thiscity].substring(0, 3)){
          cityimput[i] = new Option(a.city[i], a.city[i], true, true);
        }else{
          cityimput[i] = new Option(a.city[i], a.city[i], false, false);
        }
      }
    }
  });
}
updateaddrcity();

function getaddr(){
  var addrtext=document.getElementById("addrinput").value.toString();
  let addrcity=document.getElementById("cityinput");
  let cityname=addrcity.options[addrcity.selectedIndex].text;
  // let cityname=
  tmpaddrLoc.getSource().clear();
  // 初步轉換(防呆)
  // addrtext = 
  // console.log(addrtext);
  $.get("https://gis.fdkc.gov.tw/rescue/getaddrpoint/json?c="+cityname+"&r1="+addrtext, function(a){
    document.getElementById("addrlonlat").innerHTML='';
    $('#addrlist').empty();
    if(a.io>0){
      // 查地址
      if(a.addr.length==1){
        var lonlat=[a.lon[0],a.lat[0]];
        let lon=Math.round(lonlat[0] * 10000) / 10000;
        let lat=Math.round(lonlat[1] * 10000) / 10000; 
        document.getElementById("addrlonlat").innerHTML=lon.toString()+', '+lat.toString();
        map.getView().animate({center:ol.proj.transform(lonlat,"EPSG:4326","EPSG:3857"),zoom:18});
        selectedLoc.getSource().clear();
        selectedLoc.getSource().addFeature(new ol.Feature({geometry: new ol.geom.Point(ol.proj.fromLonLat(lonlat)),name: '案件中心'}));
        let xy1=ol.proj.transform(lonlat,"EPSG:4326","EPSG:3826");
        let z1=parseInt(map.getView().getZoom()).toString();
        let xyz_str=`${xy1[0]},${xy1[1]},${z1}`;
        if(a.io==4){
          xyz_str=xyz_str+',m,'+a.addr[0];//io=4時回傳地標定位   
        }else{
          xyz_str=xyz_str+',a,'+a.addr[0];
          document.querySelector('#cityinput').value=a.addr[0].substring(0,3);//更新下拉選單縣市
        }   
        // 回傳值範例
        // 地址：xyz_str=X,Y,Z,a,地址
        // 地標：xyz_str=X,Y,Z,m,地標編號(seqno)
        // 查無地址：xyz_str=X,Y,Z,x,50公尺內查無門牌／地標
        if (typeof jsObj == "undefined") {        
          //如果jsObj不存在
          console.log(xyz_str);
          return xyz_str;
        }else{
          //呼叫cs裡的returnXYZ，回傳值為xyz_str
          jsObj.returnXYZ(xyz_str);  
        }
      }else{
        var addrlisthtml='<tbody>';
        for(let i=0;i<a.addr.length;i++){
          addrlisthtml+='<tr><td onclick="updateaddr(\''+a.addr[i].toString()+'\');">'+a.addr[i]+'</td></tr>';
        }
        addrlisthtml+='</tbody>';
        $('#addrlist').append(addrlisthtml);
      }
    }else{
      // 用座標查
      if(addrtext.indexOf(',')>0){
        let lon=parseFloat(addrtext.split(',')[0]);
        let lat=parseFloat(addrtext.split(',')[1]);
        var lonlat=[lon,lat];
        document.getElementById("addrlonlat").innerHTML=lon.toString()+', '+lat.toString();
        map.getView().animate({center:ol.proj.transform(lonlat,"EPSG:4326","EPSG:3857"),zoom:18});
        selectedLoc.getSource().clear();
        selectedLoc.getSource().addFeature(new ol.Feature({geometry: new ol.geom.Point(ol.proj.fromLonLat(lonlat)),name: '案件中心'}));
        $.get('https://gis.fdkc.gov.tw/rescue/getaddr/json?x='+addrtext.split(',')[0]+'&y='+addrtext.split(',')[1],function(a){
          if(a.io == '1' || a.io=='2'){
            let lon=Math.round(a.lon * 1000) / 1000;
            let lat=Math.round(a.lat * 1000) / 1000; 
            document.getElementById("addrlonlat").innerHTML=a.addr+'</br>('+lon+','+lat+')';
            tmpaddrLoc.getSource().clear();
            tmpaddrLoc.getSource().addFeature(new ol.Feature({geometry: new ol.geom.Point(ol.proj.fromLonLat([a.lon,a.lat])),name: '地址座標'}));
          }else{
            document.getElementById("addrlonlat").innerHTML='查無地址!';
            tmpaddrLoc.getSource().clear();
          }
        }); 
      }else{
        document.getElementById("addrlonlat").innerHTML='查無地址!';
        selectedLoc.getSource().clear();
      }      
    }
  });
}


/////////------------------門牌地址查詢  END----------------------------------/////////////////

/////////------------------派遣台function  START----------------------------------/////////////////
//from mj
async function mjfunction() {
  if(typeof CefSharp !== "undefined" ){
    await CefSharp.BindObjectAsync('jsObj');
  }
}
mjfunction();

//回傳定位點座標
var returnmouseP;

// 設定地圖中心點
function setMapXY(X,Y) {
  let xy0 = [X,Y];
  map.getView().animate({center:ol.proj.transform(xy0,"EPSG:3826","EPSG:3857")});
  // map.getView().animate({center:ol.proj.transform(xy0,"EPSG:3825","EPSG:3857")});//離島
  // map.getView().animate({center:ol.proj.fromLonLat(xy0),zoom:Math.max(map.getView().getZoom()+1,19)});
  // zoomlevelreturn();
};

// 回傳目前Zoom level (20230316調整：回傳zoom整數值，且與圖臺zoom單位相同)
function zoomlevelreturn() {
  let mapzoomnow=parseInt(map.getView().getZoom()).toString();
  // let a=parseInt(map.getView().getZoom());
  if (typeof jsObj == "undefined") {        
    //如果jsObj不存在
    return mapzoomnow;
  }else{
    //呼叫cs裡的zoomlevelreturn，回傳值為mapzoomnow
    jsObj.zoomlevelreturn(mapzoomnow);  
  }
}

// 設置地圖比例尺 (20230316調整：與圖臺zoom單位相同)
function zoomlevel(z){
  let zoomto=z;
  map.getView().animate({zoom:zoomto});
}

// 地圖種點
function AddIndFO1(X1, Y1, X2, Y2, type, cs_kind='02'){
  // 中心座標(X1, Y1)
  // 輔助座標(X2, Y2)
  // 輔助icon樣式(type=1電話, type=2手機)
  // 案類(01:火災，02:救護，03:其他，....)
  //selectedLoc 案件中心點
  //supcase Layer 輔助座標
  let xy1=ol.proj.transform([X1,Y1],"EPSG:3826","EPSG:4326");
  let xy2=ol.proj.transform([X2,Y2],"EPSG:3826","EPSG:4326");
  //  let xy1=ol.proj.transform([X1,Y1],"EPSG:3825","EPSG:4326"); //離島
  //  let xy2=ol.proj.transform([X2,Y2],"EPSG:3825","EPSG:4326"); //離島
  selectedLoc.getSource().clear();
  supcaselayer.getSource().clear();
  // zoom to (X1,Y1)
  // map.getView().animate({center:ol.proj.fromLonLat(xy1),zoom:Math.max(map.getView().getZoom()+1,17)});
  map.getView().animate({center:ol.proj.fromLonLat(xy1)});
  let coordinates1 = ol.proj.fromLonLat(xy1);
  let coordinates2 = ol.proj.fromLonLat(xy2);
  selectedLoc.getSource().addFeature(new ol.Feature({geometry: new ol.geom.Point(ol.proj.fromLonLat(xy1)),name: '案件中心'}));
  supcaselayer.getSource().addFeature(new ol.Feature({geometry: new ol.geom.Point(coordinates2),name: '輔助座標'}));
  if(type==1){
    supcaselayer.setStyle(phone1StyleFunction);
  }
  else{
    supcaselayer.setStyle(phone2StyleFunction);
  }
}

/////////------------------派遣台function  END----------------------------------/////////////////

/////////------------------自訂圖資修改  START----------------------------------/////////////////
let originSliderHeight = '900px';
function sliderEdit(status){
  switch (status){
    case 'list':$('.gis-edit-item-list').css({'margin-left': '0px'});modifySelectObj.getFeatures().clear();createEditDraw.setActive(false);tmpEditDrawLayer.getSource().clear();selectEditLayer();break;
    case 'edit':$('.gis-edit-item-list').css({'margin-left': '-350px'});break;
  }
}

let editMode = true;
function switchEditLayer(){
  if(editMode){selectEditLayer();editMode = false;olModifyControl.setActive(true)}
  else{editMode = true;olModifyControl.setActive(false)}
}

//////// 修改START
let modifyTmpLayer;let modifySelectObj; let modifyObj;
const olModifyControl = {
  init: function () {
    modifySelectObj = new ol.interaction.Select({
      filter: function(feature,layer){if(layer === modifyTmpLayer){return true}},
      style: [new ol.style.Style({image: new ol.style.Icon({anchor: [0.5, 1],src: 'https://gis.fdkc.gov.tw/static/img/mapicon/Gis_locator_edit.png',scale: 0.4,}),}),new ol.style.Style({stroke: new ol.style.Stroke({ width: 8, color: '#000'}) }),new ol.style.Style({stroke: new ol.style.Stroke({ width: 5, color: '#f90'}), fill: new ol.style.Fill({color: 'rgba(255,150,0,0.3)',})})]
    });
    map.addInteraction(modifySelectObj);

    modifyObj = new ol.interaction.Modify({features: modifySelectObj.getFeatures(),hitDetection: modifyTmpLayer,condition:function(){if(modifySelectObj.getFeatures()){return true}}});
    map.addInteraction(modifyObj);

    modifySelectObj.on('select', function(e){/*console.log(e)*/})
  },
  setActive: function (active) {
    modifySelectObj.setActive(active);
    modifyObj.setActive(active);
  },
  setEditSource: function(editLayerName='Gis_locater'){
    modifyTmpLayer = '';
    modifyObj.hitDetection_ = '';
    modifySelectObj.getFeatures().clear();
    map.getLayers().getArray().forEach(function (layer){
      if(layer.get('name') == editLayerName){modifyTmpLayer = layer;modifyObj.hitDetection_ = layer;}
    })
  },
};
olModifyControl.init();
olModifyControl.setActive(false)

// ID取得資料
function selectedFeature(id){
  $.getJSON(`https://gis.fdkc.gov.tw/rescue/layereditctl/json?layer=${$('#editLayer').val()}&id=${id}`,function(res){
    $('#edit-id').text(id);
    $('.gis-edit-item-detail .remove').css({'display': ''})
    $('.gis-edit-item-detail .edit').css({'display': ''})
    $('.gis-edit-item-detail .create').css({'display': 'none'})
    $('.gis-edit-item-detail .edittitle').text('修改');
    $('.gis-edit-item-detail .createtype').css({'display': 'none'})
    switch($('#editLayer').val()){
      case 'Gis_locater':
        $('.gis_locater').css({'display': ''})
        $('.gis_narrowlane').css({'display': 'none'})
        $('.gis_lackwater').css({'display': 'none'})
        $('.gis-edit-item-detail .gis_locater input.name').val(res.name0);
        $('.gis-edit-item-detail .gis_locater textarea.address').val(res.address);
        $('.gis-edit-item-detail .gis_locater input.lon').val(res.longtitude);
        $('.gis-edit-item-detail .gis_locater input.lat').val(res.latitude);
        $('.gis-edit-item-detail .gis_locater input.memo').val(res.memo);
      break;
      case 'Gis_narrowlane':
        $('.gis_locater').css({'display': 'none'})
        $('.gis_narrowlane').css({'display': ''})
        $('.gis_lackwater').css({'display': 'none'})
        $('.gis-edit-item-detail .gis_narrowlane textarea.address').val(res.address);
        $('.gis-edit-item-detail .gis_locater input.memo').val(res.memo);
        if($('.gis-edit-item-detail .gis_narrowlane select')){$('.gis-edit-item-detail .gis_narrowlane select').val('紅')}
        else{$('.gis-edit-item-detail .gis_narrowlane select').val(res.ncolor)}
      break;
      case 'Gis_lackwater':
        $('.gis_locater').css({'display': 'none'})
        $('.gis_narrowlane').css({'display': 'none'})
        $('.gis_lackwater').css({'display': ''})
        $('.gis-edit-item-detail .gis_lackwater input.name').val(res.name0);
        $('.gis-edit-item-detail .gis_lackwater textarea.address').val(res.address);
        $('.gis-edit-item-detail .gis_lackwater input.memo').val(res.memo);
      break;
    }
  })
}

modifyObj.on('modifyend', function (e) {// 編輯開始、結束
  if($('#editLayer').val()=='Gis_locater' && modifySelectObj.getFeatures().array_[0]){
    let lonlat = ol.proj.toLonLat(modifySelectObj.getFeatures().array_[0].getGeometry().getCoordinates());
    $('.gis_locater .lon').val(lonlat[0])
    $('.gis_locater .lat').val(lonlat[1])
  }
});
//////// 修改END

//////// 監聽START
function setOverlayListener(){// 左側切換圖資監聽 (init)
  let overlayInput= document.querySelectorAll('#overlaycontent input')
  overlayInput.forEach((e)=>{e.addEventListener('change', function(e){if (editMode){selectEditLayer();}})})
}
function selectEditLayer(){// 下拉選單監聽
  // $('.gis-edit-item-list tbody').empty();
  if($('.mds-icon.mds-edit-layer').prev().prop('checked')){
    olModifyControl.setActive(true)
    let editLayerName = document.getElementById('editLayer').value
    olModifyControl.setEditSource(editLayerName);
  }
}
function clearList(){
  switch($('#editLayer').val()){
    case 'Gis_locater':$('.gis-edit-item-list table thead th').text('重要地標名稱');break;
    case 'Gis_narrowlane':$('.gis-edit-item-list table thead th').text('地址');break;
    case 'Gis_lackwater':$('.gis-edit-item-list table thead th').text('水源缺乏地名稱');break;
  }
  $('.gis-edit-item-list tbody').empty();
  $('.gis-edit-item-list .footer').css({'display': 'none'});
  $('.gis-edit-item-list .footer input').val(1);
}
//////// 監聽END

//////// 自訂新增繪圖START → 新增
let tmpEditDrawLayer=new ol.layer.Vector({source:new ol.source.Vector(),zIndex:20,renderMode:'vector',style:[new ol.style.Style({image: new ol.style.Icon({anchor: [0.5, 1],src: 'https://gis.fdkc.gov.tw/static/img/mapicon/Gis_locator_edit.png',scale: 0.4,}),}),new ol.style.Style({stroke: new ol.style.Stroke({ width: 8, color: '#000'}) }),new ol.style.Style({stroke: new ol.style.Stroke({ width: 5, color: '#f90'}), fill: new ol.style.Fill({color: 'rgba(255,150,0,0.3)',})})]});
let createEditDraw={
  init: function () {
    map.addInteraction(this.Point);this.Point.setActive(false);
    map.addInteraction(this.Polygon);this.Polygon.setActive(false);
    map.addInteraction(this.Circle);this.Circle.setActive(false);
    map.addInteraction(this.Rectangle);this.Rectangle.setActive(false);
    this.Point.on('drawstart',function(){tmpEditDrawLayer.getSource().clear();})
    this.Point.on('drawend',function(e){let lonlat = ol.proj.toLonLat(e.feature.getGeometry().getCoordinates());$('.gis_locater .lon').val(lonlat[0]);$('.gis_locater .lat').val(lonlat[1]);})
    this.Polygon.on('drawstart',function(){tmpEditDrawLayer.getSource().clear();})
    this.Circle.on('drawstart',function(){tmpEditDrawLayer.getSource().clear();})
    this.Rectangle.on('drawstart',function(){tmpEditDrawLayer.getSource().clear();})
  },
  Point: new ol.interaction.Draw({source: tmpEditDrawLayer.getSource(),type: 'Point',}),
  Polygon: new ol.interaction.Draw({source: tmpEditDrawLayer.getSource(),type: 'Polygon',}),
  Circle: new ol.interaction.Draw({source: tmpEditDrawLayer.getSource(),type: 'Circle',}),
  Rectangle: new ol.interaction.Draw({ source: tmpEditDrawLayer.getSource(), type: 'Circle', geometryFunction: ol.interaction.Draw.createBox()}),
  activeDraw: null,
  setActive: function(active, drawType){
    if (this.activeDraw) {
      this.activeDraw.setActive(false);
      this.activeDraw = null;
    }
    if (active) {
      const type = drawType;
      this.activeDraw = this[type];
      this.activeDraw.setActive(true);
      tmpEditDrawLayer.getSource().clear();
    }
  },
};
createEditDraw.init();
map.addLayer(tmpEditDrawLayer);
//////// 自訂新增繪圖END

//////// 新增START
// let createTmpLayer;
function createNewFeature(){
  olModifyControl.setActive(false);//新增時關閉編輯modify
  modifySelectObj.getFeatures().clear();//clear select feature
  sliderEdit('edit');
  $('#edit-id').text('')
  $('.gis-edit-item-detail .remove').css({'display': 'none'})
  $('.gis-edit-item-detail .edit').css({'display': 'none'})
  $('.gis-edit-item-detail .create').css({'display': ''})
  $('.gis-edit-item-detail .createtype').css({'display': ''})
  switch($('#editLayer').val()){
    case 'Gis_locater':
      $('.gis_locater').css({'display': ''})
      $('.gis_narrowlane').css({'display': 'none'})
      $('.gis_lackwater').css({'display': 'none'})
      $('.gis-edit-item-detail .edittitle').text(`新增${$('#editLayer option:selected').text()}`);
      $('.gis-edit-item-detail .gis_locater input.name').val('');
      $('.gis-edit-item-detail .gis_locater textarea.address').val('');
      $('.gis-edit-item-detail .gis_locater input.lon').val('');
      $('.gis-edit-item-detail .gis_locater input.lat').val('');
      $('.gis-edit-item-detail .gis_locater input.memo').val('');
      createEditDraw.setActive(true, 'Point');
    break;
    case 'Gis_lackwater':
      $('.gis_locater').css({'display': 'none'})
      $('.gis_narrowlane').css({'display': 'none'})
      $('.gis_lackwater').css({'display': ''})
      $('.gis-edit-item-detail .edittitle').text(`新增${$('#editLayer option:selected').text()}`);
      $('.gis-edit-item-detail .gis_lackwater input.name').val('');
      $('.gis-edit-item-detail .gis_lackwater textarea.address').val('');
      $('.gis-edit-item-detail .gis_lackwater input.memo').val('');
      createEditDraw.setActive(true, $('.gis-edit-item-detail .gis_lackwater .createtype select').val());
    break;
    case 'Gis_narrowlane':
      $('.gis_locater').css({'display': 'none'})
      $('.gis_narrowlane').css({'display': ''})
      $('.gis_lackwater').css({'display': 'none'})
      $('.gis-edit-item-detail .edittitle').text(`新增${$('#editLayer option:selected').text()}`);
      $('.gis-edit-item-detail .gis_narrowlane textarea.address').val('');
      $('.gis-edit-item-detail .gis_narrowlane input.memo').val('');
      createEditDraw.setActive(true, $('.gis-edit-item-detail .gis_narrowlane .createtype select').val());
    break;
  }
}
function changeCreateType(){
  switch($('#editLayer').val()){
    case 'Gis_locater':createEditDraw.setActive(true, 'Point');break;
    case 'Gis_lackwater':createEditDraw.setActive(true, $('.gis-edit-item-detail .gis_lackwater .createtype select').val());break;
    case 'Gis_narrowlane':createEditDraw.setActive(true, $('.gis-edit-item-detail .gis_narrowlane .createtype select').val());break;
  }
}
//////// 新增END

//////// 搜尋相關列表START
function searchEditList(arg){
  let url = `https://gis.fdkc.gov.tw/rescue/layereditctl/json?layer=${$('#editLayer').val()}`;
  if($('#search-edit-list').val()!=''){url += `&keyword=${$('#search-edit-list').val()}`}
  if(arg!=undefined && 'page' in arg){url += `&page=${$('.gis-edit-item-list .footer input').val()}`}
  else{url += `&page=1`}
  $.getJSON(url, function(res){
    $('.gis-edit-item-list tbody').empty()
    if($('#editLayer').val() == 'Gis_locater'){
      res.data.forEach((e)=>{$('.gis-edit-item-list tbody').append(`<tr onclick="moveMapCenter([${e.longtitude},${e.latitude}])"><td>${e.name0}</td></tr>`)})
    }
    else if($('#editLayer').val() == 'Gis_narrowlane'){
      res.data.forEach((e)=>{$('.gis-edit-item-list tbody').append(`<tr onclick="movePolyCenter([${e.bbox[0]},${e.bbox[1]},${e.bbox[2]},${e.bbox[3]}])"><td>${e.address}</td></tr>`)})
    }
    else{
      res.data.forEach((e)=>{$('.gis-edit-item-list tbody').append(`<tr onclick="movePolyCenter([${e.bbox[0]},${e.bbox[1]},${e.bbox[2]},${e.bbox[3]}])"><td>${e.name0}</td></tr>`)})
    }
    $('.gis-edit-item-list .footer').css({'display': ''})
    // 搜尋後開啟對應圖層，如果已經開啟了，則跳過
    let overlaySeq=editOpenLayer[$('#editLayer').val()]
    if(!document.querySelectorAll('#overlaycontent label input')[overlaySeq[5]].checked){
      document.querySelectorAll('#overlaycontent label input')[overlaySeq[5]].checked=true;
      legendBtn(overlaySeq[0],overlaySeq[1],overlaySeq[2],overlaySeq[3],overlaySeq[4],overlaySeq[5]);
      overLayerCtl(overlaySeq[0],overlaySeq[5]);
    }
  })
}
// 切換上下頁
function changeEditListPage(arg){
  if('prepage' in arg){$('.gis-edit-item-list .footer input').val(parseInt($('.gis-edit-item-list .footer input').val())-1);searchEditList({'page': $('.gis-edit-item-list .footer input').val()})}
  else if ('nextpage' in arg){$('.gis-edit-item-list .footer input').val(parseInt($('.gis-edit-item-list .footer input').val())+1);searchEditList({'page': $('.gis-edit-item-list .footer input').val()})}
}
// 移動中心 point
function moveMapCenter(lonlat){
  map.getView().animate({center:ol.proj.transform(lonlat,"EPSG:4326","EPSG:3857"),zoom:map.getView().getZoom()});
  getCheckOverlayer();
}
// 移動中心 polygon
function movePolyCenter(bbox){
  let center = ol.extent.getCenter(bbox)
  map.getView().animate({center:ol.proj.transform(center,"EPSG:4326","EPSG:3857"),zoom:map.getView().getZoom()});
  getCheckOverlayer();
}
// update 資料
function editDataUpdate(){
  let data={};let tmpPoly=[];
  if($('#editLayer').val()=='Gis_locater'){
    data={
      "name0": $('.gis_locater .name').val(),
      "address": $('.gis_locater .address').val(),
      "memo": $('.gis_locater .memo').val(),
      "lon": $('.gis_locater .lon').val(),
      "lat": $('.gis_locater .lat').val()
    }
  }else if($('#editLayer').val()=='Gis_narrowlane'){
    data={
      "ncolor": $('.gis_narrowlane select').val(),
      "address": $('.gis_narrowlane .address').val(),
      "memo": $('.gis_narrowlane .memo').val(),
      "poly0": modifySelectObj.getFeatures().array_[0].getGeometry().transform('EPSG:3857', 'EPSG:4326').getCoordinates()[0][0]
    }
  }else{
    data={
      "name0": $('.gis_lackwater .name').val(),
      "address": $('.gis_lackwater .address').val(),
      "memo": $('.gis_lackwater .memo').val(),
      "poly0": modifySelectObj.getFeatures().array_[0].getGeometry().transform('EPSG:3857', 'EPSG:4326').getCoordinates()[0][0]
    }
  }
  let settings = {
    "url": `https://gis.fdkc.gov.tw/rescue/layereditctl/json?layer=${$('#editLayer').val()}&id=${$('#edit-id').text()}`,
    "method": "PUT",
    "timeout": 0,
    "data": JSON.stringify(data),
  };
  $.ajax(settings).done(function (response) {
    // console.log(response);
    modifySelectObj.getFeatures().clear();
    getCheckOverlayer();
    sliderEdit('list');
    searchEditList();
  });
}

function editDataPost(){
  let data={};
  if (tmpEditDrawLayer.getSource().getFeatures()[0]==undefined){alert('請選擇繪圖樣式，並繪製圖形');return;}
  if($('#editLayer').val()=='Gis_locater'){
    if ($('.gis_locater .name').val()==''){alert('地標名稱不能為空'); return;}
    if ($('.gis_locater .address').val()==''){alert('地址不能為空'); return;}
    data={
      "name0": $('.gis_locater .name').val(),
      "address": $('.gis_locater .address').val(),
      "memo": $('.gis_locater .memo').val(),
      "lon": $('.gis_locater .lon').val(),
      "lat": $('.gis_locater .lat').val()
    }
  }else if($('#editLayer').val()=='Gis_narrowlane'){
    if ($('.gis_narrowlane .address').val()==''){alert('地址不能為空'); return;}
    data={
      "ncolor": $('.gis_narrowlane select').val(),
      "address": $('.gis_narrowlane .address').val(),
      "memo": $('.gis_narrowlane .memo').val(),
      "poly0": getTypeCoord($('.gis-edit-item-detail .gis_narrowlane .createtype select').val())
    }
  }else{
    if ($('.gis_lackwater .name').val()==''){alert('名稱不能為空'); return;}
    if ($('.gis_lackwater .address').val()==''){alert('地址不能為空'); return;}
    data={
      "name": $('.gis_lackwater .name').val(),
      "address": $('.gis_lackwater .address').val(),
      "memo": $('.gis_lackwater .memo').val(),
      "poly0": getTypeCoord($('.gis-edit-item-detail .gis_lackwater .createtype select').val())
    }
  }
  let settings = {
    "url": `https://gis.fdkc.gov.tw/rescue/layereditctl/json?layer=${$('#editLayer').val()}`,
    "method": "POST",
    "timeout": 0,
    "data": JSON.stringify(data),
  };
  $.ajax(settings).done(function (response) {
    modifySelectObj.getFeatures().clear();
    getCheckOverlayer();
    sliderEdit('list');
    searchEditList();
  });
}
function getTypeCoord(drawType){
  if (drawType == 'Circle') {
    return  ol.geom.Polygon.fromCircle(tmpEditDrawLayer.getSource().getFeatures()[0].getGeometry()).transform('EPSG:3857', 'EPSG:4326').getCoordinates()[0]
  } else if (drawType == 'Rectangle') {
    return tmpEditDrawLayer.getSource().getFeatures()[0].getGeometry().transform('EPSG:3857', 'EPSG:4326').getCoordinates()[0]
  } else if (drawType == 'Polygon') {
    return tmpEditDrawLayer.getSource().getFeatures()[0].getGeometry().transform('EPSG:3857', 'EPSG:4326').getCoordinates()[0]
  }
}

//////// 搜尋相關列表END

//////// 自訂圖資刪除相關START
function deleteCheckPanel(checkif){
  if(checkif){deleteEditFeature()}
  else{$('.deleteCheck').css({'display':'none'})}
}
function deleteEditFeature(){
  let settings = {
    "url": `https://gis.fdkc.gov.tw/rescue/layereditctl/json?layer=${$('#editLayer').val()}&id=${$('#edit-id').text()}`,
    "method": "DELETE",
    "timeout": 0,
  };
  $.ajax(settings).done(function (response) {
    modifySelectObj.getFeatures().clear();
    getCheckOverlayer();
    sliderEdit('list');
    $('.deleteCheck').css({'display':'none'});
    searchEditList();
  });
}
//////// 自訂圖資刪除相關END

/////////------------------自訂圖資修改  END----------------------------------/////////////////

/////////------------------初始化  START----------------------------------/////////////////

//收起左側欄 START
// setTimeout(() => {sideBarCollapseSwitch(true, document.querySelector('#sideBarChk'));}, 200);
// document.getElementById('sideBarChk').checked=true;
//收起左側欄 END

//隱藏右下ICON START
let redirectLabel = $('.rightToolsBox .redirect label');
for(let i=0; i<redirectLabel.length; i++){$(redirectLabel).css({'display':'none'})}
//隱藏右下ICON END

// 預設開啟門牌定位 START
rightSidebarBtn(document.querySelector('.mds-icon.mds-search-addr').previousElementSibling, 'mds-search-addr');
// 預設開啟門牌定位 END

/////////------------------初始化  END----------------------------------/////////////////
</script>
</body>
</html>
